<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudiThor - Security Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.2); width: 24px; height: 24px; border-radius: 50%; border-left-color: #ffffff; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #log-panel { transition: all 0.3s ease-in-out; }
        #log-panel.minimized { transform: translateY(calc(100% - 48px)); }
        .log-entry { font-family: 'Courier New', Courier, monospace; }
        .log-info { color: #3b82f6; }
        .log-success { color: #16a34a; }
        .log-error { color: #dc2626; }
    </style>
</head>
<body class="text-[#204071]">

    <div id="main-app-view" class="h-screen">
        <div class="flex h-full">
            <aside class="w-64 bg-[#204071] text-white flex flex-col fixed h-full">
                <div class="flex items-center justify-center p-4 border-b border-[#1a335a] space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="h-10 w-10 text-[#eb3496]" viewBox="0 0 16 16">
                        <path d="M5.52.359A.5.5 0 0 1 6 0h4a.5.5 0 0 1 .474.658L8.694 6H12.5a.5.5 0 0 1 .395.807l-7 9a.5.5 0 0 1-.873-.454L6.823 9.5H3.5a.5.5 0 0 1-.48-.641zM6.374 1 4.168 8.5H7.5a.5.5 0 0 1 .478.647L6.78 13.04 11.478 7H8a.5.5 0 0 1-.474-.658L9.306 1z"/>
                    </svg>
                    <h1 class="text-2xl font-bold text-white">AudiThor</h1>
                </div>
                <nav id="sidebar-nav" class="flex-1 mt-4 px-2 space-y-4 overflow-y-auto">
                    <div>
                        <a href="#" data-view="iam" class="main-nav-link flex items-center px-4 py-2.5 rounded-md bg-[#eb3496]">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5 mr-3" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/></svg>
                            <span>Identity & Access</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" data-view="exposure" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5 mr-3" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10.354 6.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7 8.793l2.646-2.647a.5.5 0 0 1 .708 0"/><path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383m.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/></svg>
                             <span>Internet Exposure</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" data-view="guardduty" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5 mr-3" viewBox="0 0 16 16">
                                <path d="M5.338 1.59a61 61 0 0 0-2.837.856.48.48 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.7 10.7 0 0 0 2.287 2.233c.346.244.652.42.893.533q.18.085.293.118a1 1 0 0 0 .101.025 1 1 0 0 0 .1-.025q.114-.034.294-.118c.24-.113.547-.29.893-.533a10.7 10.7 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.8 11.8 0 0 1-2.517 2.453 7 7 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7 7 0 0 1-1.048-.625 11.8 11.8 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 63 63 0 0 1 5.072.56"/>
                                <path d="M8 4.5a.5.5 0 0 1 .5.5v1.5H10a.5.5 0 0 1 0 1H8.5V9a.5.5 0 0 1-1 0V7.5H6a.5.5 0 0 1 0-1h1.5V5a.5.5 0 0 1 .5-.5"/>
                            </svg>
                            <span>GuardDuty</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" data-view="waf" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5 mr-3" viewBox="0 0 16 16">
                                <path d="M0 .5A.5.5 0 0 1 .5 0h15a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5H14v2h1.5a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5H14v2h1.5a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5H2v-2H.5a.5.5 0 0 1-.5-.5v-3A.5.5 0 0 1 .5 6H2V4H.5a.5.5 0 0 1-.5-.5zM3 4v2h4.5V4zm5.5 0v2H13V4zM3 10v2h4.5v-2zm5.5 0v2H13v-2zM1 1v2h3.5V1zm4.5 0v2h5V1zm6 0v2H15V1zM1 7v2h3.5V7zm4.5 0v2h5V7zm6 0v2H15V7zM1 13v2h3.5v-2zm4.5 0v2h5v-2zm6 0v2H15v-2z"/>
                            </svg>
                            <span>WAF</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" data-view="cloudtrail" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-bar-graph w-5 h-5 mr-3" viewBox="0 0 16 16">  <path d="M4.5 12a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5zm3 0a.5.5 0 0 1-.5-.5v-4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5zm3 0a.5.5 0 0 1-.5-.5v-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-.5.5z"/>  <path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1"/></svg>
                            <span>CloudTrail</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" data-view="cloudwatch" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-5 h-5 mr-3" viewBox="0 0 16 16">
                                <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2M8 1.918l-.797.161A4 4 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4 4 0 0 0-3.203-3.92zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5 5 0 0 1 13 6c0 .88.32 4.2 1.22 6"/>
                            </svg>
                            <span>Cloudwatch & SNS</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" data-view="inspector" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-5 h-5 mr-3" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="m4.736 1.968-.892 3.269-.014.058C2.113 5.568 1 6.006 1 6.5 1 7.328 4.134 8 8 8s7-.672 7-1.5c0-.494-1.113-.932-2.83-1.205l-.014-.058-.892-3.27c-.146-.533-.698-.849-1.239-.734C9.411 1.363 8.62 1.5 8 1.5s-1.411-.136-2.025-.267c-.541-.115-1.093.2-1.239.735m.015 3.867a.25.25 0 0 1 .274-.224c.9.092 1.91.143 2.975.143a30 30 0 0 0 2.975-.143.25.25 0 0 1 .05.498c-.918.093-1.944.145-3.025.145s-2.107-.052-3.025-.145a.25.25 0 0 1-.224-.274M3.5 10h2a.5.5 0 0 1 .5.5v1a1.5 1.5 0 0 1-3 0v-1a.5.5 0 0 1 .5-.5m-1.5.5q.001-.264.085-.5H2a.5.5 0 0 1 0-1h3.5a1.5 1.5 0 0 1 1.488 1.312 3.5 3.5 0 0 1 2.024 0A1.5 1.5 0 0 1 10.5 9H14a.5.5 0 0 1 0 1h-.085q.084.236.085.5v1a2.5 2.5 0 0 1-5 0v-.14l-.21-.07a2.5 2.5 0 0 0-1.58 0l-.21.07v.14a2.5 2.5 0 0 1-5 0zm8.5-.5h2a.5.5 0 0 1 .5.5v1a1.5 1.5 0 0 1-3 0v-1a.5.5 0 0 1 .5-.5"/>
                            </svg>
                            <span>Inspector</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" data-view="kms" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lock w-5 h-5 mr-3" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 0a4 4 0 0 1 4 4v2.05a2.5 2.5 0 0 1 2 2.45v5a2.5 2.5 0 0 1-2.5 2.5h-7A2.5 2.5 0 0 1 2 13.5v-5a2.5 2.5 0 0 1 2-2.45V4a4 4 0 0 1 4-4M4.5 7A1.5 1.5 0 0 0 3 8.5v5A1.5 1.5 0 0 0 4.5 15h7a1.5 1.5 0 0 0 1.5-1.5v-5A1.5 1.5 0 0 0 11.5 7zM8 1a3 3 0 0 0-3 3v2h6V4a3 3 0 0 0-3-3"/>
                            </svg>
                            <span>KMS</span>
                        </a>
                    </div>
                     <div>
                        <a href="#" data-view="acm" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-card-heading w-5 h-5 mr-3" viewBox="0 0 16 16">  <path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2z"/>  <path d="M3 8.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m0-5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5z"/></svg>
                            <span>ACM</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" data-view="compute" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cpu w-5 h-5 mr-3" viewBox="0 0 16 16">
                                <path d="M5 0a.5.5 0 0 1 .5.5V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2A2.5 2.5 0 0 1 14 4.5h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14a2.5 2.5 0 0 1-2.5 2.5v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14A2.5 2.5 0 0 1 2 11.5H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2A2.5 2.5 0 0 1 4.5 2V.5A.5.5 0 0 1 5 0m-.5 3A1.5 1.5 0 0 0 3 4.5v7A1.5 1.5 0 0 0 4.5 13h7a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 11.5 3zM5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5zM6.5 6a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5z"/>
                            </svg>
                            <span>Compute</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" data-view="databases" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-database w-5 h-5 mr-3" viewBox="0 0 16 16">
                                <path d="M4.318 2.687C5.234 2.271 6.536 2 8 2s2.766.27 3.682.687C12.644 3.125 13 3.627 13 4c0 .374-.356.875-1.318 1.313C10.766 5.729 9.464 6 8 6s-2.766-.27-3.682-.687C3.356 4.875 3 4.373 3 4c0-.374.356-.875 1.318-1.313M13 5.698V7c0 .374-.356.875-1.318 1.313C10.766 8.729 9.464 9 8 9s-2.766-.27-3.682-.687C3.356 7.875 3 7.373 3 7V5.698c.271.202.58.378.904.525C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777A5 5 0 0 0 13 5.698M14 4c0-1.007-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1s-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4v9c0 1.007.875 1.755 1.904 2.223C4.978 15.71 6.427 16 8 16s3.022-.289 4.096-.777C13.125 14.755 14 14.007 14 13zm-1 4.698V10c0 .374-.356.875-1.318 1.313C10.766 11.729 9.464 12 8 12s-2.766-.27-3.682-.687C3.356 10.875 3 10.373 3 10V8.698c.271.202.58.378.904.525C4.978 9.71 6.427 10 8 10s3.022-.289 4.096-.777A5 5 0 0 0 13 8.698m0 3V13c0 .374-.356.875-1.318 1.313C10.766 14.729 9.464 15 8 15s-2.766-.27-3.682-.687C3.356 13.875 3 13.373 3 13v-1.302c.271.202.58.378.904.525C4.978 12.71 6.427 13 8 13s3.022-.289 4.096-.777c.324-.147.633-.323.904-.525"/>
                            </svg>
                            <span>Databases</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" data-view="network-policies" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stoplights w-5 h-5 mr-3" viewBox="0 0 16 16">
                                <path d="M8 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3m0 4a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3m1.5 2.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                                <path d="M4 2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2h2c-.167.5-.8 1.6-2 2v2h2c-.167.5-.8 1.6-2 2v2h2c-.167.5-.8 1.6-2 2v1a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-1c-1.2-.4-1.833-1.5-2-2h2V8c-1.2-.4-1.833-1.5-2-2h2V4c-1.2-.4-1.833-1.5-2-2zm2-1a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/>
                            </svg>
                            <span>Network Policies</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" data-view="connectivity" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-ethernet w-5 h-5 mr-3" viewBox="0 0 16 16">
                                <path d="M14 13.5v-7a.5.5 0 0 0-.5-.5H12V4.5a.5.5 0 0 0-.5-.5h-1v-.5A.5.5 0 0 0 10 3H6a.5.5 0 0 0-.5.5V4h-1a.5.5 0 0 0-.5.5V6H2.5a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5M3.75 11h.5a.25.25 0 0 1 .25.25v1.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-1.5a.25.25 0 0 1 .25-.25m2 0h.5a.25.25 0 0 1 .25.25v1.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-1.5a.25.25 0 0 1 .25-.25m1.75.25a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v1.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25zM9.75 11h.5a.25.25 0 0 1 .25.25v1.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-1.5a.25.25 0 0 1 .25-.25m1.75.25a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v1.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25z"/>
                                <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM1 2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1z"/>
                            </svg>
                            <span>Conectividad de Red</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" data-view="config-sh" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shield-slash w-5 h-5 mr-3" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M1.093 3.093c-.465 4.275.885 7.46 2.513 9.589a11.8 11.8 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7 7 0 0 0 1.048-.625 11.3 11.3 0 0 0 1.733-1.525l-.745-.745a10.3 10.3 0 0 1-1.578 1.392c-.346.244-.652.42-.893.533q-.18.085-.293.118a1 1 0 0 1-.101.025 1 1 0 0 1-.1-.025 2 2 0 0 1-.294-.118 6 6 0 0 1-.893-.533 10.7 10.7 0 0 1-2.287-2.233C3.053 10.228 1.879 7.594 2.06 4.06zM3.98 1.98l-.852-.852A59 59 0 0 1 5.072.559C6.157.266 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.483 3.626-.332 6.491-1.551 8.616l-.77-.77c1.042-1.915 1.72-4.469 1.29-7.702a.48.48 0 0 0-.33-.39c-.65-.213-1.75-.56-2.836-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524a50 50 0 0 0-1.357.39zm9.666 12.374-13-13 .708-.708 13 13z"/>
                            </svg>
                            <span>Config & SecurityHub</span>
                        </a>
                    </div>
                     <div>
                        <a href="#" data-view="playground" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-joystick w-5 h-5 mr-3" viewBox="0 0 16 16">
                                <path d="M10 2a2 2 0 0 1-1.5 1.937v5.087c.863.083 1.5.377 1.5.726 0 .414-.895.75-2 .75s-2-.336-2-.75c0-.35.637-.643 1.5-.726V3.937A2 2 0 1 1 10 2"/>
                                <path d="M0 9.665v1.717a1 1 0 0 0 .553.894l6.553 3.277a2 2 0 0 0 1.788 0l6.553-3.277a1 1 0 0 0 .553-.894V9.665c0-.1-.06-.19-.152-.23L9.5 6.715v.993l5.227 2.178a.125.125 0 0 1 .001.23l-5.94 2.546a2 2 0 0 1-1.576 0l-5.94-2.546a.125.125 0 0 1 .001-.23L6.5 7.708l-.013-.988L.152 9.435a.25.25 0 0 0-.152.23"/>
                            </svg>
                            <span>Playground</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" data-view="healthy-status" class="main-nav-link flex items-center px-4 py-2.5 rounded-md hover:bg-[#1a335a]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-5 h-5 mr-3" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 4a.5.5 0 0 1 .5.5v.634l.549-.317a.5.5 0 1 1 .5.866L9 6l.549.317a.5.5 0 1 1-.5.866L8.5 6.866V7.5a.5.5 0 0 1-1 0v-.634l-.549.317a.5.5 0 1 1-.5-.866L7 6l-.549-.317a.5.5 0 0 1 .5-.866l.549.317V4.5A.5.5 0 0 1 8 4M5 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5"/>
                                <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2"/>
                                <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1z"/>
                            </svg>
                            <span>Healthy Status</span>
                        </a>
                    </div>
                </nav>
            </aside>

            <div id="view-container" class="flex-1 ml-64 p-6 lg:p-8 bg-gray-50">
                <div class="bg-white/80 backdrop-blur-sm border border-gray-200 p-4 rounded-xl shadow-md mb-6 sticky top-6 z-10">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-end">
                        <div><label for="access-key-input" class="block text-sm font-medium text-[#204071] mb-1">AWS Access Key ID</label><input type="text" id="access-key-input" class="bg-gray-50 border border-gray-300 text-[#204071] text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block w-full p-2.5" placeholder="AKIA..."></div>
                        <div><label for="secret-key-input" class="block text-sm font-medium text-[#204071] mb-1">AWS Secret Access Key</label><input type="password" id="secret-key-input" class="bg-gray-50 border border-gray-300 text-[#204071] text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block w-full p-2.5" placeholder="••••••••••••••••"></div>
                        <div><label for="session-token-input" class="block text-sm font-medium text-[#204071] mb-1">AWS Session Token (Opcional)</label><input type="password" id="session-token-input" class="bg-gray-50 border border-gray-300 text-[#204071] text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block w-full p-2.5" placeholder="Token de sesión si es necesario"></div>
                        <div class="flex items-center"><div class="flex items-center space-x-2"><button id="run-analysis-button" class="w-full bg-[#eb3496] text-white px-4 py-2.5 rounded-lg font-bold text-md hover:bg-[#d42c86] transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"><span id="button-text">Analizar Cuenta</span><div id="loading-spinner" class="spinner hidden"></div></button><button id="import-results-button" title="Importar resultados desde JSON" class="w-auto bg-gray-600 text-white p-2.5 rounded-lg hover:bg-gray-700 transition"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload w-5 h-5" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg></button><input type="file" id="json-file-input" class="hidden" accept="application/json"><button id="export-results-button" title="Exportar resultados a JSON" class="w-auto bg-[#204071] text-white p-2.5 rounded-lg hover:bg-[#1a335a] transition"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download w-5 h-5" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/></svg></button></div></div>
                    </div>
                    <div id="error-message" class="text-red-600 text-sm mt-2 font-medium hidden"></div>
                </div>
                <main id="healthy-status-view" class="view hidden">
                    <header class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-[#204071]">Healthy Status</h2>
                            <p class="text-sm text-gray-500">Resumen de hallazgos de seguridad encontrados.</p>
                            <div class="mt-4">
                                <label for="healthy-status-region-filter" class="block text-sm font-medium text-gray-700">Filtrar por Región:</label>
                                <select id="healthy-status-region-filter" class="mt-1 block w-full md:w-96 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-[#eb3496] focus:border-[#eb3496] sm:text-sm rounded-md"></select>
                            </div>
                            </div>
                    </header>
                    <div id="healthy-status-container">
                        <div class="text-center py-16 bg-white rounded-lg">
                            <h3 class="mt-2 text-lg font-medium text-[#204071]">Esperando análisis</h3>
                            <p class="mt-1 text-sm text-gray-500">Los hallazgos de estado aparecerán aquí después de analizar una cuenta.</p>
                        </div>
                    </div>
                </main>
                <main id="iam-view" class="view"></main>
                <main id="exposure-view" class="view hidden"></main>
                <main id="guardduty-view" class="view hidden"></main>
                <main id="waf-view" class="view hidden"></main>
                <main id="cloudtrail-view" class="view hidden"></main>
                <main id="cloudwatch-view" class="view hidden"></main>
                <main id="inspector-view" class="view hidden"></main>
                <main id="acm-view" class="view hidden"></main>
                <main id="compute-view" class="view hidden"></main>
                <main id="databases-view" class="view hidden"></main>
                <main id="kms-view" class="view hidden"></main>
                <main id="network-policies-view" class="view hidden"></main>
                <main id="config-sh-view" class="view hidden"></main>
                <main id="connectivity-view" class="view hidden"></main> <main id="playground-view" class="view hidden"></main>
                <main id="playground-view" class="view hidden"></main>
            </div>
        </div>
    </div>

    <div id="log-panel" class="fixed bottom-0 right-0 w-full md:w-1/3 h-64 bg-[#1a2b47] text-white rounded-t-lg shadow-2xl p-4 flex flex-col z-50">
        <div class="flex justify-between items-center mb-2"><h4 class="font-bold text-slate-300">Registro de Eventos</h4><div><button id="clear-log-btn" class="text-xs bg-[#2f5a9e] hover:bg-[#204071] px-2 py-1 rounded">Limpiar</button><button id="toggle-log-btn" class="text-xs bg-[#2f5a9e] hover:bg-[#204071] px-2 py-1 rounded">Minimizar</button></div></div>
        <div id="log-container" class="flex-1 bg-slate-900 p-2 rounded overflow-y-auto text-xs space-y-1"></div>
    </div>

    <script>
        // --- ESTADO GLOBAL ---
        let iamApiData = null, securityHubApiData = null, exposureApiData = null, guarddutyApiData = null, wafApiData = null, cloudtrailApiData = null, cloudwatchApiData = null, inspectorApiData = null, acmApiData = null, computeApiData = null, networkPoliciesApiData = null, playgroundApiData = null, allAvailableRegions = [], lastCloudtrailLookupResults = [], federationApiData = null, configSHApiData = null, configSHStatusApiData = null, databaseApiData = null, documentdbApiData = null, connectivityApiData = null, identityCenterApiData = null, lastHealthyStatusFindings = [];        
        // --- SELECTORES ---
        let views, mainNavLinks, runAnalysisBtn, accessKeyInput, secretKeyInput, sessionTokenInput, loadingSpinner, buttonText, errorMessageDiv, logContainer, clearLogBtn, toggleLogBtn, logPanel;

        // --- LÓGICA DE LOGS ---
        const log = (message, type = 'info') => { if (!logContainer) return; const timestamp = new Date().toLocaleTimeString(); const typeClass = `log-${type}`, typeText = type.toUpperCase(); const entry = document.createElement('p'); entry.className = 'log-entry'; entry.innerHTML = `<span class="font-bold ${typeClass}">[${timestamp} - ${typeText}]</span> ${message}`; logContainer.prepend(entry); };

        // --- LÓGICA DE COPIADO (AÑADIR AQUÍ) ---
        const copyToClipboard = (element, textToCopy) => {
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalContent = element.innerHTML;
                element.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-lg w-4 h-4 text-green-500" viewBox="0 0 16 16">
                        <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/>
                    </svg>
                    <span class="text-green-500 text-xs font-bold">Copiado</span>`;
                setTimeout(() => {
                    element.innerHTML = originalContent;
                }, 1500); // Vuelve al estado original después de 1.5 segundos
            }).catch(err => {
                console.error('Error al copiar el ARN: ', err);
                log('Error al copiar el ARN.', 'error');
            });
        };
        // --- LÓGICA DE NAVEGACIÓN ---
        const handleMainNavClick = (e) => { e.preventDefault(); const link = e.target.closest('.main-nav-link'); if (!link) return; const targetViewId = `${link.dataset.view}-view`; views.forEach(v => v.classList.add('hidden')); document.getElementById(targetViewId).classList.remove('hidden'); mainNavLinks.forEach(l => { l.classList.remove('bg-[#eb3496]'); l.classList.add('hover:bg-[#1a335a]'); }); link.classList.add('bg-[#eb3496]'); link.classList.remove('hover:bg-[#1a335a]'); };
        const handleTabClick = (navElement, contentSelector) => (e) => { e.preventDefault(); const link = e.target.closest('a.tab-link'); if (!link) return; navElement.querySelectorAll('a.tab-link').forEach(l => { l.classList.remove('border-[#eb3496]', 'text-[#eb3496]', 'font-semibold'); l.classList.add('border-transparent', 'text-gray-500'); }); link.classList.add('border-[#eb3496]', 'text-[#eb3496]', 'font-semibold'); link.classList.remove('border-transparent', 'text-gray-500'); document.querySelectorAll(contentSelector).forEach(c => c.classList.add('hidden')); const contentElement = document.getElementById(link.dataset.tab); if (contentElement) contentElement.classList.remove('hidden'); };

        // --- LÓGICA DE ANÁLISIS ---
        const runAnalysisFromInputs = async () => {
            // ... (toda la parte inicial de reseteo y configuración es igual)
            iamApiData = null; securityHubApiData = null; exposureApiData = null; guarddutyApiData = null; wafApiData = null; cloudtrailApiData = null; cloudwatchApiData = null; inspectorApiData = null; acmApiData = null; computeApiData = null; databasesApiData = null; networkPoliciesApiData = null; connectivityApiData = null; playgroundApiData = null; allAvailableRegions = []; lastCloudtrailLookupResults = []; federationApiData = null; configSHApiData = null; configSHStatusApiData = null; kmsApiData = null;
            document.querySelectorAll('.view').forEach(v => v.innerHTML = '');
            document.getElementById('iam-view').innerHTML = createInitialEmptyState();
            const summaryContainer = document.getElementById('executive-summary-container');
            if (summaryContainer) { summaryContainer.innerHTML = '<div class="text-center py-16"><div class="spinner mx-auto"></div><p class="mt-2 text-sm text-gray-500">Ejecutando análisis...</p></div>'; }
            log('Iniciando análisis completo...', 'info');
            const accessKey = accessKeyInput.value.trim(); const secretKey = secretKeyInput.value.trim(); const sessionToken = sessionTokenInput.value.trim();
            if (!accessKey || !secretKey) { const msg = 'Por favor, introduce el Access Key ID y el Secret Access Key.'; errorMessageDiv.textContent = msg; errorMessageDiv.classList.remove('hidden'); log(msg, 'error'); return; }
            const payload = { access_key: accessKey, secret_key: secretKey };
            if (sessionToken) { payload.session_token = sessionToken; log('Se ha detectado un Session Token.', 'info'); }
            runAnalysisBtn.disabled = true; loadingSpinner.classList.remove('hidden'); buttonText.textContent = 'Analizando...'; errorMessageDiv.classList.add('hidden');
            // ... (toda la lógica de las llamadas a la API es igual)
            try {
                log('Llamando a las APIs de AWS...', 'info');
                const apiCalls = {
                    iam: fetch('http://127.0.0.1:5001/api/run-iam-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    securityhub: fetch('http://127.0.0.1:5001/api/run-securityhub-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    exposure: fetch('http://127.0.0.1:5001/api/run-exposure-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    guardduty: fetch('http://127.0.0.1:5001/api/run-guardduty-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    waf: fetch('http://127.0.0.1:5001/api/run-waf-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    cloudtrail: fetch('http://127.0.0.1:5001/api/run-cloudtrail-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    cloudwatch: fetch('http://127.0.0.1:5001/api/run-cloudwatch-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    inspector: fetch('http://127.0.0.1:5001/api/run-inspector-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    acm: fetch('http://127.0.0.1:5001/api/run-acm-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    compute: fetch('http://127.0.0.1:5001/api/run-compute-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    databases: fetch('http://127.0.0.1:5001/api/run-databases-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    network_policies: fetch('http://127.0.0.1:5001/api/run-network-policies-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    federation: fetch('http://127.0.0.1:5001/api/run-federation-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    config_sh_status: fetch('http://127.0.0.1:5001/api/run-config-sh-status-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    kms: fetch('http://127.0.0.1:5001/api/run-kms-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                    connectivity: fetch('http://127.0.0.1:5001/api/run-connectivity-audit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
                };
                const promises = Object.entries(apiCalls).map(async ([key, promise]) => {
                    try { const response = await promise; if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || `HTTP error! status: ${response.status}`); } return [key, await response.json()]; } catch (error) { log(`Error en la API para '${key}': ${error.message}`, 'error'); return [key, null]; }
                });
                const resolvedPromises = await Promise.all(promises);
                const results = Object.fromEntries(resolvedPromises);
                iamApiData = results.iam; securityHubApiData = results.securityhub; exposureApiData = results.exposure; guarddutyApiData = results.guardduty; wafApiData = results.waf; cloudtrailApiData = results.cloudtrail; cloudwatchApiData = results.cloudwatch; inspectorApiData = results.inspector; acmApiData = results.acm; computeApiData = results.compute; databasesApiData = results.databases; networkPoliciesApiData = results.network_policies; federationApiData = results.federation; configSHStatusApiData = results.config_sh_status; kmsApiData = results.kms; connectivityApiData = results.connectivity;
                if (!iamApiData || !networkPoliciesApiData) { throw new Error("Una o más llamadas críticas a la API fallaron. No se puede continuar."); }
                allAvailableRegions = networkPoliciesApiData?.results?.all_regions || [];
                log('Todos los datos han sido recibidos.', 'success');
                buildAndRenderAllViews();

                // --- ▼▼▼ CAMBIO IMPORTANTE AQUÍ ▼▼▼ ---
                // Ahora simplemente llamamos a nuestra nueva función.
                await runAndDisplayHealthyStatus();
                // --- ▲▲▲ FIN DEL CAMBIO ▲▲▲ ---

            } catch (error) {
                const errorMsg = `Error: ${error.message || 'Ocurrió un error desconocido.'}`;
                console.error('Error detallado:', error);
                errorMessageDiv.textContent = errorMsg;
                errorMessageDiv.classList.remove('hidden');
                document.getElementById('iam-view').innerHTML = createInitialEmptyState();
                if (summaryContainer) { summaryContainer.innerHTML = `<div class="text-center py-16 text-red-600">${errorMsg}</div>`; }
                log(`${errorMsg}`, 'error');
            } finally {
                runAnalysisBtn.disabled = false;
                loadingSpinner.classList.add('hidden');
                buttonText.textContent = 'Analizar Cuenta';
            }
        };


        // --- LÓGICA DE RENDERIZADO ---
        const buildAndRenderAllViews = () => {
            try {
                log('Renderizando todas las vistas...', 'info');
                buildHealthyStatusView();
                buildIamView();
                buildExposureView();
                buildGuarddutyView();
                buildWafView();
                buildCloudtrailView();
                buildCloudwatchView();
                buildInspectorView();
                buildAcmView();
                buildComputeView();
                buildDatabasesView();
                buildNetworkPoliciesView();
                buildConfigSHView();
                buildPlaygroundView();
                renderFederationView();
                buildKmsView();
                buildConnectivityView();
                log('Vistas renderizadas.', 'success');
            } catch (e) { log(`Error al renderizar: ${e.message}`, 'error'); console.error(e); }
        };
        
        
        const createInitialEmptyState = () => `<div class="text-center py-16 bg-white rounded-lg"><svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg><h3 class="mt-2 text-lg font-medium text-[#204071]">Bienvenido a AudiThor</h3><p class="mt-1 text-sm text-gray-500">Introduce credenciales y haz clic en "Analizar".</p></div>`;
        const createStatusBadge = (statusText) => { if (!statusText) { return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">N/A</span>`; } const lowerStatus = statusText.toLowerCase(); if (lowerStatus === 'habilitado' || lowerStatus === 'enabled' || lowerStatus === 'running' || lowerStatus === 'active') { return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">${statusText}</span>`; } if (lowerStatus === 'deshabilitado' || lowerStatus === 'suspendido' || lowerStatus.includes('error') || lowerStatus === 'not_available' || lowerStatus === 'stopped' || lowerStatus === 'terminated' || lowerStatus === 'shutting-down' || lowerStatus === 'failed') { return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">${statusText}</span>`; } if (lowerStatus === 'pending' || lowerStatus === 'enabling' || lowerStatus === 'stopping') { return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">${statusText}</span>`; } return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">${statusText}</span>`; };
        const createAlarmStateBadge = (state) => { if (state === 'ALARM') return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">${state}</span>`; if (state === 'OK') return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">${state}</span>`; return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">${state}</span>`; };

        
        // --- SECCIÓN DE IAM ---

        const buildIamView = () => {
            const container = document.getElementById('iam-view');
            if (!container) return;

            container.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div><h2 class="text-2xl font-bold text-[#204071]">Identity & Access</h2><p class="text-sm text-gray-500 scan-info"></p></div>
                </header>
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex flex-wrap space-x-6" id="iam-tabs">
                        <a href="#" data-tab="resumen-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">Resumen</a>
                        <a href="#" data-tab="usuarios-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Usuarios</a>
                        <a href="#" data-tab="grupos-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Grupos</a>
                        <a href="#" data-tab="roles-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Roles</a>
                        <a href="#" data-tab="politicas-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Políticas de Contraseñas</a>
                        <a href="#" data-tab="detalle-permisos-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Detalle de Permisos</a>
                        <a href="#" data-tab="critical-perms-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Usuarios con Permisos Críticos</a>
                        <a href="#" data-tab="federation-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Federación</a>
                        <a href="#" data-tab="securityhub-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Security Hub</a>
                    </nav>
                </div>
                <div id="iam-tab-content-container">
                    <div id="resumen-content" class="iam-tab-content">${createIamResumenHtml()}</div>
                    <div id="usuarios-content" class="iam-tab-content hidden">${createIamUsuariosHtml()}</div>
                    <div id="grupos-content" class="iam-tab-content hidden">${createIamGruposHtml()}</div>
                    <div id="roles-content" class="iam-tab-content hidden">${createIamRolesHtml()}</div>
                    <div id="politicas-content" class="iam-tab-content hidden">${createIamPoliticasHtml()}</div>
                    <div id="securityhub-content" class="iam-tab-content hidden">${createSecurityHubHtml()}</div>
                    <div id="detalle-permisos-content" class="iam-tab-content hidden">${renderIamDetailsViewHtml()}</div>
                    <div id="critical-perms-content" class="iam-tab-content hidden"></div>
                    <div id="federation-content" class="iam-tab-content hidden"></div>
                </div>`;

            const tabsNav = container.querySelector('#iam-tabs');
            if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.iam-tab-content'));

            const getDetailsBtn = document.getElementById('iam-get-details-btn');
            if (getDetailsBtn) getDetailsBtn.addEventListener('click', getIamPermissionDetails);

            if (iamApiData) updateIamDashboard();
            if (securityHubApiData) updateSecurityHubDashboard();
        };



        const createIamResumenHtml = () => `
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-5 mb-8">
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Total Usuarios</p></div><div class="flex justify-between items-end pt-4"><p id="iam-total-users" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-6 h-6 text-blue-600" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Usuarios Privilegiados</p></div><div class="flex justify-between items-end pt-4"><p id="iam-privileged-users" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-yellow-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-6 h-6 text-yellow-600" viewBox="0 0 16 16"><path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m.5-5v1h1a.5.5 0 0 1 0 1h-1v1a.5.5 0 0 1-1 0v-1h-1a.5.5 0 0 1 0-1h1v-1a.5.5 0 0 1 1 0m-2-6a3 3 0 1 1-6 0 3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/><path d="M8.256 14a4.5 4.5 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10q.39 0 .74.025c.226-.341.496-.65.804-.918Q8.844 9.002 8 9c-5 0-6 3-6 4s1 1 1 1z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Grupos Privilegiados</p></div><div class="flex justify-between items-end pt-4"><p id="iam-privileged-groups" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-yellow-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-6 h-6 text-yellow-600" viewBox="0 0 16 16"><path d="M5 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4m4-2.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5M9 8a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4A.5.5 0 0 1 9 8m1 2.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5"/><path d="M2 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2zM1 4a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H8.96q.04-.245.04-.5C9 10.567 7.21 9 5 9c-2.086 0-3.8 1.398-3.984 3.181A1 1 0 0 1 1 12z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Roles Privilegiados</p></div><div class="flex justify-between items-end pt-4"><p id="iam-privileged-roles" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-yellow-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-6 h-6 text-yellow-600" viewBox="0 0 16 16"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm9 1.5a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 0-1h-4a.5.5 0 0 0-.5.5M9 8a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 0-1h-4A.5.5 0 0 0 9 8m1 2.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5m-1 2C9 10.567 7.21 9 5 9c-2.086 0-3.8 1.398-3.984 3.181A1 1 0 0 1 1 12zM7 6a2 2 0 1 0-4 0 2 2 0 0 0 4 0"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Cumplimiento MFA</p></div><div class="flex justify-between items-end pt-4"><p id="iam-mfa-compliance" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-red-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-6 h-6 text-red-600" viewBox="0 0 16 16"><path d="M6.5 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1zM11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/><path d="M4.5 0A2.5 2.5 0 0 0 2 2.5V14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2.5A2.5 2.5 0 0 0 11.5 0zM3 2.5A1.5 1.5 0 0 1 4.5 1h7A1.5 1.5 0 0 1 13 2.5v10.795a4.2 4.2 0 0 0-.776-.492C11.392 12.387 10.063 12 8 12s-3.392.387-4.224.803a4.2 4.2 0 0 0-.776.492z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Políticas de Contraseña</p></div><div class="flex justify-between items-end pt-4"><p id="iam-password-compliance" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-green-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-6 h-6 text-green-600" viewBox="0 0 16 16"><path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2z"/><path d="M7 5.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m-1.496-.854a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 1 1 .708-.708l.146.147 1.146-1.147a.5.5 0 0 1 .708 0M7 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m-1.496-.854a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 0 1 .708-.708l.146.147 1.146-1.147a.5.5 0 0 1 .708 0"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Hallazgos IAM (Crit/High)</p></div><div class="flex justify-between items-end pt-4"><p id="iam-critical-findings" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-orange-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-6 h-6 text-orange-600" viewBox="0 0 16 16"> <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/></svg></div></div></div>
            </div>`;
        const createIamUsuariosHtml = () => `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"> <h3 class="font-bold text-lg mb-4 text-[#204071]">Listado de Usuarios IAM</h3> <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contraseña</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Último Uso Contraseña</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MFA</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grupos</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Políticas Adjuntas</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Políticas Inline</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Access Keys</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roles (Tag)</th></tr></thead><tbody id="users-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div> </div>`;
        const createIamGruposHtml = () => `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 class="font-bold text-lg mb-4 text-[#204071]">Listado de Grupos IAM</h3><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre del Grupo</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Creación</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Políticas Adjuntas</th></tr></thead><tbody id="groups-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>`;
        const createIamRolesHtml = () => `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 class="font-bold text-lg mb-4 text-[#204071]">Listado de Roles IAM</h3><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre del Rol</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Creación</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Políticas Adjuntas</th></tr></thead><tbody id="roles-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>`;
        const createIamPoliticasHtml = () => `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 class="font-bold text-lg mb-4 text-[#204071]">Política de Contraseñas de la Cuenta</h3><div id="password-policy-container"></div></div>`;   
        const createSecurityHubHtml = () => `
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-4 text-[#204071]">Findings de Seguridad Activos (IAM)</h3>
                
                <div id="iam-sh-filter-controls" class="flex flex-wrap items-center gap-2 mb-4">
                    <span class="text-sm font-medium text-gray-700 mr-2">Filtrar por severidad:</span>
                    <button data-severity="ALL" class="iam-sh-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-[#eb3496] text-white">Todos</button>
                    <button data-severity="CRITICAL" class="iam-sh-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">Critical</button>
                    <button data-severity="HIGH" class="iam-sh-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">High</button>
                    <button data-severity="MEDIUM" class="iam-sh-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">Medium</button>
                    <button data-severity="LOW" class="iam-sh-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">Low</button>
                </div>
                <div id="sh-iam-findings-container" class="overflow-x-auto"></div>
            </div>`;
        const updateIamDashboard = () => { 
            const { users, roles, groups, password_policy } = iamApiData.results;
            const { accountId, executionDate } = iamApiData.metadata;
            const scanInfo = `Resultados para la cuenta ${accountId} - ${executionDate}`;
            const infoElement = document.querySelector('#iam-view .scan-info');
            if (infoElement) infoElement.textContent = scanInfo;
            const totalUsers = users.length;
            const privilegedUsersCount = users.filter(u => u.IsPrivileged).length;
            const privilegedGroupsCount = groups.filter(g => g.IsPrivileged).length;
            const privilegedRolesCount = roles.filter(r => r.IsPrivileged).length;
            const mfaEnabledUsers = users.filter(u => u.MFADevices.length > 0).length;
            const mfaCompliance = totalUsers > 0 ? Math.round((mfaEnabledUsers / totalUsers) * 100) : 0;
            let passwordPolicyCompliance = 0;
            if (!password_policy.Error) {
                const checks = [ (password_policy.MinimumPasswordLength || 0) >= 12, password_policy.RequireUppercaseCharacters, password_policy.RequireLowercaseCharacters, password_policy.RequireNumbers, password_policy.RequireSymbols, password_policy.MaxPasswordAge && password_policy.MaxPasswordAge <= 90, (password_policy.PasswordReusePrevention || 0) >= 4, password_policy.HardExpiry ];
                const passedChecks = checks.filter(Boolean).length;
                passwordPolicyCompliance = Math.round((passedChecks / checks.length) * 100);
            }
            const criticalHighIamFindings = securityHubApiData.results.findings.iamFindings.filter(f => f.Severity?.Label === 'CRITICAL' || f.Severity?.Label === 'HIGH').length;
            document.getElementById('iam-total-users').textContent = totalUsers;
            document.getElementById('iam-privileged-users').textContent = privilegedUsersCount;
            document.getElementById('iam-privileged-groups').textContent = privilegedGroupsCount;
            document.getElementById('iam-privileged-roles').textContent = privilegedRolesCount;
            document.getElementById('iam-mfa-compliance').textContent = `${mfaCompliance}%`;
            document.getElementById('iam-password-compliance').textContent = `${passwordPolicyCompliance}%`;
            document.getElementById('iam-critical-findings').textContent = criticalHighIamFindings;
            renderUsersTable(users);
            renderGroupsTable(groups);
            renderRolesTable(roles);
            renderPasswordPolicy(password_policy);

            renderCriticalPermissionsTable(users);
        };

        const renderCriticalPermissionsTable = (users) => {
            const container = document.getElementById('critical-perms-content');
            if (!container) return;

            // 1. Reorganizamos los datos: Agrupamos por categoría de servicio en lugar de por usuario.
            const permissionsByCategory = {
                network: [],
                cloudtrail: [],
                database: [],
                waf: []
            };

            users.forEach(user => {
                if (user.criticalPermissions) {
                    for (const category in user.criticalPermissions) {
                        if (user.criticalPermissions[category].length > 0) {
                            permissionsByCategory[category].push({
                                userName: user.UserName,
                                permissions: user.criticalPermissions[category]
                            });
                        }
                    }
                }
            });

            const categoryNames = {
                network: 'Red (VPC, SG, ACLs)',
                cloudtrail: 'CloudTrail',
                database: 'Bases de Datos (RDS, DynamoDB)',
                waf: 'WAF'
            };
            const categoryStyles = {
                network: 'bg-blue-100 text-blue-800',
                cloudtrail: 'bg-indigo-100 text-indigo-800',
                database: 'bg-purple-100 text-purple-800',
                waf: 'bg-pink-100 text-pink-800'
            };

            // Comprobamos si hay algún resultado para mostrar
            const hasAnyPrivilegedUser = Object.values(permissionsByCategory).some(userList => userList.length > 0);

            if (!hasAnyPrivilegedUser) {
                container.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><p class="text-center text-gray-500">¡Buen trabajo! No se encontraron usuarios con permisos críticos en las categorías analizadas.</p></div>`;
                return;
            }

            // 2. Construimos la nueva tabla HTML a partir de los datos reorganizados.
            let tableHtml = `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                <h3 class="font-bold text-lg mb-4 text-[#204071]">Permisos Críticos por Servicio</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Servicio Crítico</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuarios y Permisos Asignados</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">`;

            for (const category in permissionsByCategory) {
                const userList = permissionsByCategory[category];
                if (userList.length > 0) { // Solo mostramos filas para servicios que tienen usuarios con permisos
                    tableHtml += `<tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 align-top">
                                        <span class="inline-block ${categoryStyles[category]} text-sm font-semibold mr-2 px-4 py-1.5 rounded-full">${categoryNames[category]}</span>
                                    </td>
                                    <td class="px-6 py-4 text-sm align-top">
                                        <div class="space-y-4">`;
                    
                    userList.forEach(user => {
                        const permissionsBadges = user.permissions.map(perm => 
                            `<span class="inline-block bg-gray-100 text-gray-800 text-xs font-mono font-medium mr-2 mb-2 px-2.5 py-0.5 rounded-full">${perm}</span>`
                        ).join('');

                        tableHtml += `<div class="border-b border-gray-100 pb-3 last:border-b-0">
                                        <p class="font-semibold text-gray-800">${user.userName}</p>
                                        <div class="mt-1">${permissionsBadges}</div>
                                    </div>`;
                    });

                    tableHtml += `</div></td></tr>`;
                }
            }

            tableHtml += `</tbody></table></div></div>`;
            container.innerHTML = tableHtml;
        };

        const renderFederationView = () => {
            const container = document.getElementById('federation-content');
            if (!container || !federationApiData) return;

            // Extraemos las dos secciones de datos
            const { iam_federation, identity_center } = federationApiData.results;

            // --- HTML para la Federación IAM Tradicional (como antes) ---
            let aliasHtml = `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6">
                                <h3 class="font-bold text-lg mb-2 text-[#204071]">Alias de la Cuenta</h3>`;
            if (iam_federation.account_alias) {
                const signInUrl = `https://${iam_federation.account_alias}.signin.aws.amazon.com/console`;
                aliasHtml += `<p class="text-sm text-gray-600">Alias: <strong class="font-mono bg-gray-100 p-1 rounded">${iam_federation.account_alias}</strong></p>
                            <p class="text-sm text-gray-600 mt-2">URL de inicio de sesión:</p>
                            <a href="${signInUrl}" target="_blank" class="text-blue-600 hover:underline font-mono text-sm break-all">${signInUrl}</a>`;
            } else {
                aliasHtml += `<p class="text-sm text-gray-600">Esta cuenta no tiene un alias personalizado configurado.</p>`;
            }
            aliasHtml += `</div>`;

            // ... (El código para las tablas SAML y OIDC puede seguir aquí si quieres mantenerlo) ...

            // --- HTML para AWS Identity Center (NUEVO) ---
            let identityCenterHtml = `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6">
                                        <h3 class="font-bold text-lg mb-4 text-[#204071]">AWS Identity Center (SSO)</h3>`;

            if (identity_center.status === 'Encontrado') {
                const { instance_arn, assignments } = identity_center;

                identityCenterHtml += `<div class="mb-6 space-y-2 text-sm">
                                            <p><strong class="text-gray-600">ARN de la Instancia:</strong> <span class="font-mono bg-gray-100 p-1 rounded">${instance_arn}</span></p>
                                        </div>`;

                if (assignments.length > 0) {
                    identityCenterHtml += `<h4 class="font-semibold text-md mb-2">Asignaciones de Permisos</h4>
                                            <div class="overflow-x-auto">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50"><tr>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Grupo</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Conjunto de Permisos (Rol)</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID de Cuenta AWS</th>
                                                </tr></thead>
                                                <tbody class="bg-white divide-y divide-gray-200">`;
                    assignments.forEach(a => {
                        identityCenterHtml += `<tr class="hover:bg-gray-50">
                                                <td class="px-4 py-3 text-sm font-medium text-gray-800">${a.GroupName}</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">${a.PermissionSetName}</td>
                                                <td class="px-4 py-3 text-sm text-gray-600 font-mono">${a.AccountId}</td>
                                            </tr>`;
                    });
                    identityCenterHtml += `</tbody></table></div>`;
                } else {
                    identityCenterHtml += `<p class="text-center text-gray-500 py-4">Identity Center está activado, pero no se encontraron asignaciones de permisos a grupos.</p>`;
                }
            } else {
                // Mensaje si no se encuentra Identity Center o hay un error
                identityCenterHtml += `<p class="text-center text-gray-500 py-4">${identity_center.message}</p>`;
            }

            identityCenterHtml += `</div>`;

            // Unimos todas las secciones de HTML
            container.innerHTML = aliasHtml + identityCenterHtml;
        };


        const updateSecurityHubDashboard = () => {
            log('Renderizando datos de Security Hub (IAM)...', 'info');
            const allIamFindings = securityHubApiData.results.findings.iamFindings;
            const filterControlsContainer = document.getElementById('iam-sh-filter-controls');

            // Función para renderizar la tabla con los findings filtrados
            const renderFilteredFindings = (severity) => {
                let filteredFindings = allIamFindings;
                if (severity !== 'ALL') {
                    filteredFindings = allIamFindings.filter(f => f.Severity?.Label === severity);
                }
                renderSecurityHubFindings(filteredFindings, 'sh-iam-findings-container', `No se encontraron findings de IAM con severidad '${severity}'.`);
            };

            // Añadir el listener a los botones
            if (filterControlsContainer) {
                filterControlsContainer.addEventListener('click', (e) => {
                    const filterBtn = e.target.closest('.iam-sh-filter-btn');
                    if (!filterBtn) return;

                    // Actualizar estilos de los botones
                    filterControlsContainer.querySelectorAll('.iam-sh-filter-btn').forEach(btn => {
                        btn.classList.remove('bg-[#eb3496]', 'text-white');
                        btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-50');
                    });
                    filterBtn.classList.add('bg-[#eb3496]', 'text-white');
                    filterBtn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-50');
                    
                    // Renderizar la tabla con el filtro aplicado
                    const selectedSeverity = filterBtn.dataset.severity;
                    renderFilteredFindings(selectedSeverity);
                });
            }

            // Renderizado inicial (mostrar todos los findings)
            renderFilteredFindings('ALL');
        };          
        const renderUsersTable = (users) => {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = '';
            if (!users || users.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center text-gray-500 py-4">No se encontraron usuarios.</td></tr>`;
                return;
            }
            users.forEach(user => {
                const vipBadge = user.IsPrivileged ? '<span class="bg-yellow-200 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">VIP</span>' : '';
                const passwordEnabled = user.PasswordEnabled ? 'Sí' : 'No';
                const mfaEnabled = user.MFADevices.length > 0 ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Sí</span>' : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">No</span>';
                const groups = user.Groups.join(', ') || '-';
                const attachedPolicies = user.AttachedPolicies.join(', ') || '-';
                const inlinePolicies = user.InlinePolicies.join(', ') || '-';
                const roles = user.Roles.join(', ') || '-';

                let accessKeysHtml = '-';
                if (user.AccessKeys && user.AccessKeys.length > 0) {
                    const keysDetails = user.AccessKeys.map(k => {
                        const createDate = new Date(k.CreateDate);
                        const now = new Date();
                        const ageDays = Math.floor((now - createDate) / (1000 * 60 * 60 * 24));
                        const ageClass = ageDays > 90 ? 'text-red-600 font-bold' : 'text-gray-600';
                        const statusClass = k.Status === 'Active' ? 'text-green-600' : 'text-gray-500';
                        const lastUsed = k.LastUsedDate !== 'N/A' ? new Date(k.LastUsedDate).toLocaleDateString() : 'Nunca';

                        return `
                            <div class="p-2 bg-gray-100 rounded-md border border-gray-200 text-xs">
                                <div class="font-mono font-semibold text-gray-800">${k.AccessKeyId}</div>
                                <div><span class="font-semibold">Estado:</span> <span class="${statusClass}">${k.Status}</span></div>
                                <div><span class="font-semibold">Antigüedad:</span> <span class="${ageClass}">${ageDays} días</span></div>
                                <div><span class="font-semibold">Último Uso:</span> ${lastUsed}</div>
                            </div>
                        `;
                    }).join('');

                    accessKeysHtml = `
                        <details class="group">
                            <summary class="font-semibold text-blue-600 cursor-pointer list-none flex items-center">
                                <svg class="w-4 h-4 mr-1 group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                ${user.AccessKeys.length} Access Key(s)
                            </summary>
                            <div class="mt-2 pl-2 flex flex-col space-y-2">
                                ${keysDetails}
                            </div>
                        </details>
                    `;
                }
                const accessKeys = accessKeysHtml;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-xs font-medium text-[#204071] flex items-center">${vipBadge}${user.UserName}</td> 
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">${passwordEnabled}</td> 
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">${user.PasswordLastUsed}</td> 
                    <td class="px-6 py-4 whitespace-nowrap text-xs">${mfaEnabled}</td> 
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">${groups}</td> 
                    <td class="px-6 py-4 text-xs text-gray-500 break-words">${attachedPolicies}</td> 
                    <td class="px-6 py-4 text-xs text-gray-500 break-words">${inlinePolicies}</td> 
                    <td class="px-6 py-4 text-xs text-gray-500 align-top">${accessKeys}</td> 
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">${roles}</td>`;
                tableBody.appendChild(row);
            });
        };


        const renderGroupsTable = (groups) => { const tableBody = document.getElementById('groups-table-body'); tableBody.innerHTML = ''; if (!groups || groups.length === 0) { tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500 py-4">No se encontraron grupos.</td></tr>`; return; } groups.forEach(group => { const vipBadge = group.IsPrivileged ? '<span class="bg-yellow-200 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">VIP</span>' : ''; const attachedPolicies = group.AttachedPolicies.join(', ') || '-'; const row = document.createElement('tr'); row.className = 'hover:bg-gray-50'; row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-[#204071] flex items-center">${vipBadge}${group.GroupName}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(group.CreateDate).toLocaleDateString()}</td> <td class="px-6 py-4 text-sm text-gray-500 break-words">${attachedPolicies}</td>`; tableBody.appendChild(row); }); };
        const renderRolesTable = (roles) => { const tableBody = document.getElementById('roles-table-body'); tableBody.innerHTML = ''; if (!roles || roles.length === 0) { tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500 py-4">No se encontraron roles.</td></tr>`; return; } roles.forEach(role => { const vipBadge = role.IsPrivileged ? '<span class="bg-yellow-200 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">VIP</span>' : ''; const attachedPolicies = role.AttachedPolicies.join(', ') || '-'; const row = document.createElement('tr'); row.className = 'hover:bg-gray-50'; row.innerHTML = `<td class="px-6 py-4 text-sm font-medium text-[#204071] break-words flex items-center">${vipBadge}${role.RoleName}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(role.CreateDate).toLocaleDateString()}</td> <td class="px-6 py-4 text-sm text-gray-500 break-words">${attachedPolicies}</td>`; tableBody.appendChild(row); }); };
        const renderPasswordPolicy = (policy) => { const container = document.getElementById('password-policy-container'); container.innerHTML = ''; if (policy.Error) { container.innerHTML = `<p class="text-red-600 font-medium">No hay política de contraseñas configurada en esta cuenta.</p>`; return; } const checks = [ { desc: "Longitud mínima >= 12", ok: (policy.MinimumPasswordLength || 0) >= 12, val: policy.MinimumPasswordLength }, { desc: "Requiere mayúsculas", ok: policy.RequireUppercaseCharacters, val: policy.RequireUppercaseCharacters }, { desc: "Requiere minúsculas", ok: policy.RequireLowercaseCharacters, val: policy.RequireLowercaseCharacters }, { desc: "Requiere números", ok: policy.RequireNumbers, val: policy.RequireNumbers }, { desc: "Requiere símbolos", ok: policy.RequireSymbols, val: policy.RequireSymbols }, { desc: "Caducidad <= 90 días", ok: policy.MaxPasswordAge && policy.MaxPasswordAge <= 90, val: policy.MaxPasswordAge }, { desc: "Reutilización >= 4 contraseñas", ok: (policy.PasswordReusePrevention || 0) >= 4, val: policy.PasswordReusePrevention }, { desc: "Expiración forzada tras fallo", ok: policy.HardExpiry, val: policy.HardExpiry }, ]; let checksHtml = `<h4 class="font-semibold text-md mb-2">Chequeos de Cumplimiento</h4><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 mb-6"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chequeo</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Configurado</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`; checks.forEach(({ desc, ok, val }) => { const statusIcon = ok ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">OK</span>' : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">KO</span>'; checksHtml += `<tr><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${desc}</td><td class="px-4 py-2 whitespace-nowrap text-sm">${statusIcon}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${val === undefined ? 'No definido' : val}</td></tr>`; }); checksHtml += `</tbody></table></div>`; const rawJsonHtml = `<h4 class="font-semibold text-md mb-2 mt-6">Respuesta Raw de la API</h4><pre class="bg-[#204071] text-white p-4 rounded-lg text-sm overflow-x-auto"><code>${JSON.stringify(policy, null, 2)}</code></pre>`; container.innerHTML = checksHtml + rawJsonHtml; };
        const renderIamDetailsViewHtml = () => {
            return `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-lg mb-4 text-[#204071]">Ver Permisos Detallados de un Principal IAM</h3>
                    <p class="text-sm text-gray-600 mb-4">Introduce el nombre exacto de un usuario, grupo o rol para ver todas sus políticas de permisos asociadas.</p>
                    <div class="flex flex-col sm:flex-row gap-4 items-end">
                        <div class="flex-grow">
                            <label for="iam-principal-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre de Usuario, Grupo o Rol</label>
                            <input type="text" id="iam-principal-name" class="bg-gray-50 border border-gray-300 text-[#204071] text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block w-full p-2.5 font-mono" placeholder="Ej: admin-user, DevelopersGroup, EC2AdminRole">
                        </div>
                        <button id="iam-get-details-btn" class="w-full sm:w-auto bg-[#204071] text-white px-5 py-2.5 rounded-lg font-bold text-md hover:bg-[#1a335a] transition">Ver Detalle</button>
                    </div>
                </div>
                <div id="iam-details-result-container" class="mt-6"></div>
            `;
        };
        const getIamPermissionDetails = () => {
            log('Buscando detalles de permisos IAM...', 'info');
            const principalName = document.getElementById('iam-principal-name').value.trim();
            const resultsContainer = document.getElementById('iam-details-result-container');

            if (!principalName) {
                resultsContainer.innerHTML = `<p class="text-yellow-600 font-medium">Por favor, introduce un nombre para buscar.</p>`;
                return;
            }

            if (!iamApiData || !iamApiData.results) {
                resultsContainer.innerHTML = `<p class="text-red-600 font-medium">No hay datos de IAM cargados. Por favor, ejecuta un análisis primero.</p>`;
                log('Intento de búsqueda de permisos sin datos de IAM.', 'error');
                return;
            }

            const { users, groups, roles } = iamApiData.results;
            let foundPrincipal = null;
            let principalType = '';

            const user = users.find(u => u.UserName.toLowerCase() === principalName.toLowerCase());
            if (user) {
                foundPrincipal = user;
                principalType = 'Usuario';
            } else {
                const group = groups.find(g => g.GroupName.toLowerCase() === principalName.toLowerCase());
                if (group) {
                    foundPrincipal = group;
                    principalType = 'Grupo';
                } else {
                    const role = roles.find(r => r.RoleName.toLowerCase() === principalName.toLowerCase());
                    if (role) {
                        foundPrincipal = role;
                        principalType = 'Rol';
                    }
                }
            }

            renderIamPermissionDetails(foundPrincipal, principalType, principalName);
        };
        const renderIamPermissionDetails = (principal, type, name) => {
            const resultsContainer = document.getElementById('iam-details-result-container');
            if (!principal) {
                resultsContainer.innerHTML = `<div class="bg-red-50 text-red-700 p-4 rounded-lg"><h4 class="font-bold">No encontrado</h4><p>No se encontró ningún usuario, grupo o rol con el nombre '${name}'.</p></div>`;
                log(`Principal IAM '${name}' no encontrado.`, 'error');
                return;
            }

            let detailsToShow = {};

            if (type === 'Usuario') {
                detailsToShow = {
                    Tipo: 'Usuario',
                    Nombre: principal.UserName,
                    PermisosDirectos: {
                        PoliticasAdjuntas: principal.AttachedPolicies,
                        PoliticasInline: principal.InlinePolicies,
                    },
                    PermisosHeredados: {
                         Grupos: principal.Groups,
                         RolesAsumibles_por_Tag: principal.Roles,
                    }
                };
            } else if (type === 'Grupo') {
                 detailsToShow = {
                    Tipo: 'Grupo',
                    Nombre: principal.GroupName,
                    Permisos: {
                        PoliticasAdjuntas: principal.AttachedPolicies,
                    }
                };
            } else if (type === 'Rol') {
                 detailsToShow = {
                    Tipo: 'Rol',
                    Nombre: principal.RoleName,
                    Permisos: {
                        PoliticasAdjuntas: principal.AttachedPolicies,
                        PoliticasInline: principal.InlinePolicies
                    }
                };
            }
            
            const formattedJson = JSON.stringify(detailsToShow, null, 2);
            log(`Mostrando detalles para ${type}: ${name}`, 'success');

            resultsContainer.innerHTML = `
                <h3 class="text-xl font-bold text-[#204071] mb-4">Detalles para ${type}: ${name}</h3>
                <pre class="bg-[#204071] text-white p-4 rounded-lg text-xs font-mono overflow-x-auto">${formattedJson}</pre>
            `;
        };


        // --- SECCIÓN DE INTERNET EXPOSURE ---

        const buildExposureView = () => {
            const container = document.getElementById('exposure-view');
            if (!exposureApiData) return;

            // --- INICIO DE LA MODIFICACIÓN ---

            // CAMBIO CLAVE 1: Definimos una lista fija de todos los servicios que queremos mostrar.
            // Esto asegura que todas las pestañas se creen siempre.
            const allExposureServices = [
                "S3 Public Buckets", 
                "EC2 Public Instances", 
                "Security Groups Open", 
                "ALB/NLB Public", 
                "Lambda URLs", 
                "API Gateway Public", 
                "Assumable Roles"
            ];

            const summary = exposureApiData.results.summary;
            const details = exposureApiData.results.details;
            const networkPorts = exposureApiData.results.network_ports || [];
            const securityHubFindings = securityHubApiData.results.findings.exposureFindings;

            // 2. Construimos el HTML para las pestañas de navegación
            let tabsHtml = `<a href="#" data-tab="exposure-summary-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">Resumen</a>`;
            
            // CAMBIO CLAVE 2: Iteramos sobre nuestra lista fija de servicios, no sobre las claves del resultado.
            allExposureServices.forEach(service => {
                // Calculamos el recuento de hallazgos para mostrarlo en la pestaña. Si no hay datos, es 0.
                const serviceRegions = details[service] || {};
                const count = Object.values(serviceRegions).flat().length;
                tabsHtml += `<a href="#" data-tab="exposure-${service.replace(/\s+/g, '-')}-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">${service} (${count})</a>`;
            });
            
            tabsHtml += `<a href="#" data-tab="exposure-network-ports-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Publicly Exposed Network Ports (${networkPorts.length})</a>`;
            tabsHtml += `<a href="#" data-tab="exposure-securityhub-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Security Hub Findings</a>`;

            // 3. Construimos el HTML para los contenedores de contenido de cada pestaña
            let contentHtml = `<div id="exposure-summary-content" class="exposure-tab-content">${createExposureSummaryCardsHtml()}</div>`;
            
            // CAMBIO CLAVE 3: También aquí iteramos sobre la lista fija para crear todos los contenedores.
            allExposureServices.forEach(service => {
                contentHtml += `<div id="exposure-${service.replace(/\s+/g, '-')}-content" class="exposure-tab-content hidden">${renderExposureDetails(service, details[service] || {})}</div>`;
            });
            
            contentHtml += `<div id="exposure-network-ports-content" class="exposure-tab-content hidden"></div>`;
            contentHtml += `<div id="exposure-securityhub-content" class="exposure-tab-content hidden">${createExposureSecurityHubHtml()}</div>`;

            // --- FIN DE LA MODIFICACIÓN ---

            // 4. Insertamos toda la estructura HTML en el DOM (sin cambios)
            container.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-[#204071]">Internet Exposure</h2>
                        <p class="text-sm text-gray-500">${exposureApiData.metadata.executionDate}</p>
                    </div>
                </header>
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex flex-wrap space-x-6">${tabsHtml}</nav>
                </div>
                <div>${contentHtml}</div>
            `;

            // 5. Actualizamos los datos dinámicos y asignamos eventos (sin cambios)
            updateExposureSummaryCards(summary, securityHubFindings);
            
            const networkPortsContainer = container.querySelector('#exposure-network-ports-content');
            if (networkPortsContainer) {
                networkPortsContainer.innerHTML = renderNetworkPortsTable(networkPorts);
            }

            const tabsNav = container.querySelector('nav');
            if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.exposure-tab-content'));
            
            if (securityHubApiData) {
                renderSecurityHubFindings(securityHubFindings, 'sh-exposure-findings-container', 'No se encontraron findings de Security Hub relacionados con exposición a internet.');
            }
        };
        
        const createExposureSummaryCardsHtml = () => `
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-5 mb-8">
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">ALB/NLB Public</p></div><div class="flex justify-between items-end pt-4"><p id="exp-total-albs" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-red-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-red-600" viewBox="0 0 16 16"> <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0z"/> <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">EC2 Public Instances</p></div><div class="flex justify-between items-end pt-4"><p id="exp-total-ec2s" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-red-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-red-600" viewBox="0 0 16 16"> <path d="M5 0a.5.5 0 0 1 .5.5V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2A2.5 2.5 0 0 1 14 4.5h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14a2.5 2.5 0 0 1-2.5 2.5v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14A2.5 2.5 0 0 1 2 11.5H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2A2.5 2.5 0 0 1 4.5 2V.5A.5.5 0 0 1 5 0m-.5 3A1.5 1.5 0 0 0 3 4.5v7A1.5 1.5 0 0 0 4.5 13h7a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 11.5 3zM5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5zM6.5 6a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Security Groups Open</p></div><div class="flex justify-between items-end pt-4"><p id="exp-total-sgs" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-red-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-red-600" viewBox="0 0 16 16"> <path fill-rule="evenodd" d="M12 0a4 4 0 0 1 4 4v2.5h-1V4a3 3 0 1 0-6 0v2h.5A2.5 2.5 0 0 1 12 8.5v5A2.5 2.5 0 0 1 9.5 16h-7A2.5 2.5 0 0 1 0 13.5v-5A2.5 2.5 0 0 1 2.5 6H8V4a4 4 0 0 1 4-4M2.5 7A1.5 1.5 0 0 0 1 8.5v5A1.5 1.5 0 0 0 2.5 15h7a1.5 1.5 0 0 0 1.5-1.5v-5A1.5 1.5 0 0 0 9.5 7z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">S3 Buckets Public</p></div><div class="flex justify-between items-end pt-4"><p id="exp-total-s3" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-red-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-red-600" viewBox="0 0 16 16"> <path d="M2.522 5H2a.5.5 0 0 0-.494.574l1.372 9.149A1.5 1.5 0 0 0 4.36 16h7.278a1.5 1.5 0 0 0 1.483-1.277l1.373-9.149A.5.5 0 0 0 14 5h-.522A5.5 5.5 0 0 0 2.522 5m1.005 0a4.5 4.5 0 0 1 8.945 0zm9.892 1-1.286 8.574a.5.5 0 0 1-.494.426H4.36a.5.5 0 0 1-.494-.426L2.58 6h10.838z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Hallazgos (Crit/High)</p></div><div class="flex justify-between items-end pt-4"><p id="exp-critical-findings" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-orange-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-orange-600" viewBox="0 0 16 16"> <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/></svg></div></div></div>
            </div>`;

        const createExposureSecurityHubHtml = () => `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 class="font-bold text-lg mb-4 text-[#204071]">Findings de Seguridad Activos (Exposición a Internet)</h3><div id="sh-exposure-findings-container" class="overflow-x-auto"></div></div>`;
        
        const updateExposureSummaryCards = (summaryData, findingsData) => { 
            const sumValues = (serviceName) => { 
                if (!summaryData[serviceName]) return 0; 
                return Object.values(summaryData[serviceName]).reduce((total, count) => total + count, 0); 
            }; 
            document.getElementById('exp-total-albs').textContent = sumValues('ALB/NLB Public'); 
            document.getElementById('exp-total-ec2s').textContent = sumValues('EC2 Public Instances'); 
            document.getElementById('exp-total-sgs').textContent = sumValues('Security Groups Open'); 
            document.getElementById('exp-total-s3').textContent = sumValues('S3 Public Buckets'); 
            const criticalHighFindings = findingsData.filter(f => f.Severity?.Label === 'CRITICAL' || f.Severity?.Label === 'HIGH').length; 
            document.getElementById('exp-critical-findings').textContent = criticalHighFindings; 
        };
        
        const renderExposureDetails = (service, regions) => {
            if (Object.keys(regions).length === 0) {
                return `<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron recursos de tipo "${service}" expuestos.</p></div>`;
            }

            let html = '<div class="space-y-6">';

            if (service === "ALB/NLB Public") {
                Object.entries(regions).sort(([keyA], [keyB]) => keyA.localeCompare(keyB)).forEach(([region, loadBalancers]) => {
                    html += `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                <h4 class="font-semibold text-md text-[#204071] mb-3 pb-2 border-b">${region}</h4>
                                <div class="space-y-4">`;

                    loadBalancers.forEach(lb => {
                        html += `<details class="group bg-gray-50 p-3 rounded-lg">
                                    <summary class="font-semibold text-gray-800 cursor-pointer flex items-center">
                                        <svg class="w-4 h-4 mr-2 group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                        ${lb.name}
                                    </summary>
                                    <div class="mt-3 pl-6 border-l-2 border-gray-300 space-y-3">`;

                        // --- CAMBIO CLAVE AQUÍ ---
                        // Comprobamos si la lista de listeners tiene contenido.
                        if (lb.listeners.length > 0) {
                            // Si tiene, mostramos los detalles de TLS como antes.
                            lb.listeners.forEach(listener => {
                                const tlsClass = listener.isOutdated ? 'text-red-600 font-bold' : 'text-green-700';
                                const ciphersHtml = listener.ciphers.map(c => `<li class="font-mono text-xs">${c}</li>`).join('');

                                html += `<div class="text-sm">
                                            <p><strong>Puerto:</strong> ${listener.port} (${listener.protocol})</p>
                                            <p><strong>Política TLS:</strong> <span class="font-mono">${listener.policyName}</span></p>
                                            <p><strong>Versiones:</strong> <span class="${tlsClass}">${listener.tlsVersions.join(', ')}</span></p>
                                            <details class="mt-1 text-xs">
                                                <summary class="cursor-pointer text-gray-500">Ver ${listener.ciphers.length} ciphers</summary>
                                                <ul class="list-disc list-inside pl-2 mt-1 text-gray-600">${ciphersHtml}</ul>
                                            </details>
                                        </div>`;
                            });
                        } else {
                            // Si no tiene, mostramos un mensaje informativo.
                            html += `<p class="text-sm text-gray-500">Este balanceador no tiene listeners HTTPS/TLS configurados.</p>`;
                        }
                        // --- FIN DEL CAMBIO ---

                        html += `</div></details>`;
                    });

                    html += `</div></div>`;
                });
            } else {
                // Lógica original para el resto de servicios (sin cambios)
                Object.entries(regions).sort(([keyA], [keyB]) => keyA.localeCompare(keyB)).forEach(([region, items]) => {
                    html += `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"><h4 class="font-semibold text-md text-[#204071] mb-2">${region}</h4><ul class="space-y-2 font-mono text-sm">`;
                    if (service === "EC2 Public Instances") {
                        const stateClasses = { 'running': 'bg-green-100 text-green-800', 'stopped': 'bg-red-100 text-red-800', 'terminated': 'bg-gray-200 text-gray-800', 'stopping': 'bg-red-100 text-red-800', 'pending': 'bg-yellow-100 text-yellow-800' };
                        items.forEach(item => {
                            const stateClass = stateClasses[item.State] || 'bg-gray-200 text-gray-800';
                            html += `<li class="flex items-center justify-between text-gray-600"><span>${item.Id} (${item.PublicIp})</span><span class="px-2 py-0.5 text-xs font-semibold rounded-full ${stateClass}">${item.State}</span></li>`;
                        });
                    } else {
                        items.forEach(item => { html += `<li class="text-gray-600 list-disc list-inside">${item}</li>`; });
                    }
                    html += '</ul></div>';
                });
            }

            html += '</div>';
            return html;
        };

        const renderNetworkPortsTable = (ports) => {
            if (!ports || ports.length === 0) {
                return `<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">¡Excelente! No se encontraron puertos de red públicamente expuestos.</p></div>`;
            }

            let tableHtml = `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo Recurso</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID Recurso</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Protocolo</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rango Puertos</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descripción</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">`;

            ports.sort((a,b) => a.Region.localeCompare(b.Region)).forEach(p => {
                const protocol = p.Protocol === "-1" ? "Todos" : p.Protocol;
                tableHtml += `<tr class="hover:bg-gray-50">
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${p.Region}</td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${p.ResourceType}</td>
                                <td class="px-4 py-4 text-sm text-gray-600 break-all font-mono">${p.ResourceId}</td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${protocol.toString().toUpperCase()}</td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${p.PortRange}</td>
                                <td class="px-4 py-4 text-sm text-gray-600 break-words">${p.Description}</td>
                              </tr>`;
            });

            tableHtml += `</tbody></table></div>`;
            return tableHtml;
        };

        // --- SECCIÓN DE GUARDDUTY ---
        const buildGuarddutyView = () => {
            const container = document.getElementById('guardduty-view');
            if (!guarddutyApiData) return;
            const { status, findings } = guarddutyApiData.results;

            // --- INICIO DE LA MODIFICACIÓN: Se añade el HTML para los filtros y un contenedor para la tabla ---
            container.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-[#204071]">GuardDuty Status & Findings</h2>
                        <p class="text-sm text-gray-500">${guarddutyApiData.metadata.executionDate}</p>
                    </div>
                </header>
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex flex-wrap space-x-6" id="guardduty-tabs">
                        <a href="#" data-tab="gd-status-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">Status per Region</a>
                        <a href="#" data-tab="gd-findings-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Findings</a>
                    </nav>
                </div>
                <div id="guardduty-tab-content-container">
                    <div id="gd-status-content" class="guardduty-tab-content">${renderGuarddutyStatusTable(status)}</div>
                    <div id="gd-findings-content" class="guardduty-tab-content hidden">
                        <div id="gd-filter-controls" class="flex flex-wrap items-center gap-2 mb-4">
                            <span class="text-sm font-medium text-gray-700 mr-2">Filtrar por severidad:</span>
                            <button data-severity="ALL" class="gd-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-[#eb3496] text-white">Todos</button>
                            <button data-severity="CRITICAL" class="gd-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">Critical</button>
                            <button data-severity="HIGH" class="gd-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">High</button>
                            <button data-severity="MEDIUM" class="gd-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">Medium</button>
                            <button data-severity="LOW" class="gd-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">Low</button>
                        </div>
                        <div id="gd-findings-table-container"></div>
                    </div>
                </div>
            `;

            const tabsNav = container.querySelector('#guardduty-tabs');
            if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.guardduty-tab-content'));
            
            // Llamamos a la nueva función que manejará la lógica del filtro.
            setupGuarddutyFindingsFilter();
        };  

        const renderGuarddutyStatusTable = (statusList) => {
            // --- AÑADIDO: Filtramos la lista para quedarnos solo con las regiones habilitadas ---
            const activeRegions = statusList.filter(s => s.Status === 'Habilitado');

            // --- MODIFICADO: Comprobamos si la lista FILTRADA está vacía ---
            if (!activeRegions || activeRegions.length === 0) {
                return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">GuardDuty no está habilitado en ninguna de las regiones analizadas.</p></div>';
            }
            
            let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Region</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">S3 Logs</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kubernetes Logs</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Malware Protection</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            
            // --- MODIFICADO: Iteramos sobre la lista FILTRADA ---
            activeRegions.forEach(s => {
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${s.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${createStatusBadge(s.Status)}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${createStatusBadge(s['S3 Logs'])}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${createStatusBadge(s['Kubernetes Logs'])}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${createStatusBadge(s['Malware Protection'])}</td>
                         </tr>`;
            });
            table += '</tbody></table></div>';
            return table;
        };


        const renderGuarddutyFindingsTable = (findings) => { if (!findings || findings.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron findings de GuardDuty activos.</p></div>'; const severityClasses = { 'CRITICAL': 'bg-red-600 text-white', 'HIGH': 'bg-orange-500 text-white', 'MEDIUM': 'bg-yellow-400 text-black', 'LOW': 'bg-blue-500 text-white', 'INFORMATIONAL': 'bg-gray-400 text-white' }; let tableHtml = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' + '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Severity</th>' + '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Region</th>' + '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>' + '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Resource</th>' + '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Seen</th>' + '</tr></thead><tbody class="bg-white divide-y divide-gray-200">'; findings.forEach(f => { const severity = f.SeverityLabel || 'N/A'; const severityClass = severityClasses[severity] || 'bg-gray-200 text-gray-800'; tableHtml += `<tr class="hover:bg-gray-50"> <td class="px-4 py-4 whitespace-nowrap"><span class="px-2.5 py-0.5 text-xs font-semibold rounded-full ${severityClass}">${severity} (${f.SeverityScore})</span></td> <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${f.Region}</td> <td class="px-4 py-4 text-sm text-gray-800 break-words">${f.Title}</td> <td class="px-4 py-4 text-sm text-gray-600 break-words">${f.Resource}</td> <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${f.LastSeen}</td> </tr>`; }); tableHtml += '</tbody></table></div>'; return tableHtml; };

        const setupGuarddutyFindingsFilter = () => {
            const allFindings = guarddutyApiData.results.findings;
            const filterControlsContainer = document.getElementById('gd-filter-controls');
            const tableContainer = document.getElementById('gd-findings-table-container');

            if (!filterControlsContainer || !tableContainer) return;

            // Función para renderizar la tabla con los findings filtrados
            const renderFilteredFindings = (severity) => {
                let filteredFindings = allFindings;
                if (severity !== 'ALL') {
                    // El campo de severidad en GuardDuty es 'SeverityLabel'
                    filteredFindings = allFindings.filter(f => f.SeverityLabel === severity);
                }
                // Usamos la función que ya existía para renderizar la tabla
                tableContainer.innerHTML = renderGuarddutyFindingsTable(filteredFindings);
            };

            // Añadir el listener a los botones
            filterControlsContainer.addEventListener('click', (e) => {
                const filterBtn = e.target.closest('.gd-filter-btn');
                if (!filterBtn) return;

                // Actualizar estilos de los botones
                filterControlsContainer.querySelectorAll('.gd-filter-btn').forEach(btn => {
                    btn.classList.remove('bg-[#eb3496]', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-50');
                });
                filterBtn.classList.add('bg-[#eb3496]', 'text-white');
                filterBtn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-50');
                
                // Renderizar la tabla con el filtro aplicado
                const selectedSeverity = filterBtn.dataset.severity;
                renderFilteredFindings(selectedSeverity);
            });

            // Renderizado inicial (mostrar todos los findings)
            renderFilteredFindings('ALL');
        };


        // --- SECCIÓN DE WAF ---
        const buildWafView = () => {
            const container = document.getElementById('waf-view');
            if (!wafApiData || !securityHubApiData) return;
            
            const { acls, ip_sets } = wafApiData.results;
            const wafFindings = securityHubApiData.results.findings.wafFindings;

            container.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-[#204071]">WAF & Shield</h2>
                        <p class="text-sm text-gray-500">${wafApiData.metadata.executionDate}</p>
                    </div>
                </header>
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex flex-wrap space-x-6" id="waf-tabs">
                        <a href="#" data-tab="waf-summary-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">Resumen</a>
                        <a href="#" data-tab="waf-acls-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Web ACLs (${acls.length})</a>
                        <a href="#" data-tab="waf-ipsets-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">IP Sets (${ip_sets.length})</a>
                        <a href="#" data-tab="waf-sh-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Security Hub (${wafFindings.length})</a>
                    </nav>
                </div>
                <div id="waf-tab-content-container">
                    <div id="waf-summary-content" class="waf-tab-content">${createWafSummaryCardsHtml()}</div>
                    <div id="waf-acls-content" class="waf-tab-content hidden">${renderWafAclsTable(acls)}</div>
                    <div id="waf-ipsets-content" class="waf-tab-content hidden">${renderWafIpSetsTable(ip_sets)}</div>
                    <div id="waf-sh-content" class="waf-tab-content hidden">${createWafSecurityHubHtml()}</div>
                </div>
            `;
            
            updateWafSummaryCards(acls, ip_sets, wafFindings);
            renderSecurityHubFindings(wafFindings, 'sh-waf-findings-container', 'No se encontraron findings de Security Hub relacionados com WAF.');
            
            const tabsNav = container.querySelector('#waf-tabs');
            if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.waf-tab-content'));
        };

        const createWafSummaryCardsHtml = () => `
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-5 mb-8">
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">WAF Habilitado</p></div><div class="flex justify-between items-end pt-4"><div id="waf-enabled-status" class="text-2xl font-bold text-gray-800">--</div><div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-blue-600" viewBox="0 0 16 16"><path d="M0 .5A.5.5 0 0 1 .5 0h15a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5H14v2h1.5a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5H14v2h1.5a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5H2v-2H.5a.5.5 0 0 1-.5-.5v-3A.5.5 0 0 1 .5 6H2V4H.5a.5.5 0 0 1-.5-.5zM3 4v2h4.5V4zm5.5 0v2H13V4zM3 10v2h4.5v-2zm5.5 0v2H13v-2zM1 1v2h3.5V1zm4.5 0v2h5V1zm6 0v2H15V1zM1 7v2h3.5V7zm4.5 0v2h5V7zm6 0v2H15V7zM1 13v2h3.5v-2zm4.5 0v2h5v-2zm6 0v2H15v-2z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Nº Web ACLs</p></div><div class="flex justify-between items-end pt-4"><p id="waf-acl-count" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-blue-600" viewBox="0 0 16 16"><path d="M8 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3m0 4a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3m1.5 2.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/><path d="M4 2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2h2c-.167.5-.8 1.6-2 2v2h2c-.167.5-.8 1.6-2 2v2h2c-.167.5-.8 1.6-2 2v1a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-1c-1.2-.4-1.833-1.5-2-2h2V8c-1.2-.4-1.833-1.5-2-2h2V4c-1.2-.4-1.833-1.5-2-2zm2-1a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Nº IP Sets</p></div><div class="flex justify-between items-end pt-4"><p id="waf-ipset-count" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-blue-600" viewBox="0 0 16 16"><path d="M15 8a6.97 6.97 0 0 0-1.71-4.584l-9.874 9.875A7 7 0 0 0 15 8M2.71 12.584l9.874-9.875a7 7 0 0 0-9.874 9.874ZM16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Recursos Protegidos</p></div><div class="flex justify-between items-end pt-4"><p id="waf-protected-resources" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box w-6 h-6 text-blue-600" viewBox="0 0 16 16">  <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5 8 5.961 14.154 3.5zM15 4.239l-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Findings (Crit/High)</p></div><div class="flex justify-between items-end pt-4"><p id="waf-critical-findings" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-orange-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-orange-600" viewBox="0 0 16 16"> <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/></svg></div></div></div>
            </div>`;

        const updateWafSummaryCards = (acls, ipSets, wafFindings) => {
            const aclCount = acls.length;
            document.getElementById('waf-acl-count').textContent = aclCount;
            document.getElementById('waf-ipset-count').textContent = ipSets.length;
            const protectedResources = acls.reduce((sum, acl) => sum + (acl.AssociatedResourceArns?.length || 0), 0);
            document.getElementById('waf-protected-resources').textContent = protectedResources;
            const criticalHighFindings = wafFindings.filter(f => f.Severity?.Label === 'CRITICAL' || f.Severity?.Label === 'HIGH').length;
            document.getElementById('waf-critical-findings').textContent = criticalHighFindings;
            const statusEl = document.getElementById('waf-enabled-status');
            if (aclCount > 0) {
                const scopes = new Set(acls.map(acl => acl.Scope));
                let scopeText = '';
                if (scopes.has('CLOUDFRONT') && scopes.has('REGIONAL')) { scopeText = 'Global & Regional'; } else if (scopes.has('CLOUDFRONT')) { scopeText = 'Global (CloudFront)'; } else if (scopes.has('REGIONAL')) { scopeText = 'Regional'; }
                statusEl.innerHTML = `<div class="flex items-center space-x-2"><span class="px-2.5 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800">Sí</span> <span class="text-gray-500 text-sm">(${scopeText})</span></div>`;
            } else { statusEl.innerHTML = `<span class="px-2.5 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800">No</span>`; }
        };

        const createWafSecurityHubHtml = () => `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 class="font-bold text-lg mb-4 text-[#204071]">Findings de Seguridad Activos (WAF)</h3><div id="sh-waf-findings-container" class="overflow-x-auto"></div></div>`;
        const renderWafAclsTable = (acls) => { if (!acls || acls.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron Web ACLs en la cuenta.</p></div>'; let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ámbito</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Recursos Protegidos</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">'; acls.sort((a,b) => a.Name.localeCompare(b.Name)).forEach(acl => { let resourcesHtml = '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">No hay recursos asociados</span>'; if (acl.AssociatedResourceArns && acl.AssociatedResourceArns.length > 0) { resourcesHtml = `<div class="flex flex-col space-y-1">` + acl.AssociatedResourceArns.map(arn => `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 font-mono">${arn}</span>`).join('') + `</div>`; } table += `<tr class="hover:bg-gray-50"><td class="px-4 py-4 align-top whitespace-nowrap text-sm font-medium text-gray-800">${acl.Name}</td><td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${acl.Scope}</td><td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${acl.Region}</td><td class="px-4 py-4 align-top text-sm">${resourcesHtml}</td></tr>`; }); table += '</tbody></table></div>'; return table; };
        const renderWafIpSetsTable = (ipSets) => { if (!ipSets || ipSets.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron IP Sets en la cuenta.</p></div>'; let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ámbito</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Versión IP</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nº Direcciones</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">'; ipSets.sort((a,b) => a.Name.localeCompare(b.Name)).forEach(ipSet => { table += `<tr class="hover:bg-gray-50"> <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${ipSet.Name}</td> <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${ipSet.Scope}</td> <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${ipSet.Region}</td> <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${ipSet.IPAddressVersion}</td> <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${ipSet.AddressCount}</td> </tr>`; }); table += '</tbody></table></div>'; return table; };

        // --- SECCIÓN DE CLOUDTRAIL ---
        
        const buildCloudtrailView = () => {
            const container = document.getElementById('cloudtrail-view'); if (!cloudtrailApiData || !securityHubApiData) return;
            const { trails, events } = cloudtrailApiData.results; const cloudtrailFindings = securityHubApiData.results.findings.cloudtrailFindings;
            
            // Extraemos todas las regiones únicas de los trails para usarlas en los filtros
            const allRegions = allAvailableRegions;

            container.innerHTML = `<header class="flex justify-between items-center mb-6"><div><h2 class="text-2xl font-bold text-[#204071]">CloudTrail Analysis</h2><p class="text-sm text-gray-500">${cloudtrailApiData.metadata.executionDate}</p></div></header><div class="border-b border-gray-200 mb-6"><nav class="-mb-px flex flex-wrap space-x-6" id="cloudtrail-tabs"><a href="#" data-tab="ct-summary-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">Resumen</a><a href="#" data-tab="ct-trails-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Trails (${trails.length})</a><a href="#" data-tab="ct-events-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Eventos (${events.length})</a><a href="#" data-tab="ct-lookup-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Buscador de logs</a><a href="#" data-tab="ct-sh-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Security Hub (${cloudtrailFindings.length})</a></nav></div><div id="cloudtrail-tab-content-container"><div id="ct-summary-content" class="cloudtrail-tab-content">${createCloudtrailSummaryCardsHtml()}</div><div id="ct-trails-content" class="cloudtrail-tab-content hidden">${renderCloudtrailTrailsView(trails)}</div><div id="ct-events-content" class="cloudtrail-tab-content hidden">${renderCloudtrailEventsTable(events)}</div><div id="ct-lookup-content" class="cloudtrail-tab-content hidden"></div><div id="ct-sh-content" class="cloudtrail-tab-content hidden">${createCloudtrailSecurityHubHtml()}</div></div>`;
            
            updateCloudtrailSummaryCards(trails, events); 
            renderSecurityHubFindings(cloudtrailFindings, 'sh-cloudtrail-findings-container', 'No se encontraron findings de Security Hub para CloudTrail.');
            
            // Renderizamos la vista del nuevo buscador
            const lookupContainer = document.getElementById('ct-lookup-content');
            lookupContainer.innerHTML = renderCloudtrailLookUpView(allRegions);

            // Añadimos el listener para el botón de búsqueda
            const lookupBtn = lookupContainer.querySelector('#ct-run-lookup-btn');
            if(lookupBtn) lookupBtn.addEventListener('click', runCloudtrailLookupAnalysis);

            const tabsNav = container.querySelector('#cloudtrail-tabs'); 
            if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.cloudtrail-tab-content'));
        };

        const createCloudtrailSummaryCardsHtml = () => `
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-5 mb-8">
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Total Trails</p></div><div class="flex justify-between items-end pt-4"><p id="ct-total-trails" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-blue-600" viewBox="0 0 16 16"><path d="M7.05 11.885c0 1.415-.548 2.206-1.524 2.206C4.548 14.09 4 13.3 4 11.885c0-1.412.548-2.203 1.526-2.203.976 0 1.524.79 1.524 2.203m-1.524-1.612c-.542 0-.832.563-.832 1.612q0 .133.006.252l1.559-1.143c-.126-.474-.375-.72-.733-.72zm-.732 2.508c.126.472.372.718.732.718.54 0 .83-.563.83-1.614q0-.129-.006-.25zm6.061.624V14h-3v-.595h1.181V10.5h-.05l-1.136.747v-.688l1.19-.786h.69v3.633z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Trails Activos</p></div><div class="flex justify-between items-end pt-4"><p id="ct-active-trails" class="text-3xl font-bold text-green-600">--</p><div class="bg-green-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-green-600" viewBox="0 0 16 16"><path d="M7.05 11.885c0 1.415-.548 2.206-1.524 2.206C4.548 14.09 4 13.3 4 11.885c0-1.412.548-2.203 1.526-2.203.976 0 1.524.79 1.524 2.203m-1.524-1.612c-.542 0-.832.563-.832 1.612q0 .133.006.252l1.559-1.143c-.126-.474-.375-.72-.733-.72zm-.732 2.508c.126.472.372.718.732.718.54 0 .83-.563.83-1.614q0-.129-.006-.25zm6.061.624V14h-3v-.595h1.181V10.5h-.05l-1.136.747v-.688l1.19-.786h.69v3.633z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Trails Inactivos</p></div><div class="flex justify-between items-end pt-4"><p id="ct-inactive-trails" class="text-3xl font-bold text-red-600">--</p><div class="bg-red-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-red-600" viewBox="0 0 16 16"><path d="M7.05 11.885c0 1.415-.548 2.206-1.524 2.206C4.548 14.09 4 13.3 4 11.885c0-1.412.548-2.203 1.526-2.203.976 0 1.524.79 1.524 2.203m-1.524-1.612c-.542 0-.832.563-.832 1.612q0 .133.006.252l1.559-1.143c-.126-.474-.375-.72-.733-.72zm-.732 2.508c.126.472.372.718.732.718.54 0 .83-.563.83-1.614q0-.129-.006-.25zm6.061.624V14h-3v-.595h1.181V10.5h-.05l-1.136.747v-.688l1.19-.786h.69v3.633z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Eventos Encontrados</p></div><div class="flex justify-between items-end pt-4"><p id="ct-total-events" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-orange-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-orange-600" viewBox="0 0 16 16"> <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/></svg></div></div></div>
            </div>`;
        const updateCloudtrailSummaryCards = (trails, events) => { const activeTrails = trails.filter(t => t.IsLogging).length; const inactiveTrails = trails.length - activeTrails; document.getElementById('ct-total-trails').textContent = trails.length; document.getElementById('ct-active-trails').textContent = activeTrails; document.getElementById('ct-inactive-trails').textContent = inactiveTrails; document.getElementById('ct-total-events').textContent = events.length; };
        const createCloudtrailSecurityHubHtml = () => `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 class="font-bold text-lg mb-4 text-[#204071]">Findings de Seguridad Activos (CloudTrail)</h3><div id="sh-cloudtrail-findings-container" class="overflow-x-auto"></div></div>`;
        const renderCloudtrailTrailsView = (trails) => { if (!trails || trails.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron trails de CloudTrail en la cuenta.</p></div>'; let summaryTable = '<h3 class="font-bold text-lg mb-4 text-[#204071]">Resumen de Trails</h3><div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto mb-8"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' + '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>' + '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Home Region</th>' + '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Multi-Región</th>' + '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Logging Status</th>' + '</tr></thead><tbody class="bg-white divide-y divide-gray-200">'; trails.forEach(t => { const loggingStatus = t.IsLogging ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Habilitado</span>` : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Detenido</span>`; summaryTable += `<tr class="hover:bg-gray-50"><td class="px-4 py-4 align-top whitespace-nowrap text-sm font-medium text-gray-800">${t.Name}</td><td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${t.HomeRegion}</td><td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${t.IsMultiRegionTrail ? 'Sí' : 'No'}</td><td class="px-4 py-4 align-top whitespace-nowrap text-sm">${loggingStatus}</td></tr>`; }); summaryTable += '</tbody></table></div>'; let detailsHtml = '<h3 class="font-bold text-lg mb-4 text-[#204071]">Detalles de Configuración por Trail</h3><div class="space-y-6">'; trails.forEach(t => { const validationBadge = t.LogFileValidationEnabled ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Habilitada</span>` : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Deshabilitada</span>`; const kmsBadge = t.KmsKeyId ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Sí</span>` : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">No</span>`; detailsHtml += `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"><h4 class="font-semibold text-md text-[#204071] mb-3 pb-2 border-b">${t.Name}</h4><ul class="space-y-2 text-sm"><li class="flex justify-between"><span class="font-medium text-gray-600">Validación de Integridad:</span><span>${validationBadge}</span></li><li class="flex justify-between"><span class="font-medium text-gray-600">Cifrado con KMS:</span><span>${kmsBadge}</span></li><li class="flex justify-between items-center"><span class="font-medium text-gray-600">Bucket S3:</span><span class="font-mono text-gray-800">${t.S3BucketName || '-'}</span></li><li class="flex justify-between items-center"><span class="font-medium text-gray-600">CloudWatch Log Group:</span><span class="font-mono text-xs text-gray-800">${t.CloudWatchLogsLogGroupArn ? t.CloudWatchLogsLogGroupArn.split(':log-group:')[1] : '-'}</span></li></ul></div>`; }); detailsHtml += '</div>'; return summaryTable + detailsHtml; };
        const renderCloudtrailEventsTable = (events) => { if (!events || events.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron eventos de interés en los últimos 7 días.</p></div>'; let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' + '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>' + '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre Evento</th>' + '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usuario</th>' + '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' + '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP Origen</th>' + '</tr></thead><tbody class="bg-white divide-y divide-gray-200">'; events.forEach(e => { const eventDate = new Date(e.EventTime).toLocaleString(); table += `<tr class="hover:bg-gray-50"> <td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${eventDate}</td> <td class="px-4 py-4 align-top whitespace-nowrap text-sm font-medium text-gray-800">${e.EventName}</td> <td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${e.Username}</td> <td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${e.EventRegion}</td> <td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600 font-mono">${e.SourceIPAddress}</td> </tr>`; }); table += '</tbody></table></div>'; return table; };

        const renderCloudtrailLookUpView = (allRegions) => {
            const regionOptions = allRegions.map(r => `<option value="${r}">${r}</option>`).join('');

            // Fechas por defecto: hoy y hace 7 días
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 7);

            const formatDate = (date) => {
                let d = date.getDate().toString().padStart(2, '0');
                let m = (date.getMonth() + 1).toString().padStart(2, '0');
                let y = date.getFullYear();
                return `${d}-${m}-${y}`;
            }

            return `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-lg mb-4 text-[#204071]">Buscador de Eventos de CloudTrail</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 items-end">
                        <div>
                            <label for="ct-event-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Evento</label>
                            <input type="text" id="ct-event-name" class="bg-gray-50 border border-gray-300 text-[#204071] text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block w-full p-2.5" placeholder="Ej: ConsoleLogin">
                        </div>
                        <div>
                            <label for="ct-start-date" class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
                            <input type="text" id="ct-start-date" value="${formatDate(startDate)}" class="bg-gray-50 border border-gray-300 text-[#204071] text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block w-full p-2.5" placeholder="dd-mm-yyyy">
                        </div>
                        <div>
                            <label for="ct-end-date" class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
                            <input type="text" id="ct-end-date" value="${formatDate(endDate)}" class="bg-gray-50 border border-gray-300 text-[#204071] text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block w-full p-2.5" placeholder="dd-mm-yyyy">
                        </div>
                         <div>
                            <label for="ct-lookup-region" class="block text-sm font-medium text-gray-700 mb-1">Región</label>
                            <select id="ct-lookup-region" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block w-full p-2.5">
                                <option value="">Selecciona una región</option>
                                ${regionOptions}
                            </select>
                        </div>
                    </div>
                    <button id="ct-run-lookup-btn" class="bg-[#204071] text-white px-4 py-2.5 rounded-lg font-bold text-md hover:bg-[#1a335a] transition flex items-center justify-center space-x-2">
                        <span id="ct-lookup-btn-text">Buscar Eventos</span>
                        <div id="ct-lookup-spinner" class="spinner hidden"></div>
                    </button>
                </div>
                <div id="ct-lookup-results-container" class="mt-6"></div>
            `;
        };
        const runCloudtrailLookupAnalysis = async () => {

            log('Iniciando búsqueda de logs en CloudTrail...', 'info');
            const eventName = document.getElementById('ct-event-name').value.trim();
            const startDate = document.getElementById('ct-start-date').value.trim();
            const endDate = document.getElementById('ct-end-date').value.trim();
            const region = document.getElementById('ct-lookup-region').value;
            const resultsContainer = document.getElementById('ct-lookup-results-container');
            resultsContainer.innerHTML = '';

            if (!startDate || !endDate || !region) {
                const msg = 'Los campos de fecha y región son obligatorios.';
                log(msg, 'error');
                resultsContainer.innerHTML = `<p class="text-red-600 font-medium">Error: ${msg}</p>`;
                return;
            }

            const runBtn = document.getElementById('ct-run-lookup-btn');
            const btnText = document.getElementById('ct-lookup-btn-text');
            const spinner = document.getElementById('ct-lookup-spinner');
            
            runBtn.disabled = true;
            spinner.classList.remove('hidden');
            btnText.textContent = 'Buscando...';

            const payload = {
                access_key: accessKeyInput.value.trim(),
                secret_key: secretKeyInput.value.trim(),
                session_token: sessionTokenInput.value.trim() || null,
                event_name: eventName,
                start_date: startDate,
                end_date: endDate,
                region: region
            };

            try {
                const response = await fetch('http://127.0.0.1:5001/api/run-cloudtrail-lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Error desconocido del servidor.');
                }
                
                // --- CAMBIOS CLAVE AQUÍ ---
                // 1. Guardamos los resultados en la variable global que creamos.
                lastCloudtrailLookupResults = data.results.events; 
                
                // 2. Actualizamos el log para usar la nueva variable.
                log(`Búsqueda completada. Encontrados ${lastCloudtrailLookupResults.length} eventos.`, 'success');
                
                // 3. Llamamos a la función de renderizado con los resultados guardados.
                resultsContainer.innerHTML = renderCloudtrailLookupResult(lastCloudtrailLookupResults);

            } catch(e) {
                log(`Error en la búsqueda de logs: ${e.message}`, 'error');
                resultsContainer.innerHTML = `<div class="bg-red-50 text-red-700 p-4 rounded-lg"><h4 class="font-bold">Error</h4><p>${e.message}</p></div>`;
            } finally {
                runBtn.disabled = false;
                spinner.classList.add('hidden');
                btnText.textContent = 'Buscar Eventos';
            }
        };        

        const renderCloudtrailLookupResult = (events) => {
            if (!events) return '';
            if (events.length === 0) {
                return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron eventos que coincidan con los criterios de búsqueda.</p></div>';
            }
            
            let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table id="cloudtrail-lookup-table" class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre Evento</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usuario</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP Origen</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            
            events.forEach(e => {
                const eventDate = new Date(e.EventTime).toLocaleString();
                
                // --- CAMBIOS CLAVE EN ESTA LÍNEA ---
                // Añadimos:
                // 1. Un ID único a la fila para poder seleccionarla.
                // 2. La clase 'cursor-pointer' para que el ratón cambie de forma.
                // 3. El evento onclick que llama a la función de detalles.
                table += `<tr id="event-row-${e.EventId}" class="hover:bg-blue-50 cursor-pointer" onclick="showCloudtrailEventDetails('${e.EventId}')">
                            <td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${eventDate}</td>
                            <td class="px-4 py-4 align-top whitespace-nowrap text-sm font-medium text-gray-800">${e.EventName}</td>
                            <td class="px-4 py-4 align-top text-sm text-gray-600 break-words">${e.Username}</td>
                            <td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${e.EventRegion}</td>
                            <td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600 font-mono">${e.SourceIPAddress}</td>
                          </tr>`;
            });
            table += '</tbody></table></div>';

            // --- CAMBIO CLAVE AQUÍ ---
            // 4. Añadimos el contenedor para los detalles justo después de la tabla.
            const detailContainer = '<div id="ct-event-detail-container" class="mt-6"></div>';

            // 5. Devolvemos la tabla Y el contenedor de detalles.
            return table + detailContainer;
        };
            
        const showCloudtrailEventDetails = (eventId) => {

            if (!lastCloudtrailLookupResults) return;

            // Encontrar el evento completo usando el eventId
            const eventData = lastCloudtrailLookupResults.find(e => e.EventId === eventId);
            if (!eventData) {
                log(`No se encontró el detalle para el evento ${eventId}`, 'error');
                return;
            }

            const detailContainer = document.getElementById('ct-event-detail-container');
            const table = document.getElementById('cloudtrail-lookup-table');

            // Desmarcar cualquier otra fila previamente seleccionada
            if (table) {
                table.querySelectorAll('tr.bg-blue-100').forEach(row => {
                    row.classList.remove('bg-blue-100');
                    row.classList.add('hover:bg-blue-50');
                });
            }

            // Marcar la fila actual como seleccionada
            const currentRow = document.getElementById(`event-row-${eventId}`);
            if (currentRow) {
                currentRow.classList.add('bg-blue-100');
                currentRow.classList.remove('hover:bg-blue-50');
            }
            
            // Formatear y mostrar el JSON del evento
            try {
                const formattedJson = JSON.stringify(JSON.parse(eventData.CloudTrailEvent), null, 2);
                detailContainer.innerHTML = `
                    <h3 class="text-xl font-bold text-[#204071] mb-4">Detalle del Evento: ${eventId}</h3>
                    <pre class="bg-[#204071] text-white p-4 rounded-lg text-xs font-mono overflow-x-auto">${formattedJson}</pre>
                `;
            } catch (e) {
                log('Error al parsear el JSON del evento.', 'error');
                detailContainer.innerHTML = `<p class="text-red-500">No se pudo mostrar el detalle del evento.</p>`;
            }
        };

        // --- SECCIÓN DE CLOUDWATCH & SNS ---
        const buildCloudwatchView = () => {
            const container = document.getElementById('cloudwatch-view'); if (!cloudwatchApiData || !securityHubApiData) return;
            const { alarms, topics } = cloudwatchApiData.results; const cloudwatchFindings = securityHubApiData.results.findings.cloudwatchFindings;
            container.innerHTML = `<header class="flex justify-between items-center mb-6"><div><h2 class="text-2xl font-bold text-[#204071]">Cloudwatch & SNS</h2><p class="text-sm text-gray-500">${cloudwatchApiData.metadata.executionDate}</p></div></header><div class="border-b border-gray-200 mb-6"><nav class="-mb-px flex flex-wrap space-x-6" id="cloudwatch-tabs"><a href="#" data-tab="cw-summary-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">Resumen</a><a href="#" data-tab="cw-alarms-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Alarmas (${alarms.length})</a><a href="#" data-tab="cw-topics-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Topics SNS (${topics.length})</a><a href="#" data-tab="cw-sh-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Security Hub (${cloudwatchFindings.length})</a></nav></div><div id="cloudwatch-tab-content-container"><div id="cw-summary-content" class="cloudwatch-tab-content">${createCloudwatchSummaryCardsHtml()}</div><div id="cw-alarms-content" class="cloudwatch-tab-content hidden">${renderCloudwatchAlarmsTable(alarms)}</div><div id="cw-topics-content" class="cloudwatch-tab-content hidden">${renderCloudwatchTopicsTable(topics)}</div><div id="cw-sh-content" class="cloudwatch-tab-content hidden">${createCloudwatchSecurityHubHtml()}</div></div>`;
            updateCloudwatchSummaryCards(alarms, topics, cloudwatchFindings); renderSecurityHubFindings(cloudwatchFindings, 'sh-cloudwatch-findings-container', 'No se encontraron findings de Security Hub para CloudWatch.');
            const tabsNav = container.querySelector('#cloudwatch-tabs'); if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.cloudwatch-tab-content'));
        };
        const createCloudwatchSummaryCardsHtml = () => `
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-5 mb-8">
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Total Alarmas</p></div><div class="flex justify-between items-end pt-4"><p id="cw-total-alarms" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-blue-600" viewBox="0 0 16 16"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2M8 1.918l-.797.161A4 4 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4 4 0 0 0-3.203-3.92zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5 5 0 0 1 13 6c0 .88.32 4.2 1.22 6"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Alarmas en estado 'ALARM'</p></div><div class="flex justify-between items-end pt-4"><p id="cw-state-alarms" class="text-3xl font-bold text-red-600">--</p><div class="bg-red-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-red-600" viewBox="0 0 16 16"><path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/><path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Topics SNS con Email</p></div><div class="flex justify-between items-end pt-4"><p id="cw-total-topics" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-blue-600" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Hallazgos (Crit/High)</p></div><div class="flex justify-between items-end pt-4"><p id="cw-critical-findings" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-orange-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-orange-600" viewBox="0 0 16 16"> <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/></svg></div></div></div>
            </div>`;
        const updateCloudwatchSummaryCards = (alarms, topics, findings) => { document.getElementById('cw-total-alarms').textContent = alarms.length; document.getElementById('cw-state-alarms').textContent = alarms.filter(a => a.StateValue === 'ALARM').length; document.getElementById('cw-total-topics').textContent = topics.length; const criticalHighFindings = findings.filter(f => f.Severity?.Label === 'CRITICAL' || f.Severity?.Label === 'HIGH').length; document.getElementById('cw-critical-findings').textContent = criticalHighFindings; };
        const createCloudwatchSecurityHubHtml = () => `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 class="font-bold text-lg mb-4 text-[#204071]">Findings de Seguridad Activos (CloudWatch)</h3><div id="sh-cloudwatch-findings-container" class="overflow-x-auto"></div></div>`;
        const renderCloudwatchAlarmsTable = (alarms) => { if (!alarms || alarms.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron alarmas de CloudWatch.</p></div>'; let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre Alarma</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Métrica</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Condición</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones SNS</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">'; alarms.sort((a, b) => a.Region.localeCompare(b.Region) || a.AlarmName.localeCompare(b.AlarmName)).forEach(alarm => { const metric = `${alarm.Namespace}/${alarm.MetricName}`; const condition = `${alarm.ComparisonOperator} ${alarm.Threshold}`; const snsActions = alarm.AlarmActions.filter(a => a.includes("arn:aws:sns")).map(arn => arn.split(':').pop()).join(', ') || '-'; table += `<tr class="hover:bg-gray-50"><td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${alarm.Region}</td><td class="px-4 py-4 align-top whitespace-nowrap text-sm">${createAlarmStateBadge(alarm.StateValue)}</td><td class="px-4 py-4 align-top text-sm font-medium text-gray-800 break-words">${alarm.AlarmName}</td><td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${metric}</td><td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${condition}</td><td class="px-4 py-4 align-top text-sm text-gray-600 break-words">${snsActions}</td></tr>`; }); table += '</tbody></table></div>'; return table; };
        const renderCloudwatchTopicsTable = (topics) => { if (!topics || topics.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron topics de SNS con suscripciones de email.</p></div>'; let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Topic ARN</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Emails Suscritos</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">'; topics.sort((a, b) => a.Region.localeCompare(b.Region) || a.TopicArn.localeCompare(b.TopicArn)).forEach(topic => { const emails = topic.Subscriptions.map(s => s.Endpoint).join(', '); table += `<tr class="hover:bg-gray-50"><td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${topic.Region}</td><td class="px-4 py-4 align-top text-sm font-medium text-gray-800 break-words">${topic.TopicArn}</td><td class="px-4 py-4 align-top text-sm text-gray-600 break-words">${emails}</td></tr>`; }); table += '</tbody></table></div>'; return table; };

        // --- SECCIÓN DE INSPECTOR ---

        const buildInspectorView = () => {
            const container = document.getElementById('inspector-view');
            if (!inspectorApiData) return;

            // Comprobamos si ya tenemos findings de un análisis previo o una importación
            const hasFindings = inspectorApiData.results.findings && inspectorApiData.results.findings.length > 0;

            if (hasFindings) {
                // Si hay findings, dibujamos directamente la vista de resultados
                const findings = inspectorApiData.results.findings;
                const inspectorFindingsSH = securityHubApiData ? securityHubApiData.results.findings.inspectorFindings : [];
                // Creamos una estructura base mínima para que la función de renderizado funcione
                container.innerHTML = `
                    <header class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-[#204071]">Inspector</h2>
                            <p class="text-sm text-gray-500">${inspectorApiData.metadata.executionDate}</p>
                        </div>
                    </header>
                    <div id="inspector-deep-scan-container" class="hidden"></div>
                    <div id="inspector-results-view"></div>
                `;
                renderFullInspectorView(findings, inspectorFindingsSH);

            } else {
                // Si no hay findings, mostramos la vista inicial con el botón
                container.innerHTML = `
                    <header class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-[#204071]">Inspector</h2>
                            <p class="text-sm text-gray-500">${inspectorApiData.metadata.executionDate}</p>
                        </div>
                    </header>
                    <div id="inspector-status-container" class="mb-6">
                        <h3 class="text-xl font-bold text-[#204071] mb-4">Estado del Escaneo por Región</h3>
                        ${renderInspectorStatusTable(inspectorApiData.results.scan_status)}
                    </div>
                    <div id="inspector-deep-scan-container">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 text-center">
                            <p class="text-gray-600 mb-4">La búsqueda de todos los hallazgos de Inspector puede ser un proceso lento. Ejecútalo para obtener un análisis detallado de vulnerabilidades.</p>
                            <button id="run-deep-inspector-scan-btn" class="bg-[#eb3496] text-white px-5 py-2.5 rounded-lg font-bold text-md hover:bg-[#d42c86] transition flex items-center justify-center space-x-2 mx-auto">
                                <span id="deep-inspector-scan-btn-text">Buscar Hallazgos de Inspector</span>
                                <div id="deep-inspector-scan-spinner" class="spinner hidden"></div>
                            </button>
                        </div>
                    </div>
                    <div id="inspector-results-view" class="hidden mt-6"></div>
                `;
                document.getElementById('run-deep-inspector-scan-btn').addEventListener('click', runDeepInspectorAnalysis);
            }
        };

        const runDeepInspectorAnalysis = async () => {
            const runBtn = document.getElementById('run-deep-inspector-scan-btn');
            const btnText = document.getElementById('deep-inspector-scan-btn-text');
            const spinner = document.getElementById('deep-inspector-scan-spinner');

            runBtn.disabled = true;
            spinner.classList.remove('hidden');
            btnText.textContent = 'Buscando Hallazgos...';
            log('Iniciando búsqueda profunda de findings de Inspector...', 'info');

            const payload = {
                access_key: accessKeyInput.value.trim(),
                secret_key: secretKeyInput.value.trim(),
                session_token: sessionTokenInput.value.trim() || null,
            };

            try {
                const response = await fetch('http://127.0.0.1:5001/api/run-inspector-findings-audit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const findingsData = await response.json();
                if (!response.ok) throw new Error(findingsData.error || 'Error del servidor');

                inspectorApiData.results.findings = findingsData.results.findings || [];
                
                const inspectorFindingsSH = securityHubApiData ? securityHubApiData.results.findings.inspectorFindings : [];

                // Ahora simplemente llamamos a la nueva función
                renderFullInspectorView(inspectorApiData.results.findings, inspectorFindingsSH);

                log('Resultados del análisis profundo de Inspector renderizados.', 'success');

            } catch(e) {
                log(`Error en la búsqueda profunda de Inspector: ${e.message}`, 'error');
                const deepScanContainer = document.getElementById('inspector-deep-scan-container');
                deepScanContainer.innerHTML = `<div class="bg-red-50 text-red-700 p-4 rounded-lg"><h4 class="font-bold">Error</h4><p>${e.message}</p></div>`;
            }
        };

        const renderSecurityHubFindingsPage = (tbodyContainer, findings, page, rowsPerPage) => {
            tbodyContainer.innerHTML = '';
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedItems = findings.slice(start, end);

            const severityClasses = { 'CRITICAL': 'bg-red-600 text-white', 'HIGH': 'bg-orange-500 text-white', 'MEDIUM': 'bg-yellow-400 text-black', 'LOW': 'bg-blue-500 text-white', 'INFORMATIONAL': 'bg-gray-400 text-white' };
            let pageHtml = '';
            
            for (const f of paginatedItems) {
                const severity = f.Severity?.Label || 'N/A';
                const severityClass = severityClasses[severity] || 'bg-gray-200 text-gray-800';
                const region = f.Region || 'N/A';
                const title = f.Title || 'Sin título';
                const resourceType = f.Resources?.[0]?.Type || 'N/A';
                pageHtml += `<tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 whitespace-nowrap"><span class="px-2.5 py-0.5 text-xs font-semibold rounded-full ${severityClass}">${severity}</span></td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${region}</td>
                                <td class="px-4 py-2 text-sm text-gray-800 break-words">${title}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${resourceType}</td>
                             </tr>`;
            }
            tbodyContainer.innerHTML = pageHtml;
        };

        const createInspectorSummaryCardsHtml = () => `
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-5 mb-8">
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Regiones Activas</p></div><div class="flex justify-between items-end pt-4"><p id="inspector-active-regions" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-green-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-geo-alt w-6 h-6 text-green-700" viewBox="0 0 16 16">  <path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A32 32 0 0 1 8 14.58a32 32 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10"/>  <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4m0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Recursos Escaneados</p></div><div class="flex justify-between items-end pt-4"><p id="inspector-scanned-resources" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box w-6 h-6 text-blue-600" viewBox="0 0 16 16">  <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5 8 5.961 14.154 3.5zM15 4.239l-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Total Findings</p></div><div class="flex justify-between items-end pt-4"><p id="inspector-total-findings" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search w-6 h-6 text-blue-600" viewBox="0 0 16 16">  <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Findings Críticos</p></div><div class="flex justify-between items-end pt-4"><p id="inspector-critical-findings" class="text-3xl font-bold text-red-600">--</p><div class="bg-red-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle w-6 h-6 text-red-600" viewBox="0 0 16 16">  <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/>  <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Findings Altos</p></div><div class="flex justify-between items-end pt-4"><p id="inspector-high-findings" class="text-3xl font-bold text-orange-500">--</p><div class="bg-orange-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle w-6 h-6 text-orange-600" viewBox="0 0 16 16"> <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/> <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/></svg></div></div></div>
            </div>`;

        const updateInspectorSummaryCards = (scanStatus, findings) => {
            document.getElementById('inspector-active-regions').textContent = scanStatus.length;
            let scannedResourceCount = 0;
            scanStatus.forEach(regionStatus => {
                if (regionStatus.ScanEC2 === 'ENABLED') scannedResourceCount++;
                if (regionStatus.ScanECR === 'ENABLED') scannedResourceCount++;
                if (regionStatus.ScanLambda === 'ENABLED') scannedResourceCount++;
            });
            document.getElementById('inspector-scanned-resources').textContent = scannedResourceCount;
            document.getElementById('inspector-total-findings').textContent = findings.length;
            document.getElementById('inspector-critical-findings').textContent = findings.filter(f => f.severity === 'CRITICAL').length;
            document.getElementById('inspector-high-findings').textContent = findings.filter(f => f.severity === 'HIGH').length;
        };
        
        const createInspectorSecurityHubHtml = () => `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 class="font-bold text-lg mb-4 text-[#204071]">Findings de Seguridad Activos (Inspector vía SH)</h3><div id="sh-inspector-findings-container" class="overflow-x-auto"></div></div>`;

        const renderInspectorStatusTable = (statusList) => {
            if (!statusList || statusList.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">Inspector no está habilitado en ninguna región.</p></div>';
            let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado Inspector</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Escaneo EC2</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Escaneo ECR</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Escaneo Lambda</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            statusList.sort((a, b) => a.Region.localeCompare(b.Region)).forEach(s => {
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${s.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${createStatusBadge(s.InspectorStatus)}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${createStatusBadge(s.ScanEC2)}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${createStatusBadge(s.ScanECR)}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${createStatusBadge(s.ScanLambda)}</td>
                          </tr>`;
            });
            table += '</tbody></table></div>';
            return table;
        };

        const renderInspectorFindingsPage = (tbodyContainer, findings, page, rowsPerPage) => {
            tbodyContainer.innerHTML = '';
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedItems = findings.slice(start, end);

            const severityClasses = { 'CRITICAL': 'bg-red-600 text-white', 'HIGH': 'bg-orange-500 text-white', 'MEDIUM': 'bg-yellow-400 text-black', 'LOW': 'bg-blue-500 text-white', 'INFORMATIONAL': 'bg-gray-400 text-white', 'UNDEFINED': 'bg-gray-400 text-white' };
            let pageHtml = '';

            for (const f of paginatedItems) {
                const severity = f.severity || 'UNDEFINED';
                const severityClass = severityClasses[severity] || 'bg-gray-200 text-gray-800';
                const firstSeen = new Date(f.firstObservedAt).toLocaleDateString();

                // --- INICIO DE LA LÓGICA MEJORADA ---
                const resource = f.resources && f.resources.length > 0 ? f.resources[0] : {};
                const resourceId = resource.id || 'N/A';
                const resourceTypeRaw = resource.type || 'Desconocido';
                const resourceName = resource.tags?.Name || ''; // <-- Leemos el tag 'Name' directamente del JSON

                // Mapeo para nombres amigables
                const typeMap = {
                    'AWS_EC2_INSTANCE': 'Instancia EC2',
                    'AWS_ECR_REPOSITORY': 'Repositorio ECR',
                    'AWS_LAMBDA_FUNCTION': 'Función Lambda'
                };
                const resourceTypeDisplay = typeMap[resourceTypeRaw] || resourceTypeRaw;

                // Construimos el HTML final para la celda
                let resourceDisplay = `
                    <div class="font-semibold text-gray-800">${resourceTypeDisplay}</div>
                `;
                // Añadimos el nombre solo si existe
                if (resourceName) {
                    resourceDisplay += `<div class="text-gray-700">${resourceName}</div>`;
                }
                // Añadimos siempre el ID
                resourceDisplay += `<div class="font-mono text-gray-500 text-xs">${resourceId}</div>`;
                // --- FIN DE LA LÓGICA MEJORADA ---

                pageHtml += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 align-top whitespace-nowrap"><span class="px-2.5 py-0.5 text-xs font-semibold rounded-full ${severityClass}">${severity}</span></td>
                            <td class="px-4 py-4 align-top whitespace-nowrap text-xs text-gray-600">${firstSeen}</td>
                            <td class="px-4 py-4 align-top whitespace-nowrap text-xs text-gray-600">${f.Region}</td>
                            <td class="px-4 py-4 align-top text-xs text-gray-800 break-words">${f.title}</td>
                            <td class="px-4 py-4 align-top whitespace-nowrap text-xs text-gray-600">${f.type}</td>
                            <td class="px-4 py-4 align-top text-xs text-gray-600 break-words">${resourceDisplay}</td>
                        </tr>`;
            }
            tbodyContainer.innerHTML = pageHtml;
        };

        const setupInspectorFindingsFilter = () => {
            const allFindings = inspectorApiData.results.findings;
            const filterControlsContainer = document.getElementById('inspector-filter-controls');
            const tbodyContainer = document.getElementById('inspector-findings-tbody');
            const paginationContainer = document.getElementById('inspector-pagination-controls');

            if (!filterControlsContainer || !tbodyContainer || !paginationContainer) return;

            const renderFilteredInspectorFindings = (severity) => {
                let filteredFindings = allFindings;
                if (severity !== 'ALL') {
                    filteredFindings = allFindings.filter(f => f.severity === severity);
                }
                // Re-inicializamos la paginación con los datos ya filtrados
                setupPagination(paginationContainer, tbodyContainer, filteredFindings, renderInspectorFindingsPage);
            };

            filterControlsContainer.addEventListener('click', (e) => {
                const filterBtn = e.target.closest('.inspector-filter-btn');
                if (!filterBtn) return;

                filterControlsContainer.querySelectorAll('.inspector-filter-btn').forEach(btn => {
                    btn.classList.remove('bg-[#eb3496]', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-50');
                });
                filterBtn.classList.add('bg-[#eb3496]', 'text-white');
                filterBtn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-50');

                const selectedSeverity = filterBtn.dataset.severity;
                renderFilteredInspectorFindings(selectedSeverity);
            });

            // Carga inicial con todos los findings
            renderFilteredInspectorFindings('ALL');
        };

        const renderFullInspectorView = (findings, inspectorFindingsSH) => {
            const resultsContainer = document.getElementById('inspector-results-view');
            const deepScanContainer = document.getElementById('inspector-deep-scan-container');

            deepScanContainer.classList.add('hidden');
            resultsContainer.classList.remove('hidden');

            resultsContainer.innerHTML = `
                <div id="inspector-summary-container">${createInspectorSummaryCardsHtml()}</div>
                <div class="border-b border-gray-200 my-6">
                    <nav class="-mb-px flex flex-wrap space-x-6" id="inspector-tabs-results">
                        <a href="#" data-tab="inspector-findings-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">Findings de Inspector (${findings.length})</a>
                        <a href="#" data-tab="inspector-sh-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Findings vía SH (${inspectorFindingsSH.length})</a>
                    </nav>
                </div>
                <div id="inspector-tab-content-container-results">
                    <div id="inspector-findings-content" class="inspector-tab-content">
                        <div id="inspector-filter-controls" class="flex flex-wrap items-center gap-2 mb-4">
                            <span class="text-sm font-medium text-gray-700 mr-2">Filtrar por severidad:</span>
                            <button data-severity="ALL" class="inspector-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-[#eb3496] text-white">Todos</button>
                            <button data-severity="CRITICAL" class="inspector-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">Critical</button>
                            <button data-severity="HIGH" class="inspector-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">High</button>
                            <button data-severity="MEDIUM" class="inspector-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">Medium</button>
                            <button data-severity="LOW" class="inspector-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">Low</button>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Severidad</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Descubrimiento</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Título</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Recurso Afectado</th>
                                    </tr>
                                </thead>
                                <tbody id="inspector-findings-tbody" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <div id="inspector-pagination-controls" class="mt-4 flex justify-center items-center space-x-2"></div>
                    </div>
                    <div id="inspector-sh-content" class="inspector-tab-content hidden">
                    </div>
                </div>
            `;

            updateInspectorSummaryCards(inspectorApiData.results.scan_status, findings);
            const tabsNav = document.getElementById('inspector-tabs-results');
            if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.inspector-tab-content'));

            setupInspectorFindingsFilter();

            const shFindingsContainer = document.getElementById('inspector-sh-content');
            shFindingsContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Severidad</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Región</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Título</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tipo de Recurso</th></tr></thead><tbody id="sh-inspector-tbody" class="bg-white divide-y divide-gray-200"></tbody></table></div><div id="sh-inspector-pagination-controls" class="mt-4 flex justify-center items-center space-x-2"></div>`;
            setupPagination(document.getElementById('sh-inspector-pagination-controls'), document.getElementById('sh-inspector-tbody'), inspectorFindingsSH, renderSecurityHubFindingsPage);
        };

        // --- SECCIÓN DE ACM ---
        const buildAcmView = () => {
            const container = document.getElementById('acm-view');
            if (!acmApiData || !securityHubApiData) return;

            const { certificates } = acmApiData.results;
            const acmSecurityHubFindings = securityHubApiData.results.findings.cloudwatchFindings.filter(f => f.Title.includes('Certificate') || f.Title.includes('SSL') || f.Title.includes('TLS'));

            container.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-[#204071]">AWS Certificate Manager (ACM)</h2>
                        <p class="text-sm text-gray-500">${acmApiData.metadata.executionDate}</p>
                    </div>
                </header>
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex flex-wrap space-x-6" id="acm-tabs">
                        <a href="#" data-tab="acm-summary-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">Resumen</a>
                        <a href="#" data-tab="acm-certificates-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Certificados (${certificates.length})</a>
                        <a href="#" data-tab="acm-sh-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Security Hub (${acmSecurityHubFindings.length})</a>
                    </nav>
                </div>
                <div id="acm-tab-content-container">
                    <div id="acm-summary-content" class="acm-tab-content">${createAcmSummaryCardsHtml()}</div>
                    <div id="acm-certificates-content" class="acm-tab-content hidden">${renderAcmCertificatesTable(certificates)}</div>
                    <div id="acm-sh-content" class="acm-tab-content hidden">${createAcmSecurityHubHtml()}</div>
                </div>
            `;
            
            updateAcmSummaryCards(certificates, acmSecurityHubFindings);
            renderSecurityHubFindings(acmSecurityHubFindings, 'sh-acm-findings-container', 'No se encontraron findings de Security Hub relacionados con ACM.');

            const tabsNav = container.querySelector('#acm-tabs');
            if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.acm-tab-content'));
        };

        const createAcmSummaryCardsHtml = () => `
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-5 mb-8">
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Total Certificados</p></div><div class="flex justify-between items-end pt-4"><p id="acm-total-certs" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-card-heading w-6 h-6 text-blue-600" viewBox="0 0 16 16">  <path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2z"/>  <path d="M3 8.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m0-5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Certificados Emitidos</p></div><div class="flex justify-between items-end pt-4"><p id="acm-issued-certs" class="text-3xl font-bold text-green-600">--</p><div class="bg-green-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-patch-check w-6 h-6 text-green-600" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10.354 6.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7 8.793l2.646-2.647a.5.5 0 0 1 .708 0z"/><path d="m10.273 2.513-.921-.944.715-.698.622.637.89-.011a2.89 2.89 0 0 1 2.924 2.924l-.01.89.636.622a2.89 2.89 0 0 1 0 4.134l-.637.622.011.89a2.89 2.89 0 0 1-2.924 2.924l-.89-.01-.622.636a2.89 2.89 0 0 1-4.134 0l-.622-.637-.89.01a2.89 2.89 0 0 1-2.924-2.924l.01-.89-.636-.622a2.89 2.89 0 0 1 0-4.134l.637-.622-.011-.89a2.89 2.89 0 0 1 2.924-2.924l.89.01.622-.636a2.89 2.89 0 0 1 4.134 0l-.715.698a1.89 1.89 0 0 0-2.704 0l-.92.944-1.32-.016a1.89 1.89 0 0 0-1.911 1.912l.016 1.318-.944.921a1.89 1.89 0 0 0 0 2.704l.944.92-.016 1.32a1.89 1.89 0 0 0 1.912 1.911l1.318-.016.921.944a1.89 1.89 0 0 0 2.704 0l.92-.944 1.32.016a1.89 1.89 0 0 0 1.911-1.912l-.016-1.318.944-.921a1.89 1.89 0 0 0 0-2.704l-.944-.92.016-1.32a1.89 1.89 0 0 0-1.912-1.911z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Certificados Pendientes</p></div><div class="flex justify-between items-end pt-4"><p id="acm-pending-certs" class="text-3xl font-bold text-yellow-600">--</p><div class="bg-yellow-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clock w-6 h-6 text-yellow-600" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Expirados/Revocados</p></div><div class="flex justify-between items-end pt-4"><p id="acm-expired-revoked-certs" class="text-3xl font-bold text-red-600">--</p><div class="bg-red-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle w-6 h-6 text-red-600" viewBox="0 0 16 16"> <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1-.054-.06.18.18 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/> <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/></svg></div></div></div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full"><div><p class="text-sm text-gray-500">Hallazgos (Crit/High)</p></div><div class="flex justify-between items-end pt-4"><p id="acm-critical-findings" class="text-3xl font-bold text-[#204071]">--</p><div class="bg-orange-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-orange-600" viewBox="0 0 16 16"> <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/></svg></div></div></div>
            </div>`;
        
        const updateAcmSummaryCards = (certificates, securityHubFindings) => {
            document.getElementById('acm-total-certs').textContent = certificates.length;
            document.getElementById('acm-issued-certs').textContent = certificates.filter(c => c.Status === 'ISSUED').length;
            document.getElementById('acm-pending-certs').textContent = certificates.filter(c => c.Status === 'PENDING_VALIDATION').length;
            document.getElementById('acm-expired-revoked-certs').textContent = certificates.filter(c => c.Status === 'EXPIRED' || c.Status === 'REVOKED').length;
            document.getElementById('acm-critical-findings').textContent = securityHubFindings.filter(f => f.Severity?.Label === 'CRITICAL' || f.Severity?.Label === 'HIGH').length;
        };

        const createAcmSecurityHubHtml = () => `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 class="font-bold text-lg mb-4 text-[#204071]">Findings de Seguridad Activos (ACM vía SH)</h3><div id="sh-acm-findings-container" class="overflow-x-auto"></div></div>`;

        const renderAcmCertificatesTable = (certificates) => {
            if (!certificates || certificates.length === 0) {
                return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron certificados ACM.</p></div>';
            }

            const statusColors = {
                'ISSUED': 'bg-green-100 text-green-800',
                'PENDING_VALIDATION': 'bg-yellow-100 text-yellow-800',
                'EXPIRED': 'bg-red-100 text-red-800',
                'REVOKED': 'bg-red-100 text-red-800',
                'INACTIVE': 'bg-gray-100 text-gray-800',
                'VALIDATION_TIMED_OUT': 'bg-red-100 text-red-800',
                'FAILED': 'bg-red-100 text-red-800',
            };

            let tableHtml = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dominio Principal</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Emitido por</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Emisión</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Expiración</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">SANs</th>' +
                            '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            
            certificates.forEach(cert => {
                const domainName = cert.DomainName || 'N/A';
                const region = cert.Region || 'N/A';
                const status = cert.Status || 'N/A';
                const statusClass = statusColors[status] || 'bg-gray-100 text-gray-800';
                const issuer = cert.Issuer || 'N/A';
                const issuedAt = cert.IssuedAt ? new Date(cert.IssuedAt).toLocaleDateString() : 'N/A';
                const expiresAt = cert.NotAfter ? new Date(cert.NotAfter).toLocaleDateString() : 'N/A';
                const sans = cert.SubjectAlternativeNames && cert.SubjectAlternativeNames.length > 0 ? cert.SubjectAlternativeNames.join(', ') : '-';

                tableHtml += `<tr class="hover:bg-gray-50">
                                <td class="px-4 py-4 align-top text-sm font-medium text-gray-800 break-words">${domainName}</td>
                                <td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${region}</td>
                                <td class="px-4 py-4 align-top whitespace-nowrap"><span class="px-2.5 py-0.5 text-xs font-semibold rounded-full ${statusClass}">${status}</span></td>
                                <td class="px-4 py-4 align-top text-sm text-gray-600 break-words">${issuer}</td>
                                <td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${issuedAt}</td>
                                <td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${expiresAt}</td>
                                <td class="px-4 py-4 align-top text-sm text-gray-600 break-words">${sans}</td>
                              </tr>`;
            });
            tableHtml += '</tbody></table></div>';
            return tableHtml;
        };

    // --- SECCIÓN DE COMPUTE ---
        const buildComputeView = () => {
            const container = document.getElementById('compute-view');
            if (!computeApiData) return;

            const { ec2_instances, lambda_functions, eks_clusters, ecs_clusters } = computeApiData.results;
            const allRegions = allAvailableRegions;

            container.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-[#204071]">Compute Resources</h2>
                        <p class="text-sm text-gray-500">${computeApiData.metadata.executionDate}</p>
                    </div>
                </header>
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex flex-wrap space-x-6" id="compute-tabs">
                        <a href="#" data-tab="compute-summary-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">Resumen</a>
                        <a href="#" data-tab="compute-ec2-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">EC2 (${ec2_instances.length})</a>
                        <a href="#" data-tab="compute-lambda-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Lambda (${lambda_functions.length})</a>
                        <a href="#" data-tab="compute-eks-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">EKS (${eks_clusters.length})</a>
                        <a href="#" data-tab="compute-ecs-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">ECS (${ecs_clusters.length})</a>
                    </nav>
                </div>
                <div id="compute-tab-content-container">
                    <div id="compute-summary-content" class="compute-tab-content">${createComputeSummaryCardsHtml()}</div>
                    <div id="compute-ec2-content" class="compute-tab-content hidden"></div>
                    <div id="compute-lambda-content" class="compute-tab-content hidden">${renderLambdaFunctionsTable(lambda_functions)}</div>
                    <div id="compute-eks-content" class="compute-tab-content hidden">${renderEksClustersTable(eks_clusters)}</div>
                    <div id="compute-ecs-content" class="compute-tab-content hidden">${renderEcsClustersTable(ecs_clusters)}</div>
                </div>
            `;
            
            updateComputeSummaryCards(ec2_instances, lambda_functions, eks_clusters, ecs_clusters);
            
            const ec2TabContent = document.getElementById('compute-ec2-content');
            // Render inicial de la tabla con todos los datos
            ec2TabContent.innerHTML = renderEc2InstancesTable(ec2_instances, allRegions, 'all', 'all');

            // Lógica unificada para manejar ambos filtros
            const handleFilterChange = () => {
                const selectedState = ec2TabContent.querySelector('.ec2-filter-btn.bg-\\[\\#eb3496\\]')?.dataset.state || 'all';
                const selectedRegion = ec2TabContent.querySelector('#ec2-region-filter').value;

                let filteredInstances = ec2_instances;

                if (selectedState !== 'all') {
                    filteredInstances = filteredInstances.filter(instance => instance.State.toLowerCase() === selectedState);
                }

                if (selectedRegion !== 'all') {
                    filteredInstances = filteredInstances.filter(instance => instance.Region === selectedRegion);
                }
                
                ec2TabContent.innerHTML = renderEc2InstancesTable(filteredInstances, allRegions, selectedState, selectedRegion);
            };

            ec2TabContent.addEventListener('click', (e) => {
                const filterBtn = e.target.closest('.ec2-filter-btn');
                if (!filterBtn) return;
                
                // Actualiza el estado visual del botón presionado
                ec2TabContent.querySelectorAll('.ec2-filter-btn').forEach(btn => {
                    btn.classList.remove('bg-[#eb3496]', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-50');
                });
                filterBtn.classList.add('bg-[#eb3496]', 'text-white');
                filterBtn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-50');

                handleFilterChange();
            });

            ec2TabContent.addEventListener('change', (e) => {
                if (e.target.id === 'ec2-region-filter') {
                    handleFilterChange();
                }
            });

            const tabsNav = container.querySelector('#compute-tabs');
            if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.compute-tab-content'));
        };

        const createComputeSummaryCardsHtml = () => `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full">
                    <div><p class="text-sm text-gray-500">Instancias EC2</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="compute-total-ec2" class="text-3xl font-bold text-[#204071]">--</p>
                        <div class="bg-orange-100 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-orange-600" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5 0a.5.5 0 0 1 .5.5V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2A2.5 2.5 0 0 1 14 4.5h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14a2.5 2.5 0 0 1-2.5 2.5v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14A2.5 2.5 0 0 1 2 11.5H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2A2.5 2.5 0 0 1 4.5 2V.5A.5.5 0 0 1 5 0m-.5 3A1.5 1.5 0 0 0 3 4.5v7A1.5 1.5 0 0 0 4.5 13h7a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 11.5 3zM5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5zM6.5 6a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full">
                    <div><p class="text-sm text-gray-500">Funciones Lambda</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="compute-total-lambda" class="text-3xl font-bold text-[#204071]">--</p>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                                <path d="M6.854 4.646a.5.5 0 0 1 0 .708L4.207 8l2.647 2.646a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 0 1 .708 0m2.292 0a.5.5 0 0 0 0 .708L11.793 8l-2.647 2.646a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708 0"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full">
                    <div><p class="text-sm text-gray-500">Clusters EKS</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="compute-total-eks" class="text-3xl font-bold text-[#204071]">--</p>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M7.752.066a.5.5 0 0 1 .496 0l3.75 2.143a.5.5 0 0 1 .252.434v3.995l3.498 2A.5.5 0 0 1 16 9.07v4.286a.5.5 0 0 1-.252.434l-3.75 2.143a.5.5 0 0 1-.496 0l-3.502-2-3.502 2.001a.5.5 0 0 1-.496 0l-3.75-2.143A.5.5 0 0 1 0 13.357V9.071a.5.5 0 0 1 .252-.434L3.75 6.638V2.643a.5.5 0 0 1 .252-.434zM4.25 7.504 1.508 9.071l2.742 1.567 2.742-1.567zM7.5 9.933l-2.75 1.571v3.134l2.75-1.571zm1 3.134 2.75 1.571v-3.134L8.5 9.933zm.508-3.996 2.742 1.567 2.742-1.567-2.742-1.567zm2.242-2.433V3.504L8.5 5.076V8.21zM7.5 8.21V5.076L4.75 3.504v3.134zM5.258 2.643 8 4.21l2.742-1.567L8 1.076zM15 9.933l-2.75 1.571v3.134L15 13.067zM3.75 14.638v-3.134L1 9.933v3.134z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full">
                    <div><p class="text-sm text-gray-500">Clusters ECS</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="compute-total-ecs" class="text-3xl font-bold text-[#204071]">--</p>
                        <div class="bg-green-100 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M7.752.066a.5.5 0 0 1 .496 0l3.75 2.143a.5.5 0 0 1 .252.434v3.995l3.498 2A.5.5 0 0 1 16 9.07v4.286a.5.5 0 0 1-.252.434l-3.75 2.143a.5.5 0 0 1-.496 0l-3.502-2-3.502 2.001a.5.5 0 0 1-.496 0l-3.75-2.143A.5.5 0 0 1 0 13.357V9.071a.5.5 0 0 1 .252-.434L3.75 6.638V2.643a.5.5 0 0 1 .252-.434zM4.25 7.504 1.508 9.071l2.742 1.567 2.742-1.567zM7.5 9.933l-2.75 1.571v3.134l2.75-1.571zm1 3.134 2.75 1.571v-3.134L8.5 9.933zm.508-3.996 2.742 1.567 2.742-1.567-2.742-1.567zm2.242-2.433V3.504L8.5 5.076V8.21zM7.5 8.21V5.076L4.75 3.504v3.134zM5.258 2.643 8 4.21l2.742-1.567L8 1.076zM15 9.933l-2.75 1.571v3.134L15 13.067zM3.75 14.638v-3.134L1 9.933v3.134z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>`;

        const updateComputeSummaryCards = (ec2s, lambdas, eks, ecs) => {
            document.getElementById('compute-total-ec2').textContent = ec2s.length;
            document.getElementById('compute-total-lambda').textContent = lambdas.length;
            document.getElementById('compute-total-eks').textContent = eks.length;
            document.getElementById('compute-total-ecs').textContent = ecs.length;
        };
  
        const renderEc2InstancesTable = (instances, allRegions, selectedState = 'all', selectedRegion = 'all') => {
            
            const regionOptions = allRegions.map(r => `<option value="${r}" ${selectedRegion === r ? 'selected' : ''}>${r}</option>`).join('');

            const filterControlsHtml = `
                <div class="mb-4 flex flex-wrap gap-4 items-center">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-700">Estado:</span>
                        <div class="flex space-x-2">
                            <button data-state="all" class="ec2-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm ${selectedState === 'all' ? 'bg-[#eb3496] text-white' : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'}">Todos</button>
                            <button data-state="running" class="ec2-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm ${selectedState === 'running' ? 'bg-[#eb3496] text-white' : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'}">Running</button>
                            <button data-state="stopped" class="ec2-filter-btn px-3 py-1 text-sm font-semibold rounded-md shadow-sm ${selectedState === 'stopped' ? 'bg-[#eb3496] text-white' : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'}">Stopped</button>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="ec2-region-filter" class="text-sm font-medium text-gray-700">Región:</label>
                        <select id="ec2-region-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block p-1.5">
                            <option value="all" ${selectedRegion === 'all' ? 'selected' : ''}>Todas las Regiones</option>
                            ${regionOptions}
                        </select>
                    </div>
                </div>`;
            
            if (!instances || instances.length === 0) {
                return `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">${filterControlsHtml}<p class="text-center text-gray-500 py-4">No se encontraron instancias EC2 con los filtros seleccionados.</p></div>`;
            }

            let tableContent = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID Instancia</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP Pública</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sistema Operativo</th>' +
                        '<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ARN</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tags</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            
            instances.forEach(i => {
                const tagsStr = Object.entries(i.Tags).map(([k, v]) => `${k}:${v}`).join(', ') || '-';
                tableContent += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${i.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${i.InstanceId}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${i.InstanceType}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${createStatusBadge(i.State)}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${i.PublicIpAddress || '-'}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 break-words">${i.OperatingSystem}</td>
                            <td class="px-4 py-4 text-center">
                                <button 
                                    onclick="copyToClipboard(this, '${i.ARN}')" 
                                    title="${i.ARN}" 
                                    class="p-1 rounded-md hover:bg-gray-200 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard w-5 h-5 text-gray-500" viewBox="0 0 16 16">
                                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
                                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
                                    </svg>
                                </button>
                            </td>
                            <td class="px-4 py-4 text-sm text-gray-600 break-all">${tagsStr}</td>
                        </tr>`;
            });
            tableContent += '</tbody></table></div>';
            
            return `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">${filterControlsHtml}${tableContent}</div>`;
        };

        const renderLambdaFunctionsTable = (functions) => {
            if (!functions || functions.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron funciones Lambda.</p></div>';
            let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre Función</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Runtime</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ARN</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            functions.forEach(f => {
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${f.Region}</td>
                            <td class="px-4 py-4 text-sm font-medium text-gray-800 break-all">${f.FunctionName}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${f.Runtime}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 break-all font-mono">${f.ARN}</td>
                        </tr>`;
            });
            table += '</tbody></table></div>';
            return table;
        };

        const renderEksClustersTable = (clusters) => {
            if (!clusters || clusters.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron clusters EKS.</p></div>';
            let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre Cluster</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ARN</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            clusters.forEach(c => {
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${c.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${c.ClusterName}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 break-all font-mono">${c.ARN}</td>
                        </tr>`;
            });
            table += '</tbody></table></div>';
            return table;
        };

        const renderEcsClustersTable = (clusters) => {
            if (!clusters || clusters.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron clusters ECS.</p></div>';
            let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre Cluster</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nº Servicios</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ARN</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            clusters.forEach(c => {
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${c.Region}</td>
                            <td class="px-4 py-4 text-sm font-medium text-gray-800 break-all">${c.ClusterName}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${createStatusBadge(c.Status)}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${c.ServicesCount}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 break-all font-mono">${c.ARN}</td>
                        </tr>`;
            });
            table += '</tbody></table></div>';
            return table;
        };
        
        
        // --- SECCIÓN DE NETWORK POLICIES ---
        const buildNetworkPoliciesView = () => {
            const container = document.getElementById('network-policies-view');
            if (!networkPoliciesApiData || !computeApiData || !databasesApiData) {
                container.innerHTML = '<p class="text-center text-gray-500">Datos de Network Policies, Compute o Databases no disponibles.</p>';
                return;
            }

            const { vpcs, acls, security_groups, subnets, all_regions } = networkPoliciesApiData.results;
            const { ec2_instances, lambda_functions } = computeApiData.results;
            const { rds_instances, aurora_clusters } = databasesApiData.results;

            const activeRegions = [...new Set(vpcs.map(v => v.Region))].sort();
            const regionOptionsHtml = activeRegions.map(r => `<option value="${r}">${r}</option>`).join('');

            container.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-[#204071]">Network Security Policies</h2>
                        <p class="text-sm text-gray-500">${networkPoliciesApiData.metadata.executionDate}</p>
                    </div>
                </header>
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex flex-wrap space-x-6" id="network-policies-tabs">
                        <a href="#" data-tab="np-summary-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">Resumen</a>
                        <a href="#" data-tab="np-vpcs-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">VPCs (${vpcs.length})</a>
                        <a href="#" data-tab="np-acls-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Network ACLs (${acls.length})</a>
                        <a href="#" data-tab="np-sgs-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Security Groups (${security_groups.length})</a>
                        <a href="#" data-tab="np-detail-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Detalle</a>
                    </nav>
                </div>
                <div id="network-policies-tab-content-container">
                    <div id="np-summary-content" class="network-policies-tab-content">
                        ${createNetworkPoliciesSummaryCardsHtml()}
                        <div id="vpc-diagram-container" class="mt-8">
                            <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                                <h3 class="text-xl font-bold text-[#204071]">Diagrama de Red</h3>
                                <div class="flex items-center gap-x-6 gap-y-2 flex-wrap">
                                    <div class="flex items-center gap-2">
                                        <label for="vpc-diagram-region-filter" class="text-sm font-medium text-gray-700">Filtrar por Región:</label>
                                        <select id="vpc-diagram-region-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block p-1.5">
                                            <option value="all">Todas las Regiones</option>
                                            ${regionOptionsHtml}
                                        </select>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="vpc-diagram-hide-empty-filter" class="h-4 w-4 rounded border-gray-300 text-[#eb3496] focus:ring-[#eb3496]">
                                        <label for="vpc-diagram-hide-empty-filter" class="text-sm font-medium text-gray-700">Ocultar VPCs vacías</label>
                                    </div>
                                </div>
                                </div>
                            <div id="diagram-content-wrapper"></div>
                        </div>
                    </div>
                    <div id="np-vpcs-content" class="network-policies-tab-content hidden"></div>
                    <div id="np-acls-content" class="network-policies-tab-content hidden"></div>
                    <div id="np-sgs-content" class="network-policies-tab-content hidden"></div>
                    <div id="np-detail-content" class="network-policies-tab-content hidden"></div>
                </div>
            `;

            updateNetworkPoliciesSummaryCards(vpcs, acls, security_groups);

            // <-- INICIO: LÓGICA DE FILTRADO ACTUALIZADA -->
            const diagramWrapper = document.getElementById('diagram-content-wrapper');
            const regionFilter = document.getElementById('vpc-diagram-region-filter');
            const hideEmptyFilter = document.getElementById('vpc-diagram-hide-empty-filter'); // Nuevo selector

            // Esta única función ahora se encarga de aplicar AMBOS filtros
            const updateDiagram = () => {
                const selectedRegion = regionFilter.value;
                const hideEmpty = hideEmptyFilter.checked;

                // 1. Filtramos por región (como antes)
                let filteredVpcs = (selectedRegion === 'all')
                    ? vpcs
                    : vpcs.filter(v => v.Region === selectedRegion);

                // 2. Si el checkbox está marcado, aplicamos el segundo filtro
                if (hideEmpty) {
                    filteredVpcs = filteredVpcs.filter(vpc => {
                        // Comprobamos si la VPC tiene al menos un recurso de cualquier tipo
                        const hasEc2 = ec2_instances.some(i => {
                            const subnet = subnets.find(s => s.SubnetId === i.SubnetId);
                            return subnet && subnet.VpcId === vpc.VpcId;
                        });
                        const hasLambda = lambda_functions.some(l => l.VpcConfig && l.VpcConfig.VpcId === vpc.VpcId);
                        const hasRds = rds_instances.some(r => r.VpcId === vpc.VpcId);
                        const hasAurora = aurora_clusters.some(a => a.VpcId === vpc.VpcId);
                        
                        // Si tiene alguno, la incluimos (devolvemos true)
                        return hasEc2 || hasLambda || hasRds || hasAurora;
                    });
                }
                
                // 3. Renderizamos el diagrama con la lista de VPCs ya filtrada
                diagramWrapper.innerHTML = renderVpcDiagram(filteredVpcs, subnets, ec2_instances, lambda_functions, rds_instances, aurora_clusters);
            };

            // Añadimos listeners a AMBOS filtros. Los dos llaman a la misma función.
            if (regionFilter) {
                regionFilter.addEventListener('change', updateDiagram);
            }
            if (hideEmptyFilter) {
                hideEmptyFilter.addEventListener('change', updateDiagram);
            }
            
            // Renderizado inicial al cargar la vista
            updateDiagram();
            // <-- FIN: LÓGICA DE FILTRADO ACTUALIZADA -->
            
            // El resto de la función no cambia
            const vpcsContainer = document.getElementById('np-vpcs-content');
            const aclsContainer = document.getElementById('np-acls-content');
            const sgsContainer = document.getElementById('np-sgs-content');
            const detailContainer = document.getElementById('np-detail-content');
            
            vpcsContainer.innerHTML = renderVPCsTable(vpcs, all_regions, 'all');
            aclsContainer.innerHTML = renderACLsTable(acls, all_regions, 'all');
            sgsContainer.innerHTML = renderSGsTable(security_groups, all_regions, 'all');
            detailContainer.innerHTML = renderNetworkDetailView(all_regions || []);

            container.addEventListener('change', (e) => {
                const selectedRegion = e.target.value;
                switch (e.target.id) {
                    case 'vpc-region-filter':
                        vpcsContainer.innerHTML = renderVPCsTable(vpcs.filter(v => selectedRegion === 'all' || v.Region === selectedRegion), all_regions, selectedRegion);
                        break;
                    case 'acl-region-filter':
                        aclsContainer.innerHTML = renderACLsTable(acls.filter(a => selectedRegion === 'all' || a.Region === selectedRegion), all_regions, selectedRegion);
                        break;
                    case 'sg-region-filter':
                        sgsContainer.innerHTML = renderSGsTable(security_groups.filter(sg => selectedRegion === 'all' || sg.Region === selectedRegion), all_regions, selectedRegion);
                        break;
                }
            });
            
            const detailRunBtn = detailContainer.querySelector('#np-run-detail-btn');
            if(detailRunBtn) detailRunBtn.addEventListener('click', runNetworkDetailAnalysis);

            const tabsNav = container.querySelector('#network-policies-tabs');
            if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.network-policies-tab-content'));
        };


        const createNetworkPoliciesSummaryCardsHtml = () => `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm">
                    <div><p class="text-sm text-gray-500">Total VPCs</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="np-total-vpcs" class="text-3xl font-bold text-[#204071]">--</p>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-blue-600" viewBox="0 0 16 16">
                                <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v4h10V2a1 1 0 0 0-1-1zm9 6H6v2h7zm0 3H6v2h7zm0 3H6v2h6a1 1 0 0 0 1-1zm-8 2v-2H3v1a1 1 0 0 0 1 1zm-2-3h2v-2H3zm0-3h2V7H3z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm">
                    <div><p class="text-sm text-gray-500">VPCs por Defecto</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="np-default-vpcs" class="text-3xl font-bold text-yellow-600">--</p>
                        <div class="bg-orange-100 p-3 rounded-full"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-orange-600" viewBox="0 0 16 16">
                                <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v4h10V2a1 1 0 0 0-1-1zm9 6H6v2h7zm0 3H6v2h7zm0 3H6v2h6a1 1 0 0 0 1-1zm-8 2v-2H3v1a1 1 0 0 0 1 1zm-2-3h2v-2H3zm0-3h2V7H3z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm">
                    <div><p class="text-sm text-gray-500">Total Network ACLs</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="np-total-acls" class="text-3xl font-bold text-[#204071]">--</p>
                        <div class="bg-blue-100 p-3 rounded-full">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-blue-600" viewBox="0 0 16 16">
                                <path d="M12 0H4a2 2 0 0 0-2 2v4h12V2a2 2 0 0 0-2-2m2 7H6v2h8zm0 3H6v2h8zm0 3H6v3h6a2 2 0 0 0 2-2zm-9 3v-3H2v1a2 2 0 0 0 2 2zm-3-4h3v-2H2zm0-3h3V7H2z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm">
                    <div><p class="text-sm text-gray-500">Total Security Groups</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="np-total-sgs" class="text-3xl font-bold text-[#204071]">--</p>
                        <div class="bg-green-100 p-3 rounded-full"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 text-green-600" viewBox="0 0 16 16"> <path d="M12 0H4a2 2 0 0 0-2 2v4h12V2a2 2 0 0 0-2-2m2 7H6v2h8zm0 3H6v2h8zm0 3H6v3h6a2 2 0 0 0 2-2zm-9 3v-3H2v1a2 2 0 0 0 2 2zm-3-4h3v-2H2zm0-3h3V7H2z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>`;
        
        const updateNetworkPoliciesSummaryCards = (vpcs, acls, sgs) => {
            document.getElementById('np-total-vpcs').textContent = vpcs.length;
            document.getElementById('np-default-vpcs').textContent = vpcs.filter(v => v.IsDefault).length;
            document.getElementById('np-total-acls').textContent = acls.length;
            document.getElementById('np-total-sgs').textContent = sgs.length;
        };
  
        const renderVPCsTable = (vpcs, allRegions, selectedRegion = 'all') => {
            const regionOptions = allRegions.map(r => `<option value="${r}" ${selectedRegion === r ? 'selected' : ''}>${r}</option>`).join('');

            const filterControl = `
                <div class="mb-4 flex items-center gap-2">
                    <label for="vpc-region-filter" class="text-sm font-medium text-gray-700">Filtrar por Región:</label>
                    <select id="vpc-region-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block p-1.5">
                        <option value="all">Todas las Regiones</option>
                        ${regionOptions}
                    </select>
                </div>`;

            if (!vpcs || vpcs.length === 0) {
                return `<div class="bg-white p-6 rounded-xl border border-gray-100">${filterControl}<p class="text-center text-gray-500 py-4">No se encontraron VPCs con los filtros seleccionados.</p></div>`;
            }
            
            let table = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">VPC ID</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">CIDR Block</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Por Defecto</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tags</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            vpcs.sort((a,b) => a.Region.localeCompare(b.Region)).forEach(v => {
                const tagsStr = Object.entries(v.Tags).map(([k, val]) => `${k}:${val}`).join(', ') || '-';
                const isDefault = v.IsDefault ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Sí</span>' : 'No';
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${v.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${v.VpcId}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">${v.CidrBlock}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${isDefault}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 break-all">${tagsStr}</td>
                        </tr>`;
            });
            table += '</tbody></table></div>';
            
            return `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">${filterControl}${table}</div>`;
        };

        const renderACLsTable = (acls, allRegions, selectedRegion = 'all') => {
            const regionOptions = allRegions.map(r => `<option value="${r}" ${selectedRegion === r ? 'selected' : ''}>${r}</option>`).join('');

            const filterControl = `
                <div class="mb-4 flex items-center gap-2">
                    <label for="acl-region-filter" class="text-sm font-medium text-gray-700">Filtrar por Región:</label>
                    <select id="acl-region-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block p-1.5">
                        <option value="all">Todas las Regiones</option>
                        ${regionOptions}
                    </select>
                </div>`;

            if (!acls || acls.length === 0) {
                return `<div class="bg-white p-6 rounded-xl border border-gray-100">${filterControl}<p class="text-center text-gray-500 py-4">No se encontraron Network ACLs con los filtros seleccionados.</p></div>`;
            }
            
            let table = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ACL ID</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">VPC ID</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Por Defecto</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tags</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            acls.sort((a,b) => a.Region.localeCompare(b.Region)).forEach(a => {
                const tagsStr = Object.entries(a.Tags).map(([k, val]) => `${k}:${val}`).join(', ') || '-';
                const isDefault = a.IsDefault ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Sí</span>' : 'No';
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${a.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${a.AclId}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${a.VpcId}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${isDefault}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 break-all">${tagsStr}</td>
                        </tr>`;
            });
            table += '</tbody></table></div>';
            
            return `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">${filterControl}${table}</div>`;
        };        

        const renderSGsTable = (sgs, allRegions, selectedRegion = 'all') => {
            const regionOptions = allRegions.map(r => `<option value="${r}" ${selectedRegion === r ? 'selected' : ''}>${r}</option>`).join('');
            
            const filterControl = `
                <div class="mb-4 flex items-center gap-2">
                    <label for="sg-region-filter" class="text-sm font-medium text-gray-700">Filtrar por Región:</label>
                    <select id="sg-region-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block p-1.5">
                        <option value="all">Todas las Regiones</option>
                        ${regionOptions}
                    </select>
                </div>`;

            if (!sgs || sgs.length === 0) {
                return `<div class="bg-white p-6 rounded-xl border border-gray-100">${filterControl}<p class="text-center text-gray-500 py-4">No se encontraron Security Groups con los filtros seleccionados.</p></div>`;
            }
            
            let table = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Group ID</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Group Name</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descripción</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tags</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            sgs.sort((a,b) => a.Region.localeCompare(b.Region)).forEach(sg => {
                const tagsStr = Object.entries(sg.Tags).map(([k, val]) => `${k}:${val}`).join(', ') || '-';
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${sg.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${sg.GroupId}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 break-all">${sg.GroupName}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 break-all">${sg.Description}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 break-all">${tagsStr}</td>
                        </tr>`;
            });
            table += '</tbody></table></div>';
            
            return `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">${filterControl}${table}</div>`;
        };        

        const renderVpcDiagram = (vpcs, subnets, instances, lambdas, rdsInstances, auroraClusters) => {
            if (!vpcs || vpcs.length === 0) {
                return '<p class="text-center text-gray-500">No se encontraron VPCs para mostrar en el diagrama.</p>';
            }

            let diagramHtml = '<div class="space-y-8">'; // Contenedor principal para todas las VPCs

            // 1. Iteramos por cada VPC
            vpcs.forEach(vpc => {
                const vpcSubnets = subnets.filter(s => s.VpcId === vpc.VpcId);
                // Contamos todos los recursos para la cabecera
                const vpcInstances = instances.filter(i => vpcSubnets.some(s => s.SubnetId === i.SubnetId));
                const vpcLambdas = lambdas.filter(l => l.VpcConfig && l.VpcConfig.VpcId === vpc.VpcId);
                const vpcRds = rdsInstances.filter(r => r.VpcId === vpc.VpcId);
                const vpcAurora = auroraClusters.filter(a => a.VpcId === vpc.VpcId);
                const totalResources = vpcInstances.length + vpcLambdas.length + vpcRds.length + vpcAurora.length;


                diagramHtml += `
                <div class="bg-white border border-gray-200 rounded-xl shadow-md">
                    <div class="bg-gray-50 p-3 border-b border-gray-200 rounded-t-xl">
                        <h3 class="text-lg font-bold text-[#204071]">${vpc.Tags['Name'] || vpc.VpcId}</h3>
                        <p class="text-sm text-gray-500 font-mono">${vpc.Region} | ${vpc.VpcId} | ${vpc.CidrBlock} | ${vpcSubnets.length} subredes | ${totalResources} recursos</p>
                    </div>
                    <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                `;

                // 2. Iteramos por cada Subred de esta VPC
                vpcSubnets.sort((a,b) => (a.Tags['Name'] || a.SubnetId).localeCompare(b.Tags['Name'] || b.SubnetId)).forEach(subnet => {
                    diagramHtml += `
                    <div class="bg-slate-50 border border-blue-200 rounded-lg p-3 flex flex-col">
                        <div class="border-b border-blue-200 pb-2 mb-3">
                            <p class="font-bold text-sm text-blue-800">${subnet.Tags['Name'] || subnet.SubnetId}</p>
                            <p class="text-xs text-gray-500 font-mono">${subnet.CidrBlock}</p>
                        </div>
                        <div class="space-y-2 flex-grow">
                    `;
                    
                    // 3. Dibujamos Instancias EC2
                    const subnetInstances = instances.filter(i => i.SubnetId === subnet.SubnetId);
                    if (subnetInstances.length > 0) {
                        subnetInstances.sort((a,b) => (a.Tags['Name'] || a.InstanceId).localeCompare(b.Tags['Name'] || b.InstanceId)).forEach(instance => {
                            const state = instance.State.toLowerCase();
                            let bgColor = (state === 'running') ? 'bg-green-100 border border-green-300' : 'bg-red-100 border border-red-300';
                            const instanceName = instance.Tags['Name'] || instance.InstanceId;
                            diagramHtml += `<div class="${bgColor} p-2 rounded-md text-xs"><p class="font-semibold text-gray-800 truncate" title="${instanceName}">${instanceName}</p><div class="flex justify-between items-center text-gray-600"><span class="font-mono">${instance.InstanceType}</span><span>${instance.State}</span></div></div>`;
                        });
                    }

                    // 4. Dibujamos Funciones Lambda
                    const subnetLambdas = lambdas.filter(l => l.VpcConfig && l.VpcConfig.SubnetIds && l.VpcConfig.SubnetIds.includes(subnet.SubnetId));
                    if (subnetLambdas.length > 0) {
                        subnetLambdas.sort((a,b) => a.FunctionName.localeCompare(b.FunctionName)).forEach(lambda => {
                            diagramHtml += `<div class="bg-purple-100 border border-purple-300 p-2 rounded-md text-xs"><p class="font-semibold text-gray-800 truncate" title="${lambda.FunctionName}"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="inline-block mr-1" viewBox="0 0 16 16"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/><path d="M6.854 4.646a.5.5 0 0 1 0 .708L4.207 8l2.647 2.646a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 0 1 .708 0m2.292 0a.5.5 0 0 0 0 .708L11.793 8l-2.647 2.646a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708 0"/></svg>${lambda.FunctionName}</p><div class="flex justify-between items-center text-gray-600"><span class="font-mono">${lambda.Runtime}</span></div></div>`;
                        });
                    }
                    
                    // 5. Dibujamos Instancias RDS
                    const subnetRds = rdsInstances.filter(r => r.SubnetIds && r.SubnetIds.includes(subnet.SubnetId));
                    if (subnetRds.length > 0) {
                        subnetRds.forEach(rds => {
                            diagramHtml += `<div class="bg-blue-100 border border-blue-300 p-2 rounded-md text-xs"><p class="font-semibold text-gray-800 truncate" title="${rds.DBInstanceIdentifier}"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="inline-block mr-1" viewBox="0 0 16 16"><path d="M4.318 2.687C5.234 2.271 6.536 2 8 2s2.766.27 3.682.687C12.644 3.125 13 3.627 13 4c0 .374-.356.875-1.318 1.313C10.766 5.729 9.464 6 8 6s-2.766-.27-3.682-.687C3.356 4.875 3 4.373 3 4c0-.374.356-.875 1.318-1.313M13 5.698V7c0 .374-.356.875-1.318 1.313C10.766 8.729 9.464 9 8 9s-2.766-.27-3.682-.687C3.356 7.875 3 7.373 3 7V5.698c.271.202.58.378.904.525C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777A5 5 0 0 0 13 5.698M14 4c0-1.007-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1s-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4v9c0 1.007.875 1.755 1.904 2.223C4.978 15.71 6.427 16 8 16s3.022-.289 4.096-.777C13.125 14.755 14 14.007 14 13zm-1 4.698V10c0 .374-.356.875-1.318 1.313C10.766 11.729 9.464 12 8 12s-2.766-.27-3.682-.687C3.356 10.875 3 10.373 3 10V8.698c.271.202.58.378.904.525C4.978 9.71 6.427 10 8 10s3.022-.289 4.096-.777A5 5 0 0 0 13 8.698m0 3V13c0 .374-.356.875-1.318 1.313C10.766 14.729 9.464 15 8 15s-2.766-.27-3.682-.687C3.356 13.875 3 13.373 3 13v-1.302c.271.202.58.378.904.525C4.978 12.71 6.427 13 8 13s3.022-.289 4.096-.777c.324-.147.633-.323.904-.525"/></svg>${rds.DBInstanceIdentifier}</p><div class="flex justify-between items-center text-gray-600"><span class="font-mono">${rds.Engine}</span></div></div>`;
                        });
                    }

                    // 6. Dibujamos Clústeres Aurora
                    const subnetAurora = auroraClusters.filter(c => c.SubnetIds && c.SubnetIds.includes(subnet.SubnetId));
                    if (subnetAurora.length > 0) {
                        subnetAurora.forEach(aurora => {
                            diagramHtml += `<div class="bg-teal-100 border border-teal-300 p-2 rounded-md text-xs"><p class="font-semibold text-gray-800 truncate" title="${aurora.ClusterIdentifier}"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="inline-block mr-1" viewBox="0 0 16 16"><path d="M4.318 2.687C5.234 2.271 6.536 2 8 2s2.766.27 3.682.687C12.644 3.125 13 3.627 13 4c0 .374-.356.875-1.318 1.313C10.766 5.729 9.464 6 8 6s-2.766-.27-3.682-.687C3.356 4.875 3 4.373 3 4c0-.374.356-.875 1.318-1.313M13 5.698V7c0 .374-.356.875-1.318 1.313C10.766 8.729 9.464 9 8 9s-2.766-.27-3.682-.687C3.356 7.875 3 7.373 3 7V5.698c.271.202.58.378.904.525C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777A5 5 0 0 0 13 5.698M14 4c0-1.007-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1s-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4v9c0 1.007.875 1.755 1.904 2.223C4.978 15.71 6.427 16 8 16s3.022-.289 4.096-.777C13.125 14.755 14 14.007 14 13zm-1 4.698V10c0 .374-.356.875-1.318 1.313C10.766 11.729 9.464 12 8 12s-2.766-.27-3.682-.687C3.356 10.875 3 10.373 3 10V8.698c.271.202.58.378.904.525C4.978 9.71 6.427 10 8 10s3.022-.289 4.096-.777A5 5 0 0 0 13 8.698m0 3V13c0 .374-.356.875-1.318 1.313C10.766 14.729 9.464 15 8 15s-2.766-.27-3.682-.687C3.356 13.875 3 13.373 3 13v-1.302c.271.202.58.378.904.525C4.978 12.71 6.427 13 8 13s3.022-.289 4.096-.777c.324-.147.633-.323.904-.525"/></svg>${aurora.ClusterIdentifier}</p><div class="flex justify-between items-center text-gray-600"><span class="font-mono">${aurora.Engine}</span></div></div>`;
                        });
                    }

                    if (subnetInstances.length === 0 && subnetLambdas.length === 0 && subnetRds.length === 0 && subnetAurora.length === 0) {
                        diagramHtml += '<p class="text-center text-xs text-gray-400 py-4">Sin recursos</p>';
                    }

                    diagramHtml += `</div></div>`; // Cierre de la subred
                });
                diagramHtml += `</div></div>`; // Cierre de la VPC
            });

            diagramHtml += '</div>'; // Cierre del contenedor principal
            return diagramHtml;
        };

        const renderNetworkDetailView = (allRegions) => {
            const regionOptions = allRegions.map(r => `<option value="${r}">${r}</option>`).join('');
            
            return `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-lg mb-4 text-[#204071]">Obtener Detalles de Recurso de Red</h3>
                    <p class="text-sm text-gray-600 mb-4">Introduce el ID de un Security Group (ej: sg-xxxx) o una Network ACL (ej: acl-xxxx) y selecciona su región para ver sus reglas.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4 items-end">
                        <div class="lg:col-span-2">
                            <label for="np-resource-id" class="block text-sm font-medium text-gray-700 mb-1">Resource ID (SG o ACL)</label>
                            <input type="text" id="np-resource-id" class="bg-gray-50 border border-gray-300 text-[#204071] text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block w-full p-2.5 font-mono" placeholder="sg-12345678 o acl-12345678">
                        </div>
                        <div>
                            <label for="np-resource-region" class="block text-sm font-medium text-gray-700 mb-1">Región del Recurso</label>
                            <select id="np-resource-region" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block w-full p-2.5">
                                <option value="">Selecciona una región</option>
                                ${regionOptions}
                            </select>
                        </div>
                    </div>
                    <button id="np-run-detail-btn" class="bg-[#204071] text-white px-4 py-2.5 rounded-lg font-bold text-md hover:bg-[#1a335a] transition flex items-center justify-center space-x-2">
                        <span id="np-detail-btn-text">Analizar</span>
                        <div id="np-detail-spinner" class="spinner hidden"></div>
                    </button>
                </div>
                <div id="np-detail-results-container" class="mt-6"></div>
            `;
        };

        const runNetworkDetailAnalysis = async () => {
            log('Iniciando análisis de detalle de red...', 'info');
            const resourceId = document.getElementById('np-resource-id').value.trim();
            const region = document.getElementById('np-resource-region').value;
            const resultsContainer = document.getElementById('np-detail-results-container');
            resultsContainer.innerHTML = '';

            if (!resourceId || !region) {
                log('ID de recurso y región son requeridos.', 'error');
                resultsContainer.innerHTML = '<p class="text-red-600 font-medium">Error: Por favor, introduce un ID y selecciona una región.</p>';
                return;
            }

            const runBtn = document.getElementById('np-run-detail-btn');
            const btnText = document.getElementById('np-detail-btn-text');
            const spinner = document.getElementById('np-detail-spinner');
            
            runBtn.disabled = true;
            spinner.classList.remove('hidden');
            btnText.textContent = 'Analizando...';

            const payload = {
                access_key: accessKeyInput.value.trim(),
                secret_key: secretKeyInput.value.trim(),
                session_token: sessionTokenInput.value.trim() || null,
                resource_id: resourceId,
                region: region
            };

            try {
                const response = await fetch('http://127.0.0.1:5001/api/run-network-detail-audit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Error desconocido del servidor.');
                }

                log('Análisis de detalle completado.', 'success');
                renderNetworkDetailResult(data.results.details_table);

            } catch(e) {
                log(`Error en análisis de detalle: ${e.message}`, 'error');
                resultsContainer.innerHTML = `<div class="bg-red-50 text-red-700 p-4 rounded-lg"><h4 class="font-bold">Error</h4><p>${e.message}</p></div>`;
            } finally {
                runBtn.disabled = false;
                spinner.classList.add('hidden');
                btnText.textContent = 'Analizar';
            }
        };

        const renderNetworkDetailResult = (tableString) => {
            const container = document.getElementById('np-detail-results-container');
            if (!tableString) {
                container.innerHTML = '<p class="text-gray-500">No se encontraron resultados.</p>';
                return;
            }
            container.innerHTML = `
                <h3 class="text-xl font-bold text-[#204071] mb-4">Resultado del Análisis</h3>
                <pre class="bg-[#204071] text-white p-4 rounded-lg text-xs font-mono overflow-x-auto">${tableString}</pre>
            `;
        };


// --- SECCIÓN DE CONECTIVIDAD DE RED ---

        const buildConnectivityView = () => {
            const container = document.getElementById('connectivity-view');
            if (!container || !connectivityApiData) return;

            const { peering_connections, tgw_attachments, vpn_connections, vpc_endpoints } = connectivityApiData.results;

            container.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-[#204071]">Conectividad de Red</h2>
                        <p class="text-sm text-gray-500">${connectivityApiData.metadata.executionDate}</p>
                    </div>
                </header>
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex flex-wrap space-x-6" id="connectivity-tabs">
                        <a href="#" data-tab="conn-peering-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">VPC Peering (${peering_connections.length})</a>
                        <a href="#" data-tab="conn-tgw-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Transit Gateway (${tgw_attachments.length})</a>
                        <a href="#" data-tab="conn-vpn-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">VPN Connections (${vpn_connections.length})</a>
                        <a href="#" data-tab="conn-endpoints-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">VPC Endpoints (${vpc_endpoints.length})</a>
                    </nav>
                </div>
                <div id="connectivity-tab-content-container">
                    <div id="conn-peering-content" class="connectivity-tab-content">${renderPeeringTable(peering_connections)}</div>
                    <div id="conn-tgw-content" class="connectivity-tab-content hidden">${renderTgwAttachmentsTable(tgw_attachments)}</div>
                    <div id="conn-vpn-content" class="connectivity-tab-content hidden">${renderVpnConnectionsTable(vpn_connections)}</div>
                    <div id="conn-endpoints-content" class="connectivity-tab-content hidden">${renderVpcEndpointsTable(vpc_endpoints)}</div>
                </div>
            `;
            
            const tabsNav = container.querySelector('#connectivity-tabs');
            if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.connectivity-tab-content'));
        };

        const renderPeeringTable = (connections) => {
            if (!connections || connections.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron conexiones de VPC Peering activas.</p></div>';
            let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID Conexión</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">VPC Solicitante (Requester)</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">VPC Aceptante (Accepter)</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            connections.forEach(c => {
                const requesterInfo = `${c.RequesterVpc.VpcId} (${c.RequesterVpc.OwnerId})`;
                const accepterInfo = `${c.AccepterVpc.VpcId} (${c.AccepterVpc.OwnerId})`;
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${c.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800 font-mono">${c.ConnectionId}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">${requesterInfo}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">${accepterInfo}</td>
                        </tr>`;
            });
            table += '</tbody></table></div>';
            return table;
        };

        const renderTgwAttachmentsTable = (attachments) => {
            if (!attachments || attachments.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron adjuntos de VPC a Transit Gateways.</p></div>';
             let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Transit Gateway ID</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">VPC Adjunta</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID del Adjunto</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            attachments.forEach(a => {
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${a.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800 font-mono">${a.TransitGatewayId}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">${a.VpcId}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">${a.AttachmentId}</td>
                        </tr>`;
            });
            table += '</tbody></table></div>';
            return table;
        };

        const renderVpnConnectionsTable = (connections) => {
            if (!connections || connections.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron conexiones VPN activas.</p></div>';
            let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">VPN Connection ID</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer Gateway ID</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Asociado a TGW</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            connections.forEach(c => {
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${c.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800 font-mono">${c.VpnConnectionId}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">${c.CustomerGatewayId}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">${c.TransitGatewayId}</td>
                        </tr>`;
            });
            table += '</tbody></table></div>';
            return table;
        };

        const renderVpcEndpointsTable = (endpoints) => {
            if (!endpoints || endpoints.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron VPC Endpoints.</p></div>';
            let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">VPC ID</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre del Servicio</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            endpoints.forEach(e => {
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${e.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800 font-mono">${e.VpcId}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${e.EndpointType}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 break-all font-mono">${e.ServiceName}</td>
                        </tr>`;
            });
            table += '</tbody></table></div>';
            return table;
        };


        // --- SECCIÓN DE AWS CONFIG & SECURITY HUB ---

        const buildConfigSHView = () => {
            const container = document.getElementById('config-sh-view');
            const executionDate = (configSHApiData || configSHStatusApiData)?.metadata?.executionDate || 'Análisis no ejecutado.';

            // Si tenemos los datos del análisis profundo, mostramos todo
            if (configSHApiData) {
                const { service_status, findings, compliance_summary } = configSHApiData.results;
                container.innerHTML = `
                    <header class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-[#204071]">Config & Security Hub Status</h2>
                            <p class="text-sm text-gray-500">${executionDate}</p>
                        </div>
                    </header>
                    <div id="config-sh-results-view">
                        <div class="border-b border-gray-200 mb-6">
                            <nav class="-mb-px flex flex-wrap space-x-6" id="config-sh-tabs">
                                <a href="#" data-tab="config-sh-summary-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">Resumen</a>
                                <a href="#" data-tab="config-sh-status-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Estado de Servicios</a>
                                <a href="#" data-tab="config-sh-compliance-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Estado de Cumplimiento</a>
                                <a href="#" data-tab="config-sh-failed-controls-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Controles Fallidos</a>
                            </nav>
                        </div>
                        <div id="config-sh-tab-content-container">
                            <div id="config-sh-summary-content" class="config-sh-tab-content">${createConfigSHSummaryCardsHtml()}</div>
                            <div id="config-sh-status-content" class="config-sh-tab-content hidden">${renderConfigSHStatusTable(service_status)}</div>
                            <div id="config-sh-compliance-content" class="config-sh-tab-content hidden"></div>
                            <div id="config-sh-failed-controls-content" class="config-sh-tab-content hidden"></div>
                        </div>
                    </div>`;

                updateConfigSHSummaryCards(service_status, findings);
                renderComplianceStatus(compliance_summary, findings);
                renderFailedControlsByStandard(findings);

                const tabsNav = container.querySelector('#config-sh-tabs');
                if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.config-sh-tab-content'));

            // Si NO tenemos el análisis profundo, pero SÍ el de estado, mostramos la vista inicial
            } else if (configSHStatusApiData) {
                const { service_status } = configSHStatusApiData.results;
                container.innerHTML = `
                    <header class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-[#204071]">Config & Security Hub Status</h2>
                            <p class="text-sm text-gray-500">${executionDate}</p>
                        </div>
                    </header>
                    <div class="border-b border-gray-200 mb-6">
                         <nav class="-mb-px flex flex-wrap space-x-6" id="config-sh-tabs">
                            <a href="#" data-tab="config-sh-status-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">Estado de Servicios</a>
                            <a href="#" data-tab="config-sh-deep-scan-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Análisis Profundo</a>
                        </nav>
                    </div>
                    <div id="config-sh-initial-view">
                        <div id="config-sh-status-content" class="config-sh-tab-content">
                            ${renderConfigSHStatusTable(service_status)}
                        </div>
                        <div id="config-sh-deep-scan-content" class="config-sh-tab-content hidden">
                            <div class="bg-white mt-6 p-6 rounded-xl shadow-sm border border-gray-100 text-center">
                                <p class="text-gray-600 mb-4">Ejecuta el análisis profundo para ver todos los hallazgos de Security Hub y el estado de cumplimiento detallado. Este proceso puede tardar varios minutos.</p>
                                <button id="run-deep-scan-btn" class="bg-[#eb3496] text-white px-5 py-2.5 rounded-lg font-bold text-md hover:bg-[#d42c86] transition flex items-center justify-center space-x-2 mx-auto">
                                    <span id="deep-scan-btn-text">Ejecutar Análisis Profundo</span>
                                    <div id="deep-scan-spinner" class="spinner hidden"></div>
                                </button>
                            </div>
                        </div>
                    </div>`;
                
                const tabsNav = container.querySelector('#config-sh-tabs');
                if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.config-sh-tab-content'));
                document.getElementById('run-deep-scan-btn').addEventListener('click', runDeepConfigSHAnalysis);

            // Si no tenemos ningún dato, mostramos el estado inicial vacío
            } else {
                 container.innerHTML = `
                    <header class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-[#204071]">Config & Security Hub Status</h2>
                            <p class="text-sm text-gray-500">Introduce credenciales para ver el estado.</p>
                        </div>
                    </header>
                    <p class="text-center text-gray-500 py-8">Los resultados aparecerán aquí después del análisis.</p>
                `;
            }
        };

        const runDeepConfigSHAnalysis = async () => {
            const runBtn = document.getElementById('run-deep-scan-btn');
            const btnText = document.getElementById('deep-scan-btn-text');
            const spinner = document.getElementById('deep-scan-spinner');
            
            runBtn.disabled = true;
            spinner.classList.remove('hidden');
            btnText.textContent = 'Analizando... (puede tardar varios minutos)';
            log('Iniciando análisis profundo de Config & Security Hub...', 'info');

            const payload = {
                access_key: accessKeyInput.value.trim(),
                secret_key: secretKeyInput.value.trim(),
                session_token: sessionTokenInput.value.trim() || null,
            };

            try {
                const response = await fetch('http://127.0.0.1:5001/api/run-config-sh-audit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                configSHApiData = await response.json(); // Guardamos en la variable global
                
                if (!response.ok) {
                    throw new Error(configSHApiData.error || 'Error desconocido del servidor.');
                }
                
                log('Análisis profundo de Config & Security Hub completado.', 'success');
                // Simplemente volvemos a llamar a la función de renderizado.
                // Ella sola sabrá que ahora tiene que mostrar la vista completa.
                buildConfigSHView();

            } catch (e) {
                log(`Error en el análisis profundo: ${e.message}`, 'error');
                const initialContainer = document.getElementById('config-sh-initial-view');
                if(initialContainer) {
                    initialContainer.innerHTML = `<div class="bg-red-50 text-red-700 p-4 rounded-lg"><h4 class="font-bold">Error</h4><p>${e.message}</p></div>`;
                }
                 // Reactivamos el botón en caso de error
                runBtn.disabled = false;
                spinner.classList.add('hidden');
                btnText.textContent = 'Ejecutar Análisis Profundo';
            }
        };

        const createConfigSHSummaryCardsHtml = () => `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full">
                    <div><p class="text-sm text-gray-500">Regiones con Config</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="config-sh-config-enabled" class="text-3xl font-bold text-[#204071]">--</p>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-ui-checks w-6 h-6 text-blue-600" viewBox="0 0 16 16">
                                <path d="M7 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5zM2 1a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm0 8a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2zm.854-3.646a.5.5 0 0 1-.708 0l-1-1a.5.5 0 1 1 .708-.708l.646.647 1.646-1.647a.5.5 0 1 1 .708.708zm0 8a.5.5 0 0 1-.708 0l-1-1a.5.5 0 0 1 .708-.708l.646.647 1.646-1.647a.5.5 0 0 1 .708.708zM7 10.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5zm0-5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m0 8a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full">
                    <div><p class="text-sm text-gray-500">Regiones con Security Hub</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="config-sh-sh-enabled" class="text-3xl font-bold text-[#204071]">--</p>
                        <div class="bg-green-100 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-ui-checks w-6 h-6 text-green-600" viewBox="0 0 16 16">
                                <path d="M7 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5zM2 1a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm0 8a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2zm.854-3.646a.5.5 0 0 1-.708 0l-1-1a.5.5 0 1 1 .708-.708l.646.647 1.646-1.647a.5.5 0 1 1 .708.708zm0 8a.5.5 0 0 1-.708 0l-1-1a.5.5 0 0 1 .708-.708l.646.647 1.646-1.647a.5.5 0 0 1 .708.708zM7 10.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5zm0-5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m0 8a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full">
                    <div><p class="text-sm text-gray-500">Total Findings Activos</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="config-sh-total-findings" class="text-3xl font-bold text-[#204071]">--</p>
                        <div class="bg-orange-100 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shield-exclamation w-6 h-6 text-orange-600" viewBox="0 0 16 16">
                                <path d="M5.338 1.59a61 61 0 0 0-2.837.856.48.48 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.7 10.7 0 0 0 2.287 2.233c.346.244.652.42.893.533q.18.085.293.118a1 1 0 0 0 .101.025 1 1 0 0 0 .1-.025q.114-.034.294-.118c.24-.113.547-.29.893-.533a10.7 10.7 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.8 11.8 0 0 1-2.517 2.453 7 7 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7 7 0 0 1-1.048-.625 11.8 11.8 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 63 63 0 0 1 5.072.56"/>
                                <path d="M7.001 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.553.553 0 0 1-1.1 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm flex flex-col justify-between h-full">
                    <div><p class="text-sm text-gray-500">Findings Críticos / Altos</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="config-sh-critical-findings" class="text-3xl font-bold text-red-600">--</p>
                        <div class="bg-red-100 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shield-exclamation w-6 h-6 text-red-600" viewBox="0 0 16 16">
                                <path d="M5.338 1.59a61 61 0 0 0-2.837.856.48.48 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.7 10.7 0 0 0 2.287 2.233c.346.244.652.42.893.533q.18.085.293.118a1 1 0 0 0 .101.025 1 1 0 0 0 .1-.025q.114-.034.294-.118c.24-.113.547-.29.893-.533a10.7 10.7 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.8 11.8 0 0 1-2.517 2.453 7 7 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7 7 0 0 1-1.048-.625 11.8 11.8 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 63 63 0 0 1 5.072.56"/>
                                <path d="M7.001 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.553.553 0 0 1-1.1 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        `;




        const updateConfigSHSummaryCards = (serviceStatus, findings) => {
            const totalRegions = serviceStatus.length;
            const configEnabledCount = serviceStatus.filter(s => s.ConfigEnabled).length;
            const shEnabledCount = serviceStatus.filter(s => s.SecurityHubEnabled).length;
            const criticalHighCount = findings.filter(f => ['CRITICAL', 'HIGH'].includes(f.Severity?.Label)).length;

            document.getElementById('config-sh-config-enabled').textContent = `${configEnabledCount} / ${totalRegions}`;
            document.getElementById('config-sh-sh-enabled').textContent = `${shEnabledCount} / ${totalRegions}`;
            document.getElementById('config-sh-total-findings').textContent = findings.length;
            document.getElementById('config-sh-critical-findings').textContent = criticalHighCount;
        };

        const renderConfigSHStatusTable = (serviceStatus) => {
            if (!serviceStatus || serviceStatus.length === 0) {
                return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se pudo obtener el estado de los servicios por región.</p></div>';
            }

            const activeRegions = serviceStatus.filter(s => s.ConfigEnabled || s.SecurityHubEnabled);

            if (activeRegions.length === 0) {
                return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No hay regiones con AWS Config o Security Hub habilitados.</p></div>';
            }
            
            let tableHtml = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">AWS Config</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">AWS Security Hub</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estándares SH</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Conformance Packs</th>' +
                            '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            
            activeRegions.forEach(s => {
                const configBadge = s.ConfigEnabled ? createStatusBadge('Habilitado') : createStatusBadge('Deshabilitado');
                const shBadge = s.SecurityHubEnabled ? createStatusBadge('Habilitado') : createStatusBadge('Deshabilitado');
                
                let standardsHtml = '-';
                if (s.EnabledStandards && s.EnabledStandards.length > 0) {
                    standardsHtml = '<div class="flex flex-col items-start gap-1">' + 
                                    s.EnabledStandards.map(arn => {
                                        // Aquí acortamos el ARN
                                        const shortName = arn.split(/[/:]standards\//).pop() || arn;
                                        return `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">${shortName}</span>`
                                    }).join('') +
                                    '</div>';
                }
                
                let conformancePacksHtml = '-';
                if (s.EnabledConformancePacks && s.EnabledConformancePacks.length > 0) {
                    conformancePacksHtml = '<div class="flex flex-col items-start gap-1">' +
                                        s.EnabledConformancePacks.map(cp => `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-200 text-gray-800">${cp}</span>`).join('') +
                                        '</div>';
                }

                tableHtml += `<tr class="hover:bg-gray-50">
                                <td class="px-4 py-4 align-top whitespace-nowrap text-sm font-medium text-gray-800">${s.Region}</td>
                                <td class="px-4 py-4 align-top whitespace-nowrap text-sm">${configBadge}</td>
                                <td class="px-4 py-4 align-top whitespace-nowrap text-sm">${shBadge}</td>
                                <td class="px-4 py-4 align-top text-sm">${standardsHtml}</td>
                                <td class="px-4 py-4 align-top text-sm">${conformancePacksHtml}</td> 
                            </tr>`;
            });
            tableHtml += '</tbody></table></div>';
            return tableHtml;
        };



        const renderComplianceStatus = (complianceSummary, allFindings) => {
            const container = document.getElementById('config-sh-compliance-content');
            if (!container) return;

            if (!complianceSummary || complianceSummary.length === 0) {
                container.innerHTML = `<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron datos de cumplimiento para generar el gráfico.</p></div>`;
                return;
            }

            // Creamos la nueva estructura HTML con un solo canvas para el gráfico unificado
            let contentHtml = `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-xl font-bold text-[#204071] mb-2">Cumplimiento General por Estándar de Seguridad</h3>
                    <p class="text-sm text-gray-500 mb-6">Comparativa del porcentaje de controles superados para cada estándar habilitado.</p>
                    <div class="h-96">
                        <canvas id="unifiedComplianceChart"></canvas>
                    </div>
                </div>
            `;
            
            container.innerHTML = contentHtml;

            // Esperamos un instante para que el canvas esté en el DOM y luego llamamos a la función que lo dibujará
            setTimeout(() => {
                createUnifiedBarChart(complianceSummary);
            }, 0);
        };
        
        const createUnifiedBarChart = (complianceData) => {
            const ctx = document.getElementById('unifiedComplianceChart');
            if (!ctx) return;

            // 1. Preparamos los datos para Chart.js (sin cambios aquí)
            const labels = complianceData.map(d => {
                const arn = d.standardArn || '';
                return arn.split(/[/:]standards\//).pop() || arn;
            });
            const percentages = complianceData.map(d => d.compliancePercentage);

            // --- INICIO DE LA MODIFICACIÓN ---
            // 2. Definimos una paleta de colores fijos para los estándares.
            //    Chart.js automáticamente usará un color para cada barra y reciclará
            //    los colores si hay más barras que colores en la paleta.
            const colorPalette = [
                'rgba(59, 130, 246, 0.7)',  // Blue
                'rgba(22, 163, 74, 0.7)',   // Green
                'rgba(249, 115, 22, 0.7)',  // Orange
                'rgba(139, 92, 246, 0.7)',  // Purple
                'rgba(236, 72, 153, 0.7)',  // Pink
                'rgba(20, 184, 166, 0.7)',  // Teal
                'rgba(250, 204, 21, 0.7)',  // Yellow
                'rgba(107, 114, 128, 0.7)'  // Gray
            ];
            const borderPalette = colorPalette.map(color => color.replace('0.7', '1')); // Versión sólida para el borde

            // 3. Configuramos el gráfico
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% Cumplimiento',
                        data: percentages,
                        backgroundColor: colorPalette, // Usamos la nueva paleta
                        borderColor: borderPalette,    // Usamos la paleta para los bordes
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + "%"
                                }
                            }
                        },
                        y: {
                            ticks: {
                                autoSkip: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Cumplimiento: ${context.raw.toFixed(2)}%`;
                                }
                            }
                        }
                    }
                }
            });
        };


        const getStandardNameFromArn = (arn) => {
            if (!arn || !arn.includes('/standard/')) return 'Estándar Desconocido';
            // Transforma "aws-foundational-security-best-practices/v/1.0.0" a "Aws Foundational Security Best Practices v1.0.0"
            const namePart = arn.split('/standard/')[1];
            return namePart.replace(/\/v\//, ' v').split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        };
        
        const renderFailedControlsByStandard = (findings) => {
            const container = document.getElementById('config-sh-failed-controls-content');
            if (!container) return;

            const failedControls = {};

            findings.forEach(finding => {
                if (finding.Compliance?.Status === 'FAILED') {
                    const standardArn = finding.ProductFields?.StandardsArn;
                    if (!standardArn) return;
                    const standardName = getStandardNameFromArn(standardArn);
                    const controlId = finding.Compliance.SecurityControlId;
                    if (!failedControls[standardName]) failedControls[standardName] = {};
                    if (!failedControls[standardName][controlId]) {
                        failedControls[standardName][controlId] = {
                            title: finding.Title,
                            description: finding.Description,
                            url: finding.Remediation?.Recommendation?.Url
                        };
                    }
                }
            });

            if (Object.keys(failedControls).length === 0) {
                container.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><div class="flex items-center justify-center text-green-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-patch-check-fill mr-3" viewBox="0 0 16 16"><path d="M10.067.87a2.89 2.89 0 0 0-4.134 0l-.622.638-.89-.011a2.89 2.89 0 0 0-2.924 2.924l.01.89-.636.622a2.89 2.89 0 0 0 0 4.134l.637.622-.011.89a2.89 2.89 0 0 0 2.924 2.924l.89-.01.622.636a2.89 2.89 0 0 0 4.134 0l.622-.637.89.01a2.89 2.89 0 0 0 2.924-2.924l-.01-.89.636-.622a2.89 2.89 0 0 0 0-4.134l-.637-.622.011-.89a2.89 2.89 0 0 0-2.924-2.924l-.89.01zm.287 5.984-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7 8.793l2.646-2.647a.5.5 0 0 1 .708.708"/></svg><p class="text-center font-semibold text-lg">¡Felicidades! No se encontraron controles de seguridad fallidos.</p></div></div>`;
                return;
            }

            let accordionHtml = '<div class="space-y-4">';
            const sortedStandards = Object.keys(failedControls).sort();

            sortedStandards.forEach((standardName, index) => {
                const controls = Object.values(failedControls[standardName]); // Convertimos el objeto a un array
                const controlCount = controls.length;

                accordionHtml += `
                    <details class="bg-white shadow-sm rounded-lg border border-gray-200 group" open>
                        <summary class="flex justify-between items-center p-4 cursor-pointer font-semibold text-[#204071]">
                            <span>${standardName} (${controlCount} fallidos)</span>
                            <svg class="w-5 h-5 group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </summary>
                        <div class="border-t border-gray-200 p-4">
                            <ul id="controls-list-${index}" class="space-y-3 text-sm"></ul>
                            <div id="controls-pagination-${index}" class="mt-4 flex justify-center items-center space-x-2"></div>
                        </div>
                    </details>`;
            });

            accordionHtml += '</div>';
            container.innerHTML = accordionHtml;

            // Ahora, configuramos la paginación para cada sección
            sortedStandards.forEach((standardName, index) => {
                const controls = Object.values(failedControls[standardName]);
                const ulContainer = document.getElementById(`controls-list-${index}`);
                const paginationContainer = document.getElementById(`controls-pagination-${index}`);
                if (ulContainer && paginationContainer) {
                    setupPagination(paginationContainer, ulContainer, controls, renderControlsPage);
                }
            });
        };

        const renderControlsPage = (ulContainer, controls, page, rowsPerPage) => {
            ulContainer.innerHTML = '';
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedItems = controls.slice(start, end);

            let pageHtml = '';
            for (const control of paginatedItems) {
                // Obtenemos el ID del control de su título (ej: "EC2.2: ...") si es posible
                const controlIdMatch = control.title.match(/^([A-Za-z0-9._-]+:)/);
                const controlId = controlIdMatch ? controlIdMatch[1] : '';
                const controlTitle = control.title.replace(controlId, '').trim();

                pageHtml += `
                    <li class="p-3 bg-gray-50 rounded-md border border-gray-200">
                        <p class="font-bold text-gray-800">${controlId} ${controlTitle}</p>
                        <p class="text-gray-600 mt-1">${control.description}</p>
                        ${control.url ? `<a href="${control.url}" target="_blank" class="text-blue-600 hover:underline text-xs mt-1 inline-block">Ver recomendación para remediar ↗</a>` : ''}
                    </li>`;
            }
            ulContainer.innerHTML = pageHtml;
        };

        const setupPagination = (paginationContainer, ulContainer, items, renderPageFunction) => {
            const rowsPerPage = 50; // Mostraremos 50 resultados por página
            if (items.length <= rowsPerPage) {
                renderPageFunction(ulContainer, items, 1, rowsPerPage);
                return; // No se necesita paginación si hay pocos items
            }

            const pageCount = Math.ceil(items.length / rowsPerPage);
            let currentPage = 1;

            const updatePaginationButtons = () => {
                paginationContainer.innerHTML = '';
                
                // Botón "Anterior"
                const prevButton = document.createElement('button');
                prevButton.innerText = '« Ant';
                prevButton.disabled = currentPage === 1;
                prevButton.className = 'px-3 py-1 text-sm rounded-md border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50';
                prevButton.addEventListener('click', () => {
                    currentPage--;
                    renderPageFunction(ulContainer, items, currentPage, rowsPerPage);
                    updatePaginationButtons();
                });
                paginationContainer.appendChild(prevButton);

                // Indicador de página
                const pageIndicator = document.createElement('span');
                pageIndicator.innerText = `Pág ${currentPage} de ${pageCount}`;
                pageIndicator.className = 'px-3 py-1 text-sm text-gray-600';
                paginationContainer.appendChild(pageIndicator);
                
                // Botón "Siguiente"
                const nextButton = document.createElement('button');
                nextButton.innerText = 'Sig »';
                nextButton.disabled = currentPage === pageCount;
                nextButton.className = 'px-3 py-1 text-sm rounded-md border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50';
                nextButton.addEventListener('click', () => {
                    currentPage++;
                    renderPageFunction(ulContainer, items, currentPage, rowsPerPage);
                    updatePaginationButtons();
                });
                paginationContainer.appendChild(nextButton);
            };

            renderPageFunction(ulContainer, items, currentPage, rowsPerPage);
            updatePaginationButtons();
        };



// --- SECCIÓN DE PLAYGROUND ---

        const buildPlaygroundView = () => {
            const container = document.getElementById('playground-view');
            container.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-[#204071]">Playground</h2>
                        <p class="text-sm text-gray-500">Herramientas interactivas de análisis.</p>
                    </div>
                </header>
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex flex-wrap space-x-6" id="playground-tabs">
                        <a href="#" data-tab="pg-tracer-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">¿Nos vemos?</a>
                        <a href="#" data-tab="pg-sslscan-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">SSL Scan</a>
                    </nav>
                </div>
                <div id="pg-tracer-content" class="playground-tab-content">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-lg mb-4 text-[#204071]">Analizador de Conectividad entre recursos</h3>
                        <p class="text-sm text-gray-600 mb-4">Introduce los ARN de las instancias de origen y destino (puedes copiarlos desde la sección de Compute -> EC2) para verificar si existe una ruta de red permitida entre ellas.</p>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="pg-source-arn" class="block text-sm font-medium text-gray-700 mb-1">ARN de Origen</label>
                                <input type="text" id="pg-source-arn" class="bg-gray-50 border border-gray-300 text-[#204071] text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block w-full p-2.5 font-mono" placeholder="arn:aws:ec2:region:account:instance/i-...">
                            </div>
                            <div>
                                <label for="pg-target-arn" class="block text-sm font-medium text-gray-700 mb-1">ARN de Destino</label>
                                <input type="text" id="pg-target-arn" class="bg-gray-50 border border-gray-300 text-[#204071] text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block w-full p-2.5 font-mono" placeholder="arn:aws:ec2:region:account:instance/i-...">
                            </div>
                        </div>
                        <button id="pg-run-analysis-btn" class="bg-[#204071] text-white px-4 py-2.5 rounded-lg font-bold text-md hover:bg-[#1a335a] transition flex items-center justify-center space-x-2">
                            <span id="pg-button-text">Analizar Ruta</span>
                            <div id="pg-loading-spinner" class="spinner hidden"></div>
                        </button>
                    </div>
                    <div id="playground-results-container" class="mt-6"></div>
                </div>
                <div id="pg-sslscan-content" class="playground-tab-content hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-lg mb-4 text-[#204071]">Escáner de Configuración SSL/TLS</h3>
                        <p class="text-sm text-gray-600 mb-4">Introduce uno o más dominios/IPs separados por coma para analizar su configuración.</p>
                        <div>
                            <label for="pg-sslscan-target" class="block text-sm font-medium text-gray-700 mb-1">Dominio(s) o IP(s)</label>
                            <input type="text" id="pg-sslscan-target" class="bg-gray-50 border border-gray-300 text-[#204071] text-sm rounded-lg focus:ring-[#eb3496] focus:border-[#eb3496] block w-full p-2.5 font-mono" placeholder="ej: google.com, github.com, 1.1.1.1">
                        </div>
                        <button id="pg-run-sslscan-btn" class="bg-[#204071] text-white px-4 py-2.5 rounded-lg font-bold text-md hover:bg-[#1a335a] transition flex items-center justify-center space-x-2 mt-4">
                            <span id="pg-sslscan-btn-text">Escanear SSL/TLS</span>
                            <div id="pg-sslscan-spinner" class="spinner hidden"></div>
                        </button>
                    </div>
                    <div id="sslscan-results-container" class="mt-6"></div>
                </div>
            `;

            const tabsNav = document.getElementById('playground-tabs');
            if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.playground-tab-content'));
            const runAnalysisBtn = document.getElementById('pg-run-analysis-btn');
            if (runAnalysisBtn) runAnalysisBtn.addEventListener('click', runPlaygroundAnalysis);
            const runSslScanBtn = document.getElementById('pg-run-sslscan-btn');
            if (runSslScanBtn) runSslScanBtn.addEventListener('click', runSslScan);

            if (playgroundApiData?.results) {
                renderPlaygroundResults();
            }
            if (playgroundApiData?.sslscan) {
                renderSslScanResults(playgroundApiData.sslscan);
            }
        };


        const runPlaygroundAnalysis = async () => {
            log('Iniciando análisis de ruta de red...', 'info');
            const sourceArn = document.getElementById('pg-source-arn').value.trim();
            const targetArn = document.getElementById('pg-target-arn').value.trim();
            const resultsContainer = document.getElementById('playground-results-container');
            resultsContainer.innerHTML = ''; // Limpiar resultados previos

            if (!sourceArn || !targetArn) {
                log('ARN de origen y destino son requeridos.', 'error');
                resultsContainer.innerHTML = '<p class="text-red-600 font-medium">Error: Por favor, introduce ambos ARNs.</p>';
                return;
            }

            const runBtn = document.getElementById('pg-run-analysis-btn');
            const btnText = document.getElementById('pg-button-text');
            const spinner = document.getElementById('pg-loading-spinner');
            
            runBtn.disabled = true;
            spinner.classList.remove('hidden');
            btnText.textContent = 'Analizando...';

            const payload = {
                access_key: accessKeyInput.value.trim(),
                secret_key: secretKeyInput.value.trim(),
                session_token: sessionTokenInput.value.trim() || null,
                source_arn: sourceArn,
                target_arn: targetArn
            };

            try {
                const response = await fetch('http://127.0.0.1:5001/api/run-playground-audit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                playgroundApiData = await response.json();
                
                if (!response.ok) {
                    throw new Error(playgroundApiData.error || 'Error desconocido del servidor.');
                }

                log('Análisis de ruta completado.', 'success');
                renderPlaygroundResults();

            } catch(e) {
                log(`Error en análisis de ruta: ${e.message}`, 'error');
                resultsContainer.innerHTML = `<div class="bg-red-50 text-red-700 p-4 rounded-lg"><h4 class="font-bold">Error</h4><p>${e.message}</p></div>`;
            } finally {
                runBtn.disabled = false;
                spinner.classList.add('hidden');
                btnText.textContent = 'Analizar Ruta';
            }
        };
        const renderPlaygroundResults = () => {
            if (!playgroundApiData) return;
            const container = document.getElementById('playground-results-container');
            const { status, reason, tables, detail_tables } = playgroundApiData.results;

            let resultHtml = '';
            if (status === 'REACHABLE') {
                resultHtml = `
                    <div class="bg-green-50 text-green-800 p-4 rounded-lg">
                        <h4 class="text-lg font-bold flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 mr-2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg>
                            Estado: ALCANZABLE
                        </h4>
                    </div>
                `;
                if(tables && tables.length > 0) {
                    tables.forEach(table => {
                        resultHtml += `<pre class="bg-[#204071] text-white p-4 rounded-lg text-xs font-mono overflow-x-auto mt-4">${table}</pre>`;
                    });
                }
                
                // --- INICIO DE LA MODIFICACIÓN ---
                // Ahora, añadimos las tablas de detalles si existen
                if (detail_tables && Object.keys(detail_tables).length > 0) {
                    resultHtml += '<h3 class="text-xl font-bold text-[#204071] mt-8 mb-4 border-b pb-2">Detalles de los Recursos Involucrados</h3>';
                    for (const resourceId in detail_tables) {
                        resultHtml += `
                            <div class="mt-4">
                                <pre class="bg-gray-800 text-gray-200 p-4 rounded-lg text-xs font-mono overflow-x-auto">${detail_tables[resourceId]}</pre>
                            </div>
                        `;
                    }
                }
                // --- FIN DE LA MODIFICACIÓN ---

            } else { // UNREACHABLE
                resultHtml = `
                    <div class="bg-red-50 text-red-800 p-4 rounded-lg">
                        <h4 class="text-lg font-bold flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-6 h-6 mr-2" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                            Estado: NO ALCANZABLE
                        </h4>
                        <p class="mt-2 font-mono text-sm"><b>Motivo:</b> ${reason}</p>
                    </div>
                `;
            }
            container.innerHTML = resultHtml;
        };

        const renderSslScanResults = (results) => {
            const resultsContainer = document.getElementById('sslscan-results-container');
            if (!results || results.length === 0) {
                resultsContainer.innerHTML = '';
                return;
            }

            let resultsHtml = '';
            results.forEach(result => {
                let resultOutput = '';
                if (result.error) {
                    // Si hay un error explícito del backend, lo mostramos
                    resultOutput = `<div class="bg-red-50 text-red-700 p-4 rounded-lg"><h4 class="font-bold">Error</h4><p>${result.error}</p></div>`;
                } else if (result.output && result.output.trim() !== '') {
                    // Si hay salida, la mostramos en la caja de código
                    resultOutput = `<pre class="bg-gray-900 text-white p-4 rounded-lg text-xs font-mono overflow-x-auto">${result.output}</pre>`;
                } else {
                    // Si no hay error ni salida, mostramos un aviso
                    resultOutput = `<div class="bg-yellow-50 text-yellow-700 p-4 rounded-lg"><h4 class="font-bold">Aviso</h4><p>El escaneo finalizó sin devolver resultados para este objetivo.</p></div>`;
                }
                
                resultsHtml += `
                    <div class="mb-6">
                        <h4 class="font-bold text-lg mb-2 text-[#204071]">Resultado para: ${result.target}</h4>
                        ${resultOutput}
                    </div>
                `;
            });
            resultsContainer.innerHTML = resultsHtml;
        };



        const runSslScan = async () => {
            const targetInput = document.getElementById('pg-sslscan-target');
            const resultsContainer = document.getElementById('sslscan-results-container');
            const runBtn = document.getElementById('pg-run-sslscan-btn');
            const btnText = document.getElementById('pg-sslscan-btn-text');
            const spinner = document.getElementById('pg-sslscan-spinner');
            const target = targetInput.value.trim();
            if (!target) {
                resultsContainer.innerHTML = '<p class="text-red-600 font-medium">Por favor, introduce uno o más dominios/IPs separados por coma.</p>';
                return;
            }
            log(`Iniciando sslscan para: ${target}...`, 'info');
            resultsContainer.innerHTML = '';
            runBtn.disabled = true;
            spinner.classList.remove('hidden');
            btnText.textContent = 'Escaneando...';
            try {
                const response = await fetch('http://127.0.0.1:5001/api/run-sslscan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: target })
                });
                const data = await response.json();
                if (!response.ok && data.error) {
                    throw new Error(data.error);
                }
                if (!playgroundApiData) playgroundApiData = {};
                playgroundApiData.sslscan = data.results;
                renderSslScanResults(data.results);
                log(`sslscan completado para: ${target}.`, 'success');
            } catch (e) {
                log(`Error en sslscan: ${e.message}`, 'error');
                resultsContainer.innerHTML = `<div class="bg-red-50 text-red-700 p-4 rounded-lg"><h4 class="font-bold">Error</h4><p>${e.message}</p></div>`;
            } finally {
                runBtn.disabled = false;
                spinner.classList.add('hidden');
                btnText.textContent = 'Escanear SSL/TLS';
            }
        };

        // --- SECCIÓN DE EXECUTIVE SUMMARY ---

        const buildHealthyStatusView = () => {
            const container = document.getElementById('healthy-status-view');
            if (!container) return;

            // --- ▼▼▼ CÓDIGO AÑADIDO QUE SOLUCIONA EL BUG ▼▼▼ ---
            // Este HTML reconstruye la estructura interna de la vista, incluyendo
            // el div "healthy-status-container" que se había borrado.
            container.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-[#204071]">Healthy Status</h2>
                        <p class="text-sm text-gray-500">Resumen de hallazgos de seguridad encontrados.</p>
                        <div class="mt-4">
                            <label for="healthy-status-region-filter" class="block text-sm font-medium text-gray-700">Filtrar por Región:</label>
                            <select id="healthy-status-region-filter" class="mt-1 block w-full md:w-96 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-[#eb3496] focus:border-[#eb3496] sm:text-sm rounded-md">
                                </select>
                        </div>
                    </div>
                </header>
                <div id="healthy-status-container">
                    <div class="text-center py-16 bg-white rounded-lg">
                        <h3 class="mt-2 text-lg font-medium text-[#204071]">Esperando análisis</h3>
                        <p class="mt-1 text-sm text-gray-500">Los hallazgos de estado aparecerán aquí después de analizar una cuenta.</p>
                    </div>
                </div>
            `;
            // --- ▲▲▲ FIN DE LA CORRECCIÓN ▲▲▲ ---
        };
        

        // --- SECCIÓN DE KMS
        const buildKmsView = () => {
            const container = document.getElementById('kms-view');
            if (!container || !kmsApiData) return;

            const { keys } = kmsApiData.results;
            const executionDate = kmsApiData.metadata.executionDate;

            container.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-[#204071]">Key Management Service (KMS)</h2>
                        <p class="text-sm text-gray-500">${executionDate}</p>
                    </div>
                </header>
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex flex-wrap space-x-6" id="kms-tabs">
                        <a href="#" data-tab="kms-summary-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">Resumen</a>
                        <a href="#" data-tab="kms-keys-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Claves KMS (${keys.length})</a>
                    </nav>
                </div>
                <div id="kms-tab-content-container">
                    <div id="kms-summary-content" class="kms-tab-content">${createKmsSummaryCardsHtml()}</div>
                    <div id="kms-keys-content" class="kms-tab-content hidden">${renderKmsKeysTable(keys)}</div>
                </div>
            `;

            updateKmsSummaryCards(keys);
            
            const tabsNav = container.querySelector('#kms-tabs');
            if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.kms-tab-content'));
        };

        const createKmsSummaryCardsHtml = () => `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm">
                    <div><p class="text-sm text-gray-500">Total Claves KMS</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="kms-total-keys" class="text-3xl font-bold text-[#204071]">--</p>
                        <div class="bg-blue-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lock w-6 h-6 text-blue-600" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 0a4 4 0 0 1 4 4v2.05a2.5 2.5 0 0 1 2 2.45v5a2.5 2.5 0 0 1-2.5 2.5h-7A2.5 2.5 0 0 1 2 13.5v-5a2.5 2.5 0 0 1 2-2.45V4a4 4 0 0 1 4-4M4.5 7A1.5 1.5 0 0 0 3 8.5v5A1.5 1.5 0 0 0 4.5 15h7a1.5 1.5 0 0 0 1.5-1.5v-5A1.5 1.5 0 0 0 11.5 7zM8 1a3 3 0 0 0-3 3v2h6V4a3 3 0 0 0-3-3"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm">
                    <div><p class="text-sm text-gray-500">Gestionadas por Cliente</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="kms-customer-managed" class="text-3xl font-bold text-[#204071]">--</p>
                        <div class="bg-green-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-gear w-6 h-6 text-green-600" viewBox="0 0 16 16">
                                <path d="M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4m.256 7a4.5 4.5 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10q.39 0 .74.025c.226-.341.496-.65.804-.918Q8.844 9.002 8 9c-5 0-6 3-6 4s1 1 1 1zm3.63-4.54c.18-.613 1.048-.613 1.229 0l.043.148a.64.64 0 0 0 .921.382l.136-.074c.561-.306 1.175.308.87.869l-.075.136a.64.64 0 0 0 .382.92l.149.045c.612.18.612 1.048 0 1.229l-.15.043a.64.64 0 0 0-.38.921l.074.136c.305.561-.309 1.175-.87.87l-.136-.075a.64.64 0 0 0-.92.382l-.045.149c-.18.612-1.048.612-1.229 0l-.043-.15a.64.64 0 0 0-.921-.38l-.136.074c-.561.305-1.175-.309-.87-.87l.075-.136a.64.64 0 0 0-.382-.92l-.148-.045c-.613-.18-.613-1.048 0-1.229l.148-.043a.64.64 0 0 0 .382-.921l-.074-.136c-.306-.561.308-1.175.869-.87l.136.075a.64.64 0 0 0 .92-.382zM14 12.5a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm">
                    <div><p class="text-sm text-gray-500">Gestionadas por AWS</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="kms-aws-managed" class="text-3xl font-bold text-[#204071]">--</p>
                        <div class="bg-yellow-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-amazon w-6 h-6 text-yellow-600" viewBox="0 0 16 16">
                                <path d="M10.813 11.968c.157.083.36.074.5-.05l.005.005a90 90 0 0 1 1.623-1.405c.173-.143.143-.372.006-.563l-.125-.17c-.345-.465-.673-.906-.673-1.791v-3.3l.001-.335c.008-1.265.014-2.421-.933-3.305C10.404.274 9.06 0 8.03 0 6.017 0 3.77.75 3.296 3.24c-.047.264.143.404.316.443l2.054.22c.19-.009.33-.196.366-.387.176-.857.896-1.271 1.703-1.271.435 0 .929.16 1.188.55.264.39.26.91.257 1.376v.432q-.3.033-.621.065c-1.113.114-2.397.246-3.36.67C3.873 5.91 2.94 7.08 2.94 8.798c0 2.2 1.387 3.298 3.168 3.298 1.506 0 2.328-.354 3.489-1.54l.167.246c.274.405.456.675 1.047 1.166ZM6.03 8.431C6.03 6.627 7.647 6.3 9.177 6.3v.57c.001.776.002 1.434-.396 2.133-.336.595-.87.961-1.465.961-.812 0-1.286-.619-1.286-1.533M.435 12.174c2.629 1.603 6.698 4.084 13.183.997.28-.116.475.078.199.431C13.538 13.96 11.312 16 7.57 16 3.832 16 .968 13.446.094 12.386c-.24-.275.036-.4.199-.299z"/>
                                <path d="M13.828 11.943c.567-.07 1.468-.027 1.645.204.135.176-.004.966-.233 1.533-.23.563-.572.961-.762 1.115s-.333.094-.23-.137c.105-.23.684-1.663.455-1.963-.213-.278-1.177-.177-1.625-.13l-.09.009q-.142.013-.233.024c-.193.021-.245.027-.274-.032-.074-.209.779-.556 1.347-.623"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm">
                    <div><p class="text-sm text-gray-500">Rotación Desactivada (CMK)</p></div>
                    <div class="flex justify-between items-end pt-4">
                        <p id="kms-rotation-disabled" class="text-3xl font-bold text-red-600">--</p>
                        <div class="bg-red-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise w-6 h-6 text-red-600" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const updateKmsSummaryCards = (keys) => {
            document.getElementById('kms-total-keys').textContent = keys.length;
            document.getElementById('kms-customer-managed').textContent = keys.filter(k => k.KeyManager === 'CUSTOMER').length;
            document.getElementById('kms-aws-managed').textContent = keys.filter(k => k.KeyManager === 'AWS').length;
            document.getElementById('kms-rotation-disabled').textContent = keys.filter(k => k.RotationEnabled === 'Desactivada').length;
        };

        const renderKmsKeysTable = (keys) => {
            if (!keys || keys.length === 0) {
                return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron claves KMS.</p></div>';
            }

            let tableHtml = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Alias</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Key ID</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rotación</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Propietario</th>' +
                            '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Origen</th>' +
                            '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            
            keys.sort((a,b) => a.Region.localeCompare(b.Region) || a.Aliases.localeCompare(b.Aliases)).forEach(k => {
                const rotationBadge = k.RotationEnabled === 'Activada' ? createStatusBadge('Habilitado') : (k.RotationEnabled === 'Desactivada' ? createStatusBadge('Deshabilitado') : k.RotationEnabled);
                
                tableHtml += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${k.Region}</td>
                        <td class="px-4 py-4 align-top text-sm font-medium text-gray-800 break-words">${k.Aliases}</td>
                        <td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600 font-mono">${k.KeyId}</td>
                        <td class="px-4 py-4 align-top whitespace-nowrap text-sm">${createStatusBadge(k.Status)}</td>
                        <td class="px-4 py-4 align-top whitespace-nowrap text-sm">${rotationBadge}</td>
                        <td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${k.KeyManager}</td>
                        <td class="px-4 py-4 align-top whitespace-nowrap text-sm text-gray-600">${k.Origin}</td>
                    </tr>
                    <tr class="bg-gray-50">
                        <td colspan="7" class="p-0">
                            <details>
                                <summary class="px-4 py-1 text-xs text-gray-500 cursor-pointer">Ver política de la clave</summary>
                                <div class="p-4">
                                    <pre class="bg-[#204071] text-white text-xs rounded-md p-3 overflow-x-auto"><code>${JSON.stringify(k.Policy, null, 2)}</code></pre>
                                </div>
                            </details>
                        </td>
                    </tr>
                `;
            });
            tableHtml += '</tbody></table></div>';
            return tableHtml;
        };


        // --- RENDERIZADO GENÉRICO DE SECURITY HUB ---
        const renderSecurityHubFindings = (findings, containerId, emptyMessage) => { const container = document.getElementById(containerId); if (!container) return; if (!findings || findings.length === 0) { container.innerHTML = `<p class="text-center text-gray-500 py-4">${emptyMessage}</p>`; return; } const severityClasses = { 'CRITICAL': 'bg-red-600 text-white', 'HIGH': 'bg-orange-500 text-white', 'MEDIUM': 'bg-yellow-400 text-black', 'LOW': 'bg-blue-500 text-white', 'INFORMATIONAL': 'bg-gray-400 text-white' }; let tableHtml = '<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Severidad</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Región</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Título</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tipo de Recurso</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">'; findings.forEach(f => { const severity = f.Severity?.Label || 'N/A'; const severityClass = severityClasses[severity] || 'bg-gray-200 text-gray-800'; const region = f.Region || 'N/A'; const title = f.Title || 'Sin título'; const resourceType = f.Resources?.[0]?.Type || 'N/A'; tableHtml += `<tr class="hover:bg-gray-50"><td class="px-4 py-2 whitespace-nowrap"><span class="px-2.5 py-0.5 text-xs font-semibold rounded-full ${severityClass}">${severity}</span></td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${region}</td><td class="px-4 py-2 text-sm text-gray-800 break-words">${title}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${resourceType}</td></tr>`; }); tableHtml += '</tbody></table>'; container.innerHTML = tableHtml; };
    
     // --- SECCIÓN DE DATABASES ---

        const buildDatabasesView = () => {
            const container = document.getElementById('databases-view');
            if (!container || !databasesApiData) return;

        const { rds_instances = [], aurora_clusters = [], dynamodb_tables = [], documentdb_clusters = [] } = databasesApiData.results || {};
            container.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-[#204071]">Databases</h2>
                        <p class="text-sm text-gray-500">${databasesApiData.metadata.executionDate}</p>
                    </div>
                </header>
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex flex-wrap space-x-6" id="databases-tabs">
                        <a href="#" data-tab="db-summary-content" class="tab-link py-3 px-1 border-b-2 border-[#eb3496] text-[#eb3496] font-semibold text-sm">Resumen</a>
                        <a href="#" data-tab="db-rds-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">RDS Instances (${rds_instances.length})</a>
                        <a href="#" data-tab="db-aurora-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Aurora Clusters (${aurora_clusters.length})</a>
                        <a href="#" data-tab="db-dynamodb-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">DynamoDB Tables (${dynamodb_tables.length})</a>
                        <a href="#" data-tab="db-docdb-content" class="tab-link py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">DocumentDB (${documentdb_clusters.length})</a>

                    </nav>
                </div>
                <div id="databases-tab-content-container">
                    <div id="db-summary-content" class="databases-tab-content">${createDatabasesSummaryCardsHtml()}</div>
                    <div id="db-rds-content" class="databases-tab-content hidden">${renderRdsTable(rds_instances)}</div>
                    <div id="db-aurora-content" class="databases-tab-content hidden">${renderAuroraTable(aurora_clusters)}</div>
                    <div id="db-dynamodb-content" class="databases-tab-content hidden">${renderDynamoDbTable(dynamodb_tables)}</div>
                    <div id="db-docdb-content" class="databases-tab-content hidden">${renderDocumentDbTable(documentdb_clusters)}</div>

                </div>
            `;
            
            updateDatabasesSummaryCards(rds_instances, aurora_clusters, dynamodb_tables, documentdb_clusters);
            
            const tabsNav = container.querySelector('#databases-tabs');
            if (tabsNav) tabsNav.addEventListener('click', handleTabClick(tabsNav, '.databases-tab-content'));
        };

        const createDatabasesSummaryCardsHtml = () => `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-8">
                        <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm">
                            <div><p class="text-sm text-gray-500">Instancias RDS (Standalone)</p></div>
                            <div class="flex justify-between items-end pt-4">
                                <p id="db-total-rds" class="text-3xl font-bold text-[#204071]">--</p>
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-database w-6 h-6 text-blue-600" viewBox="0 0 16 16">
                                        <path d="M4.318 2.687C5.234 2.271 6.536 2 8 2s2.766.27 3.682.687C12.644 3.125 13 3.627 13 4c0 .374-.356.875-1.318 1.313C10.766 5.729 9.464 6 8 6s-2.766-.27-3.682-.687C3.356 4.875 3 4.373 3 4c0-.374.356-.875 1.318-1.313M13 5.698V7c0 .374-.356.875-1.318 1.313C10.766 8.729 9.464 9 8 9s-2.766-.27-3.682-.687C3.356 7.875 3 7.373 3 7V5.698c.271.202.58.378.904.525C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777A5 5 0 0 0 13 5.698M14 4c0-1.007-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1s-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4v9c0 1.007.875 1.755 1.904 2.223C4.978 15.71 6.427 16 8 16s3.022-.289 4.096-.777C13.125 14.755 14 14.007 14 13zm-1 4.698V10c0 .374-.356.875-1.318 1.313C10.766 11.729 9.464 12 8 12s-2.766-.27-3.682-.687C3.356 10.875 3 10.373 3 10V8.698c.271.202.58.378.904.525C4.978 9.71 6.427 10 8 10s3.022-.289 4.096-.777A5 5 0 0 0 13 8.698m0 3V13c0 .374-.356.875-1.318 1.313C10.766 14.729 9.464 15 8 15s-2.766-.27-3.682-.687C3.356 13.875 3 13.373 3 13v-1.302c.271.202.58.378.904.525C4.978 12.71 6.427 13 8 13s3.022-.289 4.096-.777c.324-.147.633-.323.904-.525"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm">
                            <div><p class="text-sm text-gray-500">Clústeres Aurora</p></div>
                            <div class="flex justify-between items-end pt-4">
                                <p id="db-total-aurora" class="text-3xl font-bold text-[#204071]">--</p>
                                <div class="bg-green-100 p-3 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-database w-6 h-6 text-green-600" viewBox="0 0 16 16">
                                        <path d="M4.318 2.687C5.234 2.271 6.536 2 8 2s2.766.27 3.682.687C12.644 3.125 13 3.627 13 4c0 .374-.356.875-1.318 1.313C10.766 5.729 9.464 6 8 6s-2.766-.27-3.682-.687C3.356 4.875 3 4.373 3 4c0-.374.356-.875 1.318-1.313M13 5.698V7c0 .374-.356.875-1.318 1.313C10.766 8.729 9.464 9 8 9s-2.766-.27-3.682-.687C3.356 7.875 3 7.373 3 7V5.698c.271.202.58.378.904.525C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777A5 5 0 0 0 13 5.698M14 4c0-1.007-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1s-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4v9c0 1.007.875 1.755 1.904 2.223C4.978 15.71 6.427 16 8 16s3.022-.289 4.096-.777C13.125 14.755 14 14.007 14 13zm-1 4.698V10c0 .374-.356.875-1.318 1.313C10.766 11.729 9.464 12 8 12s-2.766-.27-3.682-.687C3.356 10.875 3 10.373 3 10V8.698c.271.202.58.378.904.525C4.978 9.71 6.427 10 8 10s3.022-.289 4.096-.777A5 5 0 0 0 13 8.698m0 3V13c0 .374-.356.875-1.318 1.313C10.766 14.729 9.464 15 8 15s-2.766-.27-3.682-.687C3.356 13.875 3 13.373 3 13v-1.302c.271.202.58.378.904.525C4.978 12.71 6.427 13 8 13s3.022-.289 4.096-.777c.324-.147.633-.323.904-.525"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm">
                            <div><p class="text-sm text-gray-500">Tablas DynamoDB</p></div>
                            <div class="flex justify-between items-end pt-4">
                                <p id="db-total-dynamodb" class="text-3xl font-bold text-[#204071]">--</p>
                                <div class="bg-purple-100 p-3 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-database w-6 h-6 text-purple-600" viewBox="0 0 16 16">
                                        <path d="M4.318 2.687C5.234 2.271 6.536 2 8 2s2.766.27 3.682.687C12.644 3.125 13 3.627 13 4c0 .374-.356.875-1.318 1.313C10.766 5.729 9.464 6 8 6s-2.766-.27-3.682-.687C3.356 4.875 3 4.373 3 4c0-.374.356-.875 1.318-1.313M13 5.698V7c0 .374-.356.875-1.318 1.313C10.766 8.729 9.464 9 8 9s-2.766-.27-3.682-.687C3.356 7.875 3 7.373 3 7V5.698c.271.202.58.378.904.525C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777A5 5 0 0 0 13 5.698M14 4c0-1.007-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1s-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4v9c0 1.007.875 1.755 1.904 2.223C4.978 15.71 6.427 16 8 16s3.022-.289 4.096-.777C13.125 14.755 14 14.007 14 13zm-1 4.698V10c0 .374-.356.875-1.318 1.313C10.766 11.729 9.464 12 8 12s-2.766-.27-3.682-.687C3.356 10.875 3 10.373 3 10V8.698c.271.202.58.378.904.525C4.978 9.71 6.427 10 8 10s3.022-.289 4.096-.777A5 5 0 0 0 13 8.698m0 3V13c0 .374-.356.875-1.318 1.313C10.766 14.729 9.464 15 8 15s-2.766-.27-3.682-.687C3.356 13.875 3 13.373 3 13v-1.302c.271.202.58.378.904.525C4.978 12.71 6.427 13 8 13s3.022-.289 4.096-.777c.324-.147.633-.323.904-.525"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-100 p-5 rounded-xl shadow-sm">
                            <div><p class="text-sm text-gray-500">Clústeres DocumentDB</p></div>
                            <div class="flex justify-between items-end pt-4">
                                <p id="db-total-docdb" class="text-3xl font-bold text-[#204071]">--</p>
                                <div class="bg-teal-100 p-3 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-code w-6 h-6 text-teal-600" viewBox="0 0 16 16">
                                        <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5z"/>
                                        <path d="M8.646 6.646a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1 0 .708l-2 2a.5.5 0 0 1-.708-.708L10.293 8 8.646 6.354a.5.5 0 0 1 0-.708m-1.292 0a.5.5 0 0 0-.708 0l-2 2a.5.5 0 0 0 0 .708l2 2a.5.5 0 0 0 .708-.708L5.707 8l1.647-1.646a.5.5 0 0 0 0-.708"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                `;




        const updateDatabasesSummaryCards = (rds, aurora, dynamodb, docdb) => {
            document.getElementById('db-total-rds').textContent = rds.length;
            document.getElementById('db-total-aurora').textContent = aurora.length;
            document.getElementById('db-total-dynamodb').textContent = dynamodb.length;
            document.getElementById('db-total-docdb').textContent = docdb.length;
        };



        const formatBytes = (bytes, decimals = 2) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        const renderRdsTable = (instances) => {
            if (!instances || instances.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron instancias RDS standalone.</p></div>';
            
            let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Identificador</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Clase</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Motor</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acceso Público</th>' + // <-- NUEVA CABECERA
                        '<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ARN</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            
            instances.forEach(i => {
                // Lógica para crear la insignia de acceso público
                const publicBadge = i.PubliclyAccessible 
                    ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Sí</span>`
                    : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">No</span>`;

                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${i.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${i.DBInstanceIdentifier}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${i.DBInstanceClass}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${i.Engine}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${createStatusBadge(i.DBInstanceStatus)}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${publicBadge}</td> 
                            <td class="px-4 py-4 text-center">
                                <button onclick="copyToClipboard(this, '${i.ARN}')" title="${i.ARN}" class="p-1 rounded-md hover:bg-gray-200 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard w-5 h-5 text-gray-500" viewBox="0 0 16 16">
                                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
                                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>`;
            });
            table += '</tbody></table></div>';
            return table;
        };

        const renderAuroraTable = (clusters) => {
            if (!clusters || clusters.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron clústeres Aurora.</p></div>';
            
            let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Identificador</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Motor</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Endpoint</th>' +
                        '<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ARN</th>' + // <-- NUEVA CABECERA
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            
            clusters.forEach(c => {
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${c.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${c.ClusterIdentifier}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${c.Engine}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${createStatusBadge(c.Status)}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 break-all">${c.Endpoint}</td>
                            <td class="px-4 py-4 text-center">
                                <button onclick="copyToClipboard(this, '${c.ARN}')" title="${c.ARN}" class="p-1 rounded-md hover:bg-gray-200 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard w-5 h-5 text-gray-500" viewBox="0 0 16 16">
                                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
                                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>`;
            });
            table += '</tbody></table></div>';
            return table;
        };

        const renderDynamoDbTable = (tables) => {
            if (!tables || tables.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron tablas DynamoDB.</p></div>';
            
            let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre de Tabla</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nº Items</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tamaño</th>' +
                        '<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ARN</th>' + // <-- NUEVA CABECERA
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            
            tables.forEach(t => {
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${t.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${t.TableName}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${createStatusBadge(t.Status)}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${t.ItemCount.toLocaleString()}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${formatBytes(t.SizeBytes)}</td>
                            <td class="px-4 py-4 text-center">
                                <button onclick="copyToClipboard(this, '${t.ARN}')" title="${t.ARN}" class="p-1 rounded-md hover:bg-gray-200 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard w-5 h-5 text-gray-500" viewBox="0 0 16 16">
                                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
                                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>`;
            });
            table += '</tbody></table></div>';
            return table;
        };

        const renderDocumentDbTable = (clusters) => {
            if (!clusters || clusters.length === 0) return '<div class="bg-white p-6 rounded-xl border border-gray-100"><p class="text-center text-gray-500">No se encontraron clústeres DocumentDB.</p></div>';
            
            let table = '<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Región</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Identificador</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Motor</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>' +
                        '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Endpoint</th>' +
                        '<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ARN</th>' +
                        '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            
            clusters.forEach(c => {
                table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${c.Region}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${c.ClusterIdentifier}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${c.Engine}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm">${createStatusBadge(c.Status)}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 break-all">${c.Endpoint}</td>
                            <td class="px-4 py-4 text-center">
                                <button onclick="copyToClipboard(this, '${c.ARN}')" title="${c.ARN}" class="p-1 rounded-md hover:bg-gray-200 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard w-5 h-5 text-gray-500" viewBox="0 0 16 16">
                                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
                                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>`;
            });
            table += '</tbody></table></div>';
            return table;
        };


// --- LÓGICA DE EXPORTACIÓN ---
        const exportResultsToJson = () => {
            if (!iamApiData) {
                alert("Aviso: Primero debes realizar un análisis antes de poder exportar los resultados.");
                return;
            }

            let scanType = "rapido";
            if (configSHApiData || (inspectorApiData && inspectorApiData.results.findings && inspectorApiData.results.findings.length > 0)) {
                scanType = "profundo";
            }
            
            const accountId = iamApiData.metadata.accountId;
            const accountAlias = federationApiData?.results?.iam_federation?.account_alias || "NoAlias";
            const timestamp = iamApiData.metadata.executionDate;

            // --- CAMBIO CLAVE AQUÍ ---
            // Nos aseguramos de exportar solo el contenido de '.results' para cada servicio.
            const exportData = {
                metadata: {
                    accountId: accountId,
                    accountAlias: accountAlias,
                    analysisTimestamp: timestamp,
                    analysisType: scanType,
                    exportTimestamp: new Date().toISOString()
                },
                results: {
                    iam: iamApiData?.results || null,
                    federation: federationApiData?.results || null,
                    securityhub: securityHubApiData?.results || null,
                    exposure: exposureApiData?.results || null,
                    guardduty: guarddutyApiData?.results || null,
                    waf: wafApiData?.results || null,
                    cloudtrail: cloudtrailApiData?.results || null,
                    cloudwatch: cloudwatchApiData?.results || null,
                    inspector: inspectorApiData?.results || null,
                    acm: acmApiData?.results || null,
                    compute: computeApiData?.results || null,
                    databases: databasesApiData?.results || null,
                    networkPolicies: networkPoliciesApiData?.results || null,
                    configAndSecurityHubStatus: configSHStatusApiData?.results || null,
                    configAndSecurityHubDeepScan: configSHApiData?.results || null,
                    kms: kmsApiData?.results || null, 
                    playground: playgroundApiData?.results || null,
                    connectivity: connectivityApiData?.results || null
                }
            };
            
            const filename = `${accountId}_${accountAlias}_${scanType}.json`;
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log(`Resultados exportados correctamente en el fichero: ${filename}`, 'success');
        };

// --- LÓGICA DE IMPORTACIÓN ---

        const handleJsonImport = (event) => {
            const file = event.target.files[0];
            if (!file) {
                log('No se seleccionó ningún fichero.', 'info');
                return;
            }

            log(`Cargando fichero: ${file.name}...`, 'info');
            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (!importedData.metadata || !importedData.results) {
                        throw new Error("El fichero JSON no tiene la estructura esperada (metadata/results).");
                    }

                    log(`Fichero JSON parseado correctamente. Cuenta: ${importedData.metadata.accountId}`, 'info');

                    const results = importedData.results;
                    
                    // --- CAMBIO CLAVE AQUÍ ---
                    // Ahora asignamos directamente el objeto del servicio, ya que no tiene la capa extra de 'metadata' y 'results'.
                    // Creamos un objeto metadata genérico para mantener la consistencia interna.
                    const metadata = { accountId: importedData.metadata.accountId, executionDate: importedData.metadata.analysisTimestamp };

                    iamApiData = results.iam ? { metadata: metadata, results: results.iam } : null;
                    federationApiData = results.federation ? { metadata: metadata, results: results.federation } : null;
                    securityHubApiData = results.securityhub ? { metadata: metadata, results: results.securityhub } : null;
                    exposureApiData = results.exposure ? { metadata: metadata, results: results.exposure } : null;
                    guarddutyApiData = results.guardduty ? { metadata: metadata, results: results.guardduty } : null;
                    wafApiData = results.waf ? { metadata: metadata, results: results.waf } : null;
                    cloudtrailApiData = results.cloudtrail ? { metadata: metadata, results: results.cloudtrail } : null;
                    cloudwatchApiData = results.cloudwatch ? { metadata: metadata, results: results.cloudwatch } : null;
                    inspectorApiData = results.inspector ? { metadata: metadata, results: results.inspector } : null;
                    acmApiData = results.acm ? { metadata: metadata, results: results.acm } : null;
                    computeApiData = results.compute ? { metadata: metadata, results: results.compute } : null;
                    databasesApiData = results.databases ? { metadata: metadata, results: results.databases } : null;
                    networkPoliciesApiData = results.networkPolicies ? { metadata: metadata, results: results.networkPolicies } : null;
                    configSHStatusApiData = results.configAndSecurityHubStatus ? { metadata: metadata, results: results.configAndSecurityHubStatus } : null;
                    configSHApiData = results.configAndSecurityHubDeepScan ? { metadata: metadata, results: results.configAndSecurityHubDeepScan } : null;
                    kmsApiData = results.kms ? { metadata: metadata, results: results.kms } : null;
                    playgroundApiData = results.playground ? { metadata: metadata, results: results.playground } : null;
                    connectivityApiData = results.connectivity ? { metadata: metadata, results: results.connectivity } : null;
                    
                    allAvailableRegions = networkPoliciesApiData?.results?.all_regions || [];

                    log('Datos importados en el estado de la aplicación.', 'success');
                    
                    buildAndRenderAllViews();
                    runAndDisplayHealthyStatus();

                } catch (error) {
                    log(`Error al importar el fichero JSON: ${error.message}`, 'error');
                    console.error(error);
                    errorMessageDiv.textContent = 'Error: El fichero seleccionado no es un JSON válido o tiene un formato incorrecto.';
                    errorMessageDiv.classList.remove('hidden');
                }
            };

            reader.onerror = () => {
                log('Error al leer el fichero.', 'error');
                errorMessageDiv.textContent = 'Error: No se pudo leer el fichero seleccionado.';
                errorMessageDiv.classList.remove('hidden');
            };

            reader.readAsText(file);
            event.target.value = '';
        };




        const displayHealthyStatus = (selectedRegion) => {
            const container = document.getElementById('healthy-status-container');
            if (!container) return;
            container.innerHTML = '';

            const filteredFindings = lastHealthyStatusFindings.map(finding => {
                if (selectedRegion !== 'all') {
                    const affectedInRegion = finding.affected_resources.filter(res => res.region === selectedRegion || res.region === 'Global');
                    if (affectedInRegion.length > 0) {
                        return { ...finding, affected_resources: affectedInRegion };
                    }
                    return null;
                }
                return finding;
            }).filter(Boolean);

            if (filteredFindings.length === 0) {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-center text-green-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-patch-check-fill mr-3" viewBox="0 0 16 16"><path d="M10.067.87a2.89 2.89 0 0 0-4.134 0l-.622.638-.89-.011a2.89 2.89 0 0 0-2.924 2.924l.01.89-.636.622a2.89 2.89 0 0 0 0 4.134l.637.622-.011.89a2.89 2.89 0 0 0 2.924 2.924l.89-.01.622.636a2.89 2.89 0 0 0 4.134 0l.622-.637.89.01a2.89 2.89 0 0 0 2.924-2.924l-.01-.89.636-.622a2.89 2.89 0 0 0 0-4.134l-.637-.622.011-.89a2.89 2.89 0 0 0-2.924-2.924l-.89.01zm.287 5.984-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7 8.793l2.646-2.647a.5.5 0 0 1 .708.708"/></svg>
                            <p class="text-center font-semibold text-lg">¡Felicidades! No se encontraron hallazgos para la región seleccionada.</p>
                        </div>
                    </div>`;
                return;
            }

            const severityOrder = { 'Crítico': 1, 'Alto': 2, 'Medio': 3, 'Bajo': 4 };
            filteredFindings.sort((a, b) => (severityOrder[a.severity] || 99) - (severityOrder[b.severity] || 99));

            filteredFindings.forEach(finding => {
                let borderColor = 'border-gray-500';
                if (finding.severity === 'Crítico') borderColor = 'border-red-600';
                if (finding.severity === 'Alto') borderColor = 'border-red-500';
                if (finding.severity === 'Medio') borderColor = 'border-yellow-500';
                if (finding.severity === 'Bajo') borderColor = 'border-blue-500';

                const affectedResourcesHtml = Array.isArray(finding.affected_resources) 
                    ? finding.affected_resources.map(res => `<li>${res.display}</li>`).join('')
                    : '<li>Error al procesar los recursos afectados.</li>';
                
                const resourcesCount = Array.isArray(finding.affected_resources) ? finding.affected_resources.length : 0;

                const card = `
                    <div class="bg-white p-4 rounded-xl mb-4 border-l-4 ${borderColor} shadow-sm">
                        <h3 class="text-xl font-bold text-[#204071]">${finding.name} <span class="text-sm font-normal text-gray-500">(${finding.severity})</span></h3>
                        <p class="text-gray-600 mt-2 text-sm">${finding.description}</p>
                        <div class="mt-4">
                            <details class="group">
                                <summary class="font-semibold text-gray-800 text-sm cursor-pointer list-none flex items-center">
                                    <svg class="w-4 h-4 mr-2 group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                    Recursos Afectados (${resourcesCount}):
                                </summary>
                                <ul class="list-disc list-inside text-sm text-gray-700 bg-gray-50 p-2 rounded-md mt-2 font-mono ml-6">
                                    ${affectedResourcesHtml}
                                </ul>
                            </details>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-semibold text-gray-800 text-sm">Solución Recomendada:</h4>
                            <p class="text-gray-600 text-sm">${finding.remediation}</p>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        };

        const runAndDisplayHealthyStatus = async () => {
            log('Ejecutando motor de reglas para el Healthy Status...', 'info');
            try {
                const fullAuditData = {
                    iam: iamApiData?.results,
                    guardduty: guarddutyApiData?.results,
                    config_sh: configSHStatusApiData?.results,
                    exposure: exposureApiData?.results,
                    inspector: inspectorApiData?.results,
                    compute: computeApiData?.results,
                    networkPolicies: networkPoliciesApiData?.results,
                };

                // --- LOG AÑADIDO ---
                // Mostramos en la consola del navegador el objeto que vamos a enviar.
                console.log('Enviando estos datos al motor de reglas:', fullAuditData);

                const summaryResponse = await fetch('http://127.0.0.1:5001/run_executive_summary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(fullAuditData)
                });

                const summaryFindings = await summaryResponse.json();
                if (!summaryResponse.ok) {
                    throw new Error(summaryFindings.error || 'Error al generar el resumen de estado.');
                }

                lastHealthyStatusFindings = summaryFindings;
                log(`Análisis de reglas completado. Encontrados ${summaryFindings.length} hallazgos.`, 'success');
                
                populateHealthyStatusFilter();
                displayHealthyStatus('all');

            } catch (error) {
                log(`Error al generar el Healthy Status: ${error.message}`, 'error');
                const summaryContainer = document.getElementById('healthy-status-container');
                if (summaryContainer) {
                    summaryContainer.innerHTML = `<div class="text-center py-16 text-red-600">${error.message}</div>`;
                }
            }
        };

        const populateHealthyStatusFilter = () => {
            const filterSelect = document.getElementById('healthy-status-region-filter');
            if (!filterSelect || !allAvailableRegions) return;

            // Limpiamos opciones anteriores (excepto la de "Todas")
            filterSelect.innerHTML = '<option value="all">Todas las Regiones</option>';

            allAvailableRegions.sort().forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                filterSelect.appendChild(option);
            });

            // Añadimos el listener para que se ejecute al cambiar de opción
            filterSelect.addEventListener('change', (e) => {
                displayHealthyStatus(e.target.value);
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Selectores del DOM (todos juntos)
            views = document.querySelectorAll('.view');
            mainNavLinks = document.querySelectorAll('.main-nav-link');
            runAnalysisBtn = document.getElementById('run-analysis-button');
            accessKeyInput = document.getElementById('access-key-input');
            secretKeyInput = document.getElementById('secret-key-input');
            sessionTokenInput = document.getElementById('session-token-input');
            loadingSpinner = document.getElementById('loading-spinner');
            buttonText = document.getElementById('button-text');
            errorMessageDiv = document.getElementById('error-message');
            logContainer = document.getElementById('log-container');
            clearLogBtn = document.getElementById('clear-log-btn');
            toggleLogBtn = document.getElementById('toggle-log-btn');
            logPanel = document.getElementById('log-panel');
            const importButton = document.getElementById('import-results-button');
            const fileInput = document.getElementById('json-file-input');

            // Estado inicial de la vista
            document.getElementById('iam-view').innerHTML = createInitialEmptyState();

            // Asignación de Eventos (todos juntos)
            runAnalysisBtn.addEventListener('click', runAnalysisFromInputs);
            document.getElementById('sidebar-nav').addEventListener('click', handleMainNavClick);
            clearLogBtn.addEventListener('click', () => { logContainer.innerHTML = ''; });
            toggleLogBtn.addEventListener('click', () => {
                logPanel.classList.toggle('minimized');
                toggleLogBtn.textContent = logPanel.classList.contains('minimized') ? 'Maximizar' : 'Minimizar';
            });
            document.getElementById('export-results-button').addEventListener('click', exportResultsToJson);
            importButton.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleJsonImport);
        });


    </script>
</body>
</html>